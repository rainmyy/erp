<?php
//
class fkclass extends kclass{
	var $tbline=0;
	//
	function purviews($p){
		if(($this->user['groupid']!=1 AND $this->user['groupid']!=3) OR $this->user['killed']>0)$this->messager(array('title' => '无效请求','text' => '您的请求是无效的（无权限访问此内容）。<span class="tiny">ID: 1</span>','url' => '/s.php?module=sign&action=out','sec' => 60));
		if($p['module']=='')$p['module']=$this->input['module'];
		if($p['action']=='')$p['action']=$this->input['action'];
		if($this->user['inherit'] == 1)$purview = $this->user['purviews'];
		else $purview = $this->user['purview'];

		if($purview == ''){
			$m = false;
		}else{
			$m = $this->DB->queryFirst("
				SELECT m.moduleid
				FROM `module` AS m
				WHERE m.moduleid IN (".$purview.") AND m.`module`='".$p['module']."' AND INSTR(m.`action`,'".(strtolower($p['action']))."')>0
			");
		}
		if($m){
			return true;
		}else{
			if($p['final'] == 1){
				return false;
			}else{
				$this->messager(array('title' => '无效请求','text' => '您的请求是无效的（无权限访问此内容）。<span class="tiny">ID: 2</span>','url' => (REFERER == '' OR strstr(REFERER, 'module=sign&action=complete'))?'/s.php':'javascript:history.back()','sec' => 60));
			}
		}
	}
	//
	function menu(){
		$ms = $this->DB->query("
			SELECT m1.menuid, m1.parentid, m1.moduleid, m1.title, m1.icon, m1.`module`, m1.`action`, m1.`addition`,
				m2.title AS parent
			FROM `menu` AS m1
			LEFT JOIN `menu` AS m2 ON (m2.menuid = m1.parentid)
			WHERE m1.killed=0 AND m1.`moduleid` IN (".$this->iif($this->user['inherit']==1,$this->user['purviews'],$this->user['purview']).")
			ORDER BY m2.ordering ASC , m1.ordering ASC
		");
		if($this->DB->numRows()){
			$pid = -1;
			$u = '<ul id="menu" class="menu">';
			while($m = $this->DB->fetchArray($ms)){
				if($pid != $m['parentid']){
					if($pid>0)$u .= '</ul></li><li></li>';//if has sub add ul/li tail
					$u .= '<li>'.$this->iif($m['parentid']==0, $m['title'].'</li><li></li>', $this->iif($m['parent']=='个人', ucfirst($this->user['username']),$m['parent']).'<ul>');
					$pid = $m['parentid'];
				}
				if($m['parentid'] > 0){
					$u .= '<li>';
					if($m['icon']!='')$u='<img src="/public/menu/'.$m['icon'].'" width="16" height="16" />';// if icon is true
					if($m['module'] != ''){//if url is true
						$u .= '<a href="/s.php?module='.$m['module'];
						if($m['action'] != '')$u.='&action='.$m['action'];
						if($m['addition']!='')$u.='&'.$m['addition'];
						$u.='">';
					}
					$u .= $m['title'];
					if($m['module'] != '')$u.='</a>';
					$u .= '</li>';
				}
			}
			if($pid > 0)$u .= '</ul></li>';
			$u .= '<li></li><li class="disabled">'.date("H:i", TIMENOW).'</li></ul>';
		}
		return $u;
	}
	//
	function uploadList($u){
		if($u['module'] != '' AND $u['mid'] > 0){
			$condition = " OR (`module`='".$u['module']."' AND `mid`='".$u['mid']."')";
		}
		$as = $this->DB->query("
			SELECT *
			FROM `attachs`
			WHERE (`module`='' AND `mid`=0 AND creator='".$this->user['userid']."')".$condition."
			ORDER BY `mid` DESC, ordering ASC, modified DESC, created DESC
		");
		if($this->DB->numRows()){
			$fileList='<table width="100%"><thead><tr><th>原始文件名</th><th>大小</th><th>上传日期</th><th>标题</th><th>排序</th><th>归属</th><th class="small"><span class="hand" onclick="dc.upload.selectAll(0);" title="设置所有未决的附件为：保留状态">全留</span> | <span class="hand" onclick="dc.upload.selectAll(2);" title="设置所有未决的附件为：删除状态">全删</span> | <span class="hand" onclick="dc.upload.selectAll(1);" title="设置所有未决的附件为：选择状态">全选</span></th></tr></thead><tbody>';
			while($a = $this->DB->fetchArray($as)){
				$fileList.='<tr class="'.($this->rotate()?'odd':'even');
				$c0=$c1=$tick='';
				if($this->input['t']==$a['tmpid'] OR ($a['module']==$u['module'] AND $a['mid']==$u['mid'])){
					if($a['module']==$u['module'] AND $a['mid']==$u['mid']){
						$tick = '<span class="big bold green" title="原有附件">√</span> ';
					}else{
						$fileList.=' gray';
					}
					$c1=' checked';
				}else{
					$c0=' checked';
					$tick = '';
					$fileList.=' gray';
				}
				if($a['image']==1){
					$img = unserialize($a['imginfo']);
					$thumb = '<img src="/public/attachs/'.$img['thumb'].'" height="20" onmouseover="dc.upload.showThumb(this, \''.$img['thumb'].'\')" onmouseout="dc.upload.hiddenThumb()" /> ';
				}else{
					$thumb = '';
				}
				$fileList.='"><td class="middle">'.$thumb.$a['orgName'].'</td><td class="tiny" align="right">'.$this->sizeFormat($a['size']).'</td><td class="tiny gray">'.date('y-m-d H:i:s', $a['created']).'</td><td class="small"><input type="hidden" name="attachOrgTitle['.$a['attachid'].']" value="'.$a['title'].'"><input type="text" name="attachTitle['.$a['attachid'].']" value="'.$a['title'].'" size="30"></td><td class="small"><input type="hidden" name="attachOrgOrdering['.$a['attachid'].']" value="'.$a['ordering'].'"><input type="text" name="attachOrdering['.$a['attachid'].']" value="'.$a['ordering'].'" size="1" style="width:20px"></td><td align="center">'.$tick.'</td><td class="small"><label for="attach['.$a['attachid'].']0" class="gray"><input type="radio" id="attach['.$a['attachid'].']0" name="attach['.$a['attachid'].']" value="0"'.$c0.'>留</label> <label for="attach['.$a['attachid'].']2" class="red"><input type="radio" id="attach['.$a['attachid'].']2" name="attach['.$a['attachid'].']" value="2">删</label> <label for="attach['.$a['attachid'].']1" class="green"><input type="radio" id="attach['.$a['attachid'].']1" name="attach['.$a['attachid'].']" value="1"'.$c1.'>选</label></td></tr>';
			}
			$fileList.='</tbody></table>';
		}else{
			$fileList='还没有未归属的已上传文件。';
		}
		return $fileList;
	}
	//
	function upload($u){
		$t = TIMENOW;
		$this->page['header'] = '<script src="/public/swfupload.js"></script>';
		$this->page['onload'].='dc.upload.init(\''.$this->sess->session['id'].'\', \''.$t.'\');';
		if($u['title']=='')$u['title']='附件管理：';

		$fileList = $this->uploadList(array('module'=>$u['module'], 'mid'=>$u['mid']));
		$this->tbline+=2;
return <<<EOF
	<table class="hundred">
	<thead>
	<tr>
		<th colspan="4">{$u['title']}<input type="hidden" id="uploadModule" name="uploadModule" value="{$u['module']}"><input type="hidden" id="uploadMid" name="uploadMid" value="{$u['mid']}"><input type="hidden" id="timenow" name="t" value="{$t}"></th>
	</tr>
	</thead>
	<tbody>
	<tr class="odd">
		<td align="center" style="border-right:0"><input id="showUploaded" type="button" value="已传附件" title="选择已上传未归属的附件" onclick="dc.upload.showUploaded();" /></td>
		<td align="center" style="border-right:0"><input id="cancelUpload" type="button" value="全部取消" onclick="dc.upload.cancelQueue();" disabled="disabled" /></td>
		<td align="center" style="border-right:0"><input id="startUpload" type="button" value="上传文件" onclick="dc.upload.handle.startUpload();" disabled="disabled" /></td>
		<td align="center"><span id="selectFile"></span></td>
	</tr>
	<tr nohover>
		<td colspan="4"><div id="fileQueue"></div><div id="fileList">{$fileList}</div></td>
	</tr>
	<tr class="even">
		<td colspan="4" class="gray small">上传说明：<ul><li>每次只能上传20个文件；队列累计上限为20，如需要超过这个，保存后，再次进入修改页面继续上传；</li><li>允许的文件类型：jpg, jpeg, png, gif, rar, zip, pdf, doc, docx, xls,xlsx, pps, ppt, txt, mht, htm, html, ai, dwg；</li><li>每个文件大小不能超过10MB；图片文件系统会自动生成缩略图，建议图片首选jpg或jpeg格式；</li><li>“已传附件”是指 一个月内已上传的单还未设定归属的附件；超过1个月未归属的附件系统自动删除。</li></ul></td>
	</tr>
	</tbody>
	</table>
EOF;
	}
	//
	function updateAttachs($a){
		if(count($this->input['attach']) > 0){
			$fileCount = 0;
			foreach($this->input['attach'] as $k => $v){
				if($v == 0 OR $v==1){//0:保留，需要检查title与ordering是否更改。1:选择
					$cdt = '';
					if($this->input['attachTitle'][$k] != $this->input['attachOrgTitle'][$k])$cdt = "`title`='".$this->input['attachTitle'][$k]."', ";
					if($this->input['attachOrdering'][$k] != $this->input['attachOrgOrdering'][$k])$cdt .= "`ordering`='".$this->input['attachOrdering'][$k]."', ";
					if($v == 1)$cdt.= "`module`='".$a['module']."', `mid`='".$a['mid']."', ";
					if($cdt != ''){
						$this->DB->query("UPDATE `attachs` SET ".$cdt."`modifier`='".$this->user['userid']."', `modified`='".TIMENOW."' WHERE `attachid`='".$k."'");
					}
					$fileCount++;
				}elseif($v==2){//删除
					$attach = $this->DB->queryFirst("SELECT `folder`, `newName`, `image`, `imginfo` FROM `attachs` WHERE `attachid`='".$k."'");
					if($attach['image'] == 1){
						$img = unserialize($attach['imginfo']);
						@unlink('public/attachs/'.$img['thumb']);
						@unlink('public/attachs/'.$img['senior']);
						@unlink('public/attachs/'.$img['big']);
					}
					@unlink('public/attachs/'.$attach['folder'].'/'.$attach['newName']);
					$this->DB->query("DELETE FROM `attachs` WHERE `attachid`='".$k."'");
				}
			}
			if($fileCount > 0){
				$tmp = '';
				if($attach = $this->DB->queryFirst("SELECT COUNT(attachid) AS n, imginfo FROM `attachs` WHERE `module`='".$a['module']."' AND `mid`='".$a['mid']."' AND `image`=1 ORDER BY ordering ASC")){
					$tmp = ", `images`='".$attach['n']."'";
					if($attach['imginfo']!=''){
						$img=unserialize($attach['imginfo']);
						$tmp .= ", `cover`='/public/attachs/".$img['thumb']."'";
					}
				}
				$this->DB->query("UPDATE `".$a['module']."` SET attachs='".$fileCount."'".$tmp." WHERE `".$a['module']."id`='".$a['mid']."'");
			}
			return true;
		}else{
			return false;
		}
	}
	//
	function getAttachs($g){
		if($g['module']=='' OR !$g['mid']>0)return false;
		$attachs = $this->DB->query("
			SELECT *
			FROM `attachs`
			WHERE `module`='".$g['module']."' AND `mid`='".$g['mid']."'
			ORDER BY `ordering` ASC, `modified` DESC, `created` DESC
		");
		if($this->DB->numRows()){
			$r = '';
			while($attach = $this->DB->fetchArray($attachs)){
				$r .= '<div class="attach">';
				if($attach['image'] == 1){
					$img = unserialize($attach['imginfo']);
					$r .= '<a href="/public/attachs/'.$img['name'].'" target="_blank"><img src="/public/attachs/'.$img['thumb'].'" width="128" height="128"/></a> ';
				}else{
					$r .= '<span class="middle"><a href="/public/attachs/'.$attach['folder'].'/'.$attach['newName'].'" target="_blank" title="从新窗口打开或下载">'.$attach['orgName'].'</a></span><div class="small gray">'.strtoupper($attach['type']).', '.$this->sizeFormat($attach['size']).'</div>';
				}
				$r .= '</div>';
			}
			return $r;
		}else{
			return false;
		}
	}
	//
	function orderby($s){
		if($s['module']=='' OR !is_array($s['serial'])){
			return;
		}
		if($this->input['direction']==''){
			$this->input['direction']=$s['direction'];
		}
		if($this->input['direction']=='asc'){
			$s['direction']='asc';
			$direction='desc';
		}else{
			$s['direction']='desc';
			$direction='asc';
		}

		if($this->input['orderby']!=''){
			$s['orderby']=$this->input['orderby'];
		}elseif($s['default']!=''){
			$s['orderby']=$s['default'];
		}else{
			$s['orderby']='modified';
		}
		if(is_array($s['appendUrl'])){
			foreach($s['appendUrl'] as $k => $v){
				if($k!='' AND $k!='orderby' AND $k!='direction'){
					$a.='&'.$k.'='.$v;
				}
			}
		}
		foreach($s['serial'] as $k => $v){
			if($v['word']==''){
				$v['word']=$v['field'];
			}
			$r['link'].='<a href="/s.php?module='.$this->iif($s['amodule']!='',$s['amodule'],$s['module']).$a.'&orderby='.$v['word'];
			if($s['orderby']==$v['word'] OR $s['orderby']==$v['field']){
				$r['link'].='&direction='.$direction.'"><span class="bold">'.$v['title'].'<span class="'.$s['direction'].'"> </span>';
				if($s['module']=='psupplier'){
					$r['sql']='`supplier`.'.$v['field'].' '.strtoupper($s['direction']);
				}else{
					$r['sql']='`'.$s['module'].'`.'.$v['field'].' '.strtoupper($s['direction']);
				}
			}else{
				$r['link'].='">'.$v['title'].'';
			}
			$r['link'].='</a>　';
		}
		return $r;
	}
	//
	function id($i){
		if($i['customer']>0){
			$id = 'C'.sprintf("%04d", $i['customer']);
		}
		if($i['supplier']>0){
			$id = sprintf("%04d", $i['supplier']);
		}
		if($i['sample']>0){
			$id = 'S'.$i['sample'];
		}
		if($i['product']>0){
			$id = 'P'.$i['product'];
		}
		if($i['order']>0){
			$id = 'NW'.$i['order'];
		}
		if($i['invoice']>0){
			$id = 'NW'.$i['invoice'];
		}
		if($i['porder']>0){
			$id = 'PO'.date('ymd',$i['porder']).str_pad($i['number']+1,2,'0',STR_PAD_LEFT);
		}
		if($i['pinvoice']>0){
			$id = 'NW'.date('ymd',$i['pinvoice']).str_pad($i['number']+1,2,'0',STR_PAD_LEFT);
		}
		if($i['inbound']>0){
			$id=$i['no'].date('ym',$i['inbound']).str_pad($i['number']+1,4,'0',STR_PAD_LEFT);
		}
		if($i['outbound']>0){
			$id=$i['no'].date('ym',$i['outbound']).str_pad($i['number']+1,4,'0',STR_PAD_LEFT);
		}
		if($i['entrust']>0){
			$id='OM'.date('ymd',$i['entrust']).str_pad($i['number']+1,2,'0',STR_PAD_LEFT);
		}
		if($i['batch']>0){
			/*$sd=explode('-',date('y-n-j',$i['batch']));
			foreach($sd as $key => $val){
				$time36.=strtoupper(base_convert($val,10,36));
			}
			$id=$i['materialno'].'-'.$time36;*/
			$id=$i['materialno'].'-'.date('ymd',$i['batch']);
		}
		if($i['purchaseApply']>0){
			$id='PA'.date('ymd',$i['purchaseApply']).str_pad($i['number']+1,2,'0',STR_PAD_LEFT);
		}
		if($i['purchase']>0){
			$id='PM'.date('ymd',$i['purchase']).str_pad($i['number']+1,2,'0',STR_PAD_LEFT);
		}
		return $id;
	}
	//
	function verify($b){
		if($b==0){
			$r='待审核';
		}elseif($b==-1){
			$r='审核未通过';
		}elseif($b==1){
			$r='审核通过';
		}
		return $r;
	}
	//
	function approve($b){
		if($b==0){
			$r='待审批';
		}elseif($b==-1){
			$r='审批未通过';
		}elseif($b==1){
			$r='审批通过';
		}
		return $r;
	}
		//
	function confirm($b){
		if($b==0){
			$r='待确认';
		}elseif($b==1){
			$r='已确认';
		}
		return $r;
	}
	// 数字金额转换成中文大写金额
	function numberToCNAccount($b){
		$b=floatval(str_replace(',','',$b));
		$cnNumber=array('零','壹','贰','叁','肆','伍','陆','柒','捌','玖');
		$cnMiniUnits=array('圆','角','分');
		$cnUnits=array('拾','佰','仟','万','拾','佰','仟','亿');
		list($b1,$b2)=explode('.',$b,2);
		$b2=array_filter(array($b2[1],$b2[0]));
		$ret=array_merge($b2,array(implode('',$this->mapUnit(str_split($b1),$cnUnits)),''));
		$ret=implode('',array_reverse($this->mapUnit($ret,$cnMiniUnits)));
		$r=str_replace(array_keys($cnNumber),$cnNumber,$ret);
		return $r.'整';
	}
	//给中文金额数字加上单位
	function mapUnit($list,$units){
		$unitCount=count($units);
		$arr=array();
		foreach(array_reverse($list) as $value){
			$count=count($arr);
			$n=$this->iif($value!='0' OR !($count%4),$this->iif($value=='0','',$value).($units[($count-1)%$unitCount]),$this->iif(is_numeric($arr[0][0]),$value,''));
			array_unshift($arr,$n);
		}
		return $arr;
	}
	//
	function mmlist(){

	}
	/*
	*		the bom chlid list
	*		@param array(parentid,quantity,depth)
	*		return array
	*/
	function bomChildList($b){
		$quantity=$this->iif($b['quantity'],$b['quantity'],1);
		$id=array();
		$material=array();
		$boms=$this->DB->query("
			SELECT `bom`.*, 
			`material`.materialid,`material`.title AS material,`material`.materialno,`material`.standard,`material`.qualified,`material`.min
			FROM `bom` 
			LEFT JOIN `material` ON (`material`.materialid=`bom`.childid)
			WHERE `bom`.killed=0 AND `bom`.parentid='".$b['parentid']."' AND `material`.originid=0
			ORDER BY ordering ASC, bomid ASC
		");
		if($this->DB->numRows()){
			$b['depth'].= "　";
			while($bom=$this->DB->fetchArray($boms)){
				$unit=$this->DB->queryFirst("SELECT title FROM `unit` WHERE killed=0 AND unitid='".$bom['unitid']."'");//单位
				$quantity=$bom['quantity']*$quantity;//毛需求数量
				$grossQuantity=$bom['quantity']*$netQuantity;//毛需求数量
				$netQuantity=$grossQuantity-$bom['qualified']+$bom['min'];
				//获得mrp物资列表
				if(in_array($bom['materialid'],$id)){
					$rs[$bom['materialid']]['total']+=$netQuantity;
					$rs[$bom['materialid']]['addQuantity']+=$bom['qualified']-$bom['min'];
				}else{
					$rs[$bom['materialid']]['materialno']='<a href="/s.php?module=material&action=view&materialid='.$bom['materialid'].'">'.$bom['materialno'].'</a>';
					$rs[$bom['materialid']]['title']=$bom['title'];
					$rs[$bom['materialid']]['standard']=$bom['standard'];
					$rs[$bom['materialid']]['total']=$netQuantity;
					$rs[$bom['materialid']]['materialid']=$bom['materialid'];
					$id[]=$bom['materialid'];
				}
				//获得bom列表
				$r[$bom['bomid']]=array('materialid'=>$bom['materialid'],'title'=>$bom['title'],'materialno'=>$bom['materialno'],'standard'=>$bom['standard'],'qualified'=>$bom['qualified'],'min'=>$bom['min'],'material'=>$b['depth'].$bom['materialno'].'　'.$bom['material'].'　'.$bom['standard'],'quantity'=>$quantity,'unit'=>$unit['title'],'attritionRate'=>$bom['attritionRate']);
				$child=$this->DB->queryFirst("SELECT COUNT(*) AS count FROM `bom` WHERE killed=0 AND parentid='".$bom['materialid']."' ORDER BY created ASC");
				if($child['count']>0){
					$d=$this->bomChildList(array('parentid'=>$bom['materialid'],'quantity'=>$quantity,'netQuantity'=>$netQuantity,'depth'=>$b['depth']));
					if(is_array($d)){
						$r+=$d['bom'];
						$rs+=$d['mrp'];
					}
				}
			}
		}
		return array('bom'=>$r,'mrp'=>$rs);
	}
	/*
	*		the bom parent list
	*		@param array(parentid,quantity,depth)
	*		return array
	*/
	function bomParentList($b){
		$quantity=$this->iif($b['quantity'],$b['quantity'],1);
		$id=array();
		$material=array();
		$boms=$this->DB->query("
			SELECT `bom`.*, 
			`material`.materialid,`material`.title AS material,`material`.materialno,`material`.standard,`material`.qualified,`material`.min
			FROM `bom` 
			LEFT JOIN `material` ON (`material`.materialid=`bom`.parentid)
			WHERE `bom`.killed=0 AND `bom`.childid='".$b['childid']."'
			ORDER BY ordering ASC, bomid ASC
		");
		if($this->DB->numRows()){
			while($bom=$this->DB->fetchArray($boms)){
				$quantity=$quantity/$bom['quantity'];
				$unit=$this->DB->queryFirst("SELECT title FROM `unit` WHERE killed=0 AND unitid='".$bom['unitid']."'");//单位
				//获得bom列表
				$r[$bom['bomid']]=array('materialid'=>$bom['materialid'],'title'=>$bom['title'],'materialno'=>$bom['materialno'],'standard'=>$bom['standard'],'qualified'=>$bom['qualified'],'min'=>$bom['min'],'material'=>$bom['materialno'].'　'.$bom['material'].'　'.$bom['standard'],'quantity'=>$quantity,'unit'=>$unit['title'],'attritionRate'=>$bom['attritionRate']);
				$child=$this->DB->queryFirst("SELECT COUNT(*) AS count FROM `bom` WHERE killed=0 AND childid='".$bom['parentid']."' ORDER BY created ASC");
				if($child['count']>0){
					$d=$this->bomChildList(array('parentid'=>$bom['parentid'],'quantity'=>$quantity));
					if(is_array($d)){
						$r+=$d['bom'];
					}
				}
			}
		}
		return $r;
	}
	/*
	*		the mrp
	*		@param array(parentid,quantity)
	*		return array
	*/
	function mrpList($pid){
		//计划的物资
		$items=$this->DB->query("
			SELECT pi.*,
				mft.manufactureno,mft.typeid,
				t.title AS type,
				m.materialno,m.title,m.standard,m.qualified,m.min
			FROM planitem AS pi
			LEFT JOIN manufacture AS mft ON (mft.manufactureid=pi.manufactureid)
			LEFT JOIN mfttype AS t ON (t.typeid=mft.typeid)
			LEFT JOIN material AS m ON (m.materialid=pi.materialid)
			WHERE pi.killed=0 AND pi.planid='".$pid."'
			ORDER BY pi.ordering ASC
		");
		if($this->DB->numRows()){
			$i=1;
			$r=$t=$material=array();
			while($item=$this->DB->fetchArray($items)){
				$r=$this->bomChildList(array('parentid'=>$item['materialid'],'quantity'=>$item['quantity']));
				if($r){
					$t=array_merge($t,$r['mrp']);
					$material+=array('materialid'=>$item['materialid'],'qualified'=>$item['qualified'],'min'=>$item['min']);
					$i++;
				}
			}
		}
		
		if($r){
			$id=array();
			foreach($t as $key => $val){
				if(in_array($val['materialid'],$id)){
					$material=$this->DB->queryFirst("SELECT qualified,min FROM material WHERE materialid='".$val['materialid']."'");
					$total[$val['materialid']]+=$val['total'];
					$addQuantity[$val['materialid']]+=$material['qualified']-$material['min'];
				}else{
					$total[$val['materialid']]=$val['total'];
					$id[]=$val['materialid'];
				}
			}
			$arr=array();
			foreach($id as $k => $v){
				$netQuantity=$total[$v]+$addQuantity[$v];
				$arr[$v]=array('materialid'=>$v,'netQuantity'=>$netQuantity);
			}
			return $arr;
		}else{
		return false;
		}
	}
	
	/**
	 * 选择客户区域
	 * @param array $arr
	 * @return string $str
	 */
	function chooserArea(array $arr){
		if(!isset($arr['orderby'])){
			$arr['orderby'] = 'areaid';
		}
		if(!isset($arr['direction'])){
			$arr['direction'] = 'ASC';
		}
		if($arr['width'] > 0){
			$arr['width'] = ' style="width: '.$arr['width'].'px;"';
		}
		if(isset($arr['condition'])){
			$arr['condition'] = ' AND '.$arr['condition'];
		}
		$trackers = $this->DB->query("
			SELECT *
			FROM area
			WHERE killed=0 ".$arr['condition']."
			ORDER BY ".$arr['orderby']." ".$arr['direction']."
		");
		$str = '<select id="'.$arr['name'].'" name="'.$arr['name'].'"'.$arr['width'].'>';
		if($this->DB->numRows()){
			if($arr['hasBlank']){
				$str .= '<option value="0">'.$arr['topname'].'</option>';
			}
			while($tracker = $this->DB->fetchArray($trackers)){
				if($arr['selectedid'] == $tracker['areaid']){
					$str .= '<option value="'.$tracker['areaid'].'" selected>'.$tracker['title'].$tracker['entitle'].'</option>';
				}else{
					$str .= '<option value="'.$tracker['areaid'].'">'.$tracker['title'].$tracker['entitle'].'</option>';
				}
			}
		}
		$str .= '</select>';
		return $str;
	}
	/**
	 * 生成跟单人员选择框列表
	 * @param array $arr 生成选择框参数列表
	 * @return string $str 返回跟单人员选择框字符串
	 */
	function chooserTracker(array $arr){
		if(!isset($arr['orderby'])){
			$arr['orderby'] = 'userid';
		}
		if(!isset($arr['direction'])){
			$arr['direction'] = 'ASC';
		}
		if($arr['width'] > 0){
			$arr['width'] = ' style="width: '.$arr['width'].'px;"';
		}
		if(isset($arr['condition'])){
			$arr['condition'] = ' AND '.$arr['condition'];
		}
		$trackers = $this->DB->query("
			SELECT *
			FROM member
			WHERE killed=0 ".$arr['condition']."
			ORDER BY ".$arr['orderby']." ".$arr['direction']."
		");
		$str = '<select id="'.$arr['name'].'" name="'.$arr['name'].'"'.$arr['width'].'>';
		if($this->DB->numRows()){
			if($arr['hasBlank']){
				$str .= '<option value="0">'.$arr['topname'].'</option>';
			}
			while($tracker = $this->DB->fetchArray($trackers)){
				if($arr['selectedid'] == $tracker['userid']){
					$str .= '<option value="'.$tracker['userid'].'" selected>'.$tracker['username'].'</option>';
				}else{
					$str .= '<option value="'.$tracker['userid'].'">'.$tracker['username'].'</option>';
				}
			}
		}
		$str .= '</select>';
		return $str;
	}
	
	//
	function chooserProduct($b){
		if($b['orderby'] == ''){
			$b['orderby'] = '`product`.productno';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$colArr = array(1=>'成品',2=>'半成品',3=>'配件',4=>'试做样');
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].' onchange="dc.chooseAttribute(this.value,\'td'.$b['selectName'].'\')">';
		if($b['hasBlank']){
			$r .= '<option value="0">'.$b['topname'].'</option>';
		}
		for($i=1;$i<5;$i++){
			$products = $this->DB->query("
				SELECT productid, productno, title
				FROM product
				WHERE killed=0".$b['condition']."
				AND attrid=".$i."
				ORDER BY ".$b['orderby']." ".$b['direction']."
			");
			if($this->DB->numRows()){
				$r .= '<optgroup label="'.$colArr[$i].'">';
				while($product = $this->DB->fetchArray($products)){
					if($b['selectedid'] == $product['productid']){
						$r .= '<option value="'.$product['productid'].'" selected>'.$product['productno'].' '.$product['title'].'</option>';
					}else{
						$r .= '<option value="'.$product['productid'].'">'.$product['productno'].' '.$product['title'].'</option>';
					}
				}
				$r .= '</optgroup>';
			}
			
		}
		$r .= '</select>';
		return $r;
	}

	//
	function chooserAttr($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		$attrs = $this->DB->query("
			SELECT *
			FROM attr
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		if($this->DB->numRows()){
			while($attr = $this->DB->fetchArray($attrs)){
				$r .= '<label for="abbr'.$attr['attrid'].'" title="'.$attr['remark'].'"><input type="radio" id="abbr'.$attr['attrid'].'" name="'.$b['name'].'" value="'.$attr['attrid'].'"'.$this->iif($b['selectedid'] == $attr['attrid'],' checked', '').'>'.$attr['title'].'</label>';
			}
		}

		return $r;
	}
	//
	function chooserBankDetail($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}
		if($b['customerid']>0){
			$condition=' customerid='.$b['customerid'];
		}
		if($b['supplierid']>0){
			$condition=' supplierid='.$b['supplierid'];
		}
		$bankDetails=$this->DB->query("
			SELECT *
			FROM bankdetail
			WHERE killed=0 AND ".$condition."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($bankDetail=$this->DB->fetchArray($bankDetails)){
				$r.='<option value="'.$bankDetail['bankDetailid'].'"';
				if($b['selectedid']==$bankDetail['bankDetailid']){
					$r.=' selected';
				}
				$r.='>'.$bankDetail['bank'].'（'.$bankDetail['bankAccountName'].':'.$bankDetail['bankAccount'] .'）</option>';
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserBrand($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$brands = $this->DB->query("
			SELECT *
			FROM brand
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($brand = $this->DB->fetchArray($brands)){
				if($b['selectedid'] == $brand['brandid']){
					$r .= '<option value="'.$brand['brandid'].'" selected>'.$brand['title'].'</option>';
				}else{
					$r .= '<option value="'.$brand['brandid'].'">'.$brand['title'].'</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}
	//
	function chooserBatch($b){
		if($b['orderby']==''){
			$b['orderby']='arrivalTime';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		$batchs=$this->DB->query("
			SELECT b.*,
				mv.title AS version 
			FROM batch AS b
			LEFT JOIN materialversion AS mv ON (mv.versionid=b.versionid)
			WHERE b.killed=0 AND b.materialid='".$b['materialid']."'
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.= '<option value="0">'.$b['topname'].'</option>';
			}
			while($batch=$this->DB->fetchArray($batchs)){
				$r.='<option value="'.$batch['batchid'].'"';
				if($b['selectedid']==$batch['batchid']){
					$r.=' selected';
				}
				$r.= '>'.$batch['batchno'].' ( 版本:'.$batch['version'].'　当前数量为：'.$batch['quantity'].' )</option>';
			}
		}
		$r.= '</select>';

		return $r;
	}
	//
	function chooserBarcode($b){
		if($b['orderby']==''){
			$b['orderby']='arrivalTime';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		if($b['condition']==''){
			$b['condition']=' 1=1';
		}
		if($b['ifPerBarcode']==1){
			$b['status']=' 1=1';
		}else{
			if($b['status']==''){
				$b['status']=' 1=1';
			}
		}
		if($b['parentid']==''){
			$b['parentid']=0;
		}
		$barcodes=$this->DB->query("
			SELECT *
			FROM barcode
			WHERE parentid='".$b['parentid']."' AND ".$b['status']." AND ".$b['condition']."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($b['hasBlank']){
			$r.= '<option value="0">'.$b['topname'].'</option>';
		}
		if($this->DB->numRows()){
			while($barcode=$this->DB->fetchArray($barcodes)){
				$barcode['arrivalTime']=date('Y-m-d',$barcode['arrivalTime']);
				$r.= '<option value="'.$barcode['barcodeid'].'" ';
				if($b['selectedid']==$barcode['barcodeid']){
					$r.='selected';
				}
				$r.='>'.$barcode['barcode'].' （批次时间：'.$barcode['arrivalTime'].'）</option>';
				if($b['ifPerBarcode']==1){
					$perBarcodes=$this->DB->query("
						SELECT *
						FROM barcode
						WHERE parentid='".$barcode['barcodeid']."' AND statusid=2 
						ORDER BY ".$b['orderby']." ".$b['direction']."
					");
					if($this->DB->numRows()){
						while($perBarcode=$this->DB->fetchArray($perBarcodes)){
							$r.='<option value="'.$barcode['barcodeid'].'">　　'.$perBarcode['barcode'].'</option>';
						}
					}
				}
			}
		}
		$r.= '</select>';

		return $r;
	}
	//
	function chooserBusinesstype($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$businesstypes = $this->DB->query("
			SELECT *
			FROM businesstype
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($businesstype = $this->DB->fetchArray($businesstypes)){
				if($b['selectedid'] == $businesstype['businesstypeid']){
					$r .= '<option value="'.$businesstype['businesstypeid'].'" selected>'.$businesstype['title'].' ('.$businesstype['entitle'].')</option>';
				}else{
					$r .= '<option value="'.$businesstype['businesstypeid'].'">'.$businesstype['title'].' ('.$businesstype['entitle'].')</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}
	//
	function chooserCategory($c){
		if($c['categoryid']>0){
			$condition = "categoryid='".$c['categoryid']."'";
			$category = $this->DB->queryFirst("
				SELECT categoryid, title, entitle, display
				FROM `category`
				WHERE $condition
				ORDER BY ordering ASC
			");
			if($category){
				if($c['showall'] == 1){
					$r .= '<option'.$this->iif($category['display']==0, ' style="color: gray;"', '').' value="'.$category['categoryid'].'"'.$this->iif($c['selectedid']==$c['categoryid'], ' selected', '').'>'.$c['depth'] . $category['title'].$this->iif($category['entitle']!='', ' ('.$category['entitle'].')', '').'</option>';
				}else{
					if($category['display'] == 1){
						$r .= '<option'.$this->iif($category['display']==0, ' style="color: gray;"', '').' value="'.$category['categoryid'].'"'.$this->iif($c['selectedid']==$c['categoryid'], ' selected', '').'>'.$c['depth'].$category['title'].$this->iif($category['entitle']!='', ' ('.$category['entitle'].')', '').'</option>';
					}
				}
			}
			$c['depth'] .= "　　";
		}else{
			$r .= '<select id="'.$c['name'].'" name="'.$c['name'].'"'.$this->iif($c['width'] > 0, ' style="width:'.$c['width'].'px;"', '').$this->iif($c['size'] > 0, ' size="'.$c['size'].'"', '').'>';
			if($c['hasBlank'])$r .= '<option value="-1"'.$this->iif($c['selectedid']==$c['categoryid'], ' selected', '').'>'.$c['topname'].'</option>';
			$c['categoryid'] = -1;
		}
		if($c['parentid']>0){
			$c['categoryid'] = $c['parentid'];
		}
		$pcondition = "parentid = '".$c['categoryid']."'";
		$categorys=$this->DB->query("
			SELECT categoryid
			FROM `category`
			WHERE $pcondition
			ORDER BY ordering ASC
			");
		if($this->DB->numRows()){
			while ($category = $this->DB->fetchArray($categorys)){
				$r.=$this->chooserCategory(array(
					'selectedid' => $c['selectedid'],
					'categoryid' => $category['categoryid'],
					'depth' => $c['depth'],
					'showall' => $c['showall'],
				));
			}
		}
		if($c['categoryid'] == 0){
			$r .= '</select>';
		}

		return $r;
	}
	//
	function chooserCountry($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'encountry';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$countrys = $this->DB->query("
			SELECT *
			FROM region
			WHERE killed=0 AND countryid=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($country = $this->DB->fetchArray($countrys)){
				$f = strtoupper(substr($country['encountry'], 0, 1));
				if($b['selectedid'] == $country['regionid']){
					$r .= '<option value="'.$country['regionid'].'" selected>'.$f.' ' . $country['country'] . $this->iif($b['cn'] == 1, '', '('.$country['encountry'].')') . '</option>';
				}else{
					$r .= '<option value="'.$country['regionid'].'"'.$this->iif($country['regionid']==$b['regionid'], ' selected', '').'>'.$f.' '.$country['country'].$this->iif($b['cn'] == 1, '', '('.$country['encountry'].')') . '</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}

	//
	function chooserCurrency($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'currencyid';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$currencys = $this->DB->query("
			SELECT *
			FROM currency
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($currency = $this->DB->fetchArray($currencys)){
				if($b['selectedid'] == $currency['currencyid']){
					$r .= '<option value="'.$currency['currencyid'].'" selected>'.$currency['title'].'('.$currency['symbol'].')</option>';
				}else{
					$r .= '<option value="'.$currency['currencyid'].'">'.$currency['title'].'('.$currency['symbol'].')</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}

	//
	function chooserCustomer($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'title';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}
		
		if(isset($b['onchange'])){
			$b['onchange'] = 'onchange="dc.returnCountryAndCustomerStr(this.value,\''.$b['onchange'].'\')"';
		}

		$customers = $this->DB->query("
			SELECT *
			FROM customer
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].' '.$b['onchange'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($customer = $this->DB->fetchArray($customers)){
				$title=$this->iif($b['lan']=='cn',$customer['cntitle'],$customer['title']);
				if($b['selectedid'] == $customer['customerid']){
					$r .= '<option value="'.$customer['customerid'].'" selected>'.$title.'</option>';
				}else{
					$r .= '<option value="'.$customer['customerid'].'">'.$title.'</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}

	//
	function chooserDeliveryterm($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$deliverys = $this->DB->query("
			SELECT *
			FROM deliveryterm
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($delivery = $this->DB->fetchArray($deliverys)){
				$r .= '<option value="'.$delivery['deliverytermid'].'"'.$this->iif($b['selectedid'] == $delivery['deliverytermid'], ' selected', '').'>'.$delivery['title'].' ('.$delivery['entitle'].')</option>';
			}
		}
		$r .= '</select>';

		return $r;
	}
	/*
	*		choose department
	*		@param array(orderby,direction,width,name,topname,hasBlank,selectedid)
	*		return html-select
	*/
	function chooserDepartment($c){
		if($c['departmentid']>0){
			$condition = "departmentid='".$c['departmentid']."'";
			$department = $this->DB->queryFirst("
				SELECT *
				FROM department
				WHERE $condition
				ORDER BY ordering ASC 
			");
			if($department){
				if($c['showall'] == 1){
					$r .= '<option'.$this->iif($department['display']==0, ' style="color: gray;"', '').' value="'.$department['departmentid'].'"'.$this->iif($c['selectedid']==$c['departmentid'], ' selected', '').'>'.$c['depth'] . $department['title'].$this->iif($department['entitle']!='', ' ('.$department['entitle'].')', '').'</option>';
				}else{
					if($department['display'] == 1){
						$r .= '<option'.$this->iif($department['display']==0, ' style="color: gray;"', '').' value="'.$department['departmentid'].'"'.$this->iif($c['selectedid']==$c['departmentid'], ' selected', '').'>'.$c['depth'].$department['title'].$this->iif($department['entitle']!='', ' ('.$department['entitle'].')', '').'</option>';
					}
				}
			}
			$c['depth'] .= "　　";
		}else{
			$r .= '<select id="'.$c['name'].'" name="'.$c['name'].'"'.$this->iif($c['width'] > 0, ' style="width:'.$c['width'].'px;"', '').$this->iif($c['size'] > 0, ' size="'.$c['size'].'"', '').'>';
			if($c['hasBlank'])$r .= '<option value="-1"'.$this->iif($c['selectedid']==$c['departmentid'], ' selected', '').'>'.$c['topname'].'</option>';
			$c['departmentid'] = -1;
		}
		if($c['parentid']>0){
			$c['departmentid'] = $c['parentid'];
		}
		$pcondition = "parentid = '".$c['departmentid']."'";
		$departments=$this->DB->query("
			SELECT departmentid
			FROM department
			WHERE $pcondition
			ORDER BY ordering ASC 
		");
		if($this->DB->numRows()){
			while ($department = $this->DB->fetchArray($departments)){
				$r .= $this->chooserDepartment(array(
					'selectedid' => $c['selectedid'],
					'departmentid' => $department['departmentid'],
					'depth' => $c['depth'],
					'showall' => $c['showall'],
				));
			}
		}
		if($c['departmentid'] == 0){
			$r .= '</select>';
		}

		return $r;
	}
	// chooser entity type. like material, stock. For attribute
	function chooserEntityType($c){
		if($c['typeid']>0){
			$condition="typeid='".$c['typeid']."'";
			$type=$this->DB->queryFirst("
				SELECT typeid, title, entitle, display
				FROM `entitytype`
				WHERE $condition
				ORDER BY ordering ASC
			");
			if($type){
				if($c['showall'] == 1){
					$r .= '<option'.$this->iif($type['display']==0, ' style="color: gray;"', '').' value="'.$type['typeid'].'"'.$this->iif($c['selectedid']==$c['typeid'], ' selected', '').'>'.$c['depth'] . $type['title'].$this->iif($type['entitle']!='', ' ('.$type['entitle'].')', '').'</option>';
				}else{
					if($type['display'] == 1){
						$r .= '<option'.$this->iif($type['display']==0, ' style="color: gray;"', '').' value="'.$type['typeid'].'"'.$this->iif($c['selectedid']==$c['typeid'], ' selected', '').'>'.$c['depth'].$type['title'].$this->iif($type['entitle']!='', ' ('.$type['entitle'].')', '').'</option>';
					}
				}
			}
			$c['depth'] .= "　　";
		}else{
			$r .= '<select id="'.$c['name'].'" name="'.$c['name'].'"'.$this->iif($c['width'] > 0, ' style="width:'.$c['width'].'px;"', '').$this->iif($c['size'] > 0, ' size="'.$c['size'].'"', '').'>';
			if($c['hasBlank'])$r .= '<option value="0"'.$this->iif($c['selectedid']==$c['typeid'], ' selected', '').'>'.$b['topname'].'</option>';
			$c['typeid'] = 0;
		}
		$pcondition = "parentid = '".$c['typeid']."'";
		$types=$this->DB->query("
			SELECT typeid
			FROM `entitytype`
			WHERE $pcondition
			ORDER BY ordering ASC
		");
		if($this->DB->numRows()){
			while ($type=$this->DB->fetchArray($types)){
				$r.=$this->chooserEntityType(array(
					'selectedid'=>$c['selectedid'],
					'typeid'=>$type['typeid'],
					'depth'=>$c['depth'],
					'showall'=>$c['showall'],
				));
			}
		}
		if($c['typeid']==0){
			$r .= '</select>';
		}

		return $r;
	}
	//
	function chooserFee($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$deliverys = $this->DB->query("
			SELECT *
			FROM fee
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($delivery = $this->DB->fetchArray($deliverys)){
				$r .= '<option value="'.$delivery['feeid'].'"'.$this->iif($b['selectedid'] == $delivery['feeid'], ' selected', '').'>'.$delivery['title'].' ('.$delivery['entitle'].')</option>';
			}
		}
		$r .= '</select>';

		return $r;
	}
	/*
	*		choose material
	*		@param array(orderby,direction,width,name,topname,hasBlank,selectedid)
	*		return html-select
	*/
	function chooserMaterial($b){
		if($b['width'] > 0){
			$b['width']=' style="width:'.$b['width'].'px;"';
		}
		if($b['showVersion']==1){
			$b['showVersion']=',1';
		}
		if($b['line']!=''){
			$b['line']=','.$b['line'];
		}
		return '<input type="hidden" id="'.$this->iif($b['hId'],$b['hId'],$b['hName']).'" name="'.$b['hName'].'" value="'.$this->iif($b['selectedid'],$b['selectedid'],0).'" />
		<input type="text" name="'.$b['name'].'" id="'.$this->iif($b['id'],$b['id'],$b['name']).'" '.$b['width'].' onfocus="javascript:dc.autoComplete(this,\'material\''.$b['line'].$b['showVersion'].')" value="'.$b['value'].'" />';
	}
	
	/*
	*		choose origin of material
	*		@param array(orderby,direction,width,name,topname,hasBlank,selectedid)
	*		return html-select
	*/
	function chooserMaterialOrigin($b){
		if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$origins=$this->DB->query("
			SELECT *
			FROM materialorigin
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($origin=$this->DB->fetchArray($origins)){
				$r.='<option value="'.$origin['originid'].'"'.$this->iif($b['selectedid']==$origin['originid'], ' selected', '').'>'.$origin['title'].'</option>';
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserMaterialVersion($b){
		if(intval($b['materialid'])<=0){
			return false;
		}else{
			$condition=' AND materialid='.$b['materialid'];
		}
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$versions = $this->DB->query("
			SELECT *
			FROM materialVersion 
			WHERE killed=0 ".$condition."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['id'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($version=$this->DB->fetchArray($versions)){
				$r.='<option value="'.$version['versionid'].'"';
				if($b['selectedid'] == $version['versionid']){
					$r.=' selected';
				}
				$r.='>'.$version['title'].'</option>';
			}
		}
		$r .= '</select>';

		return $r;
	}
	/*
	*		choose type of inbound or outbound
	*		@param array(orderby,direction,width,condition,name,topname,hasBlank,selectedid)
	*		return html-select
	*/
	function chooserInorouttype($b){
		if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		$b['condition']=$this->iif($b['condition'],$b['condition'],'');

		$inOrOutTypes=$this->DB->query("
			SELECT *
			FROM inorouttype
			WHERE killed=0 ".$b['condition']."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($inOrOutType=$this->DB->fetchArray($inOrOutTypes)){
				$r.='<option value="'.$inOrOutType['typeid'].'"'.$this->iif($b['selectedid']==$inOrOutType['typeid'], ' selected', '').'>'.$inOrOutType['title'].'</option>';
			}
		}
		$r.='</select>';

		return $r;
	}
	/*
	*		choose order, included order and purchase order
	*		@param array(orderby,direction,width,name,topname,hasBlank,selectedid,module)
	*		return html-select
	*/
	function chooserOrder($b){
		if($b['orderby']==''){
			$b['orderby']=$b['module'].'id';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		$b['type']=$this->iif($b['routeid']>0,' AND routeid='.$b['routeid'],'');
		$b['route']=$this->iif($b['route'],' AND type="'.$b['route'].'"','');
		$b['customerid']=$this->iif($b['customerid']>0,' AND customerid="'.$b['customerid'].'"','');
		$orders=$this->DB->query("
			SELECT *
			FROM `".$b['module']."`
			WHERE killed=0 ".$b['type']." ".$b['route']." ".$b['customerid']."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($order=$this->DB->fetchArray($orders)){
				$r.='<option value="'.$order[$b['module'].'id'].'"'.$this->iif($b['selectedid']==$order[$b['module'].'id'], ' selected', '').'>'.$order['orderno'].'</option>';
			}
		}
		$r.='</select>';

		return $r;
	}
	/*
	*		choose order, included order and purchase order
	*		@param array(orderby,direction,width,name,topname,hasBlank,selectedid,module)
	*		return html-select
	*/
	function chooserPOrder($b){
		if($b['orderby']==''){
			$b['orderby']='porderid';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		$orders=$this->DB->query("
			SELECT *
			FROM `porder`
			WHERE killed=0 AND ifVerify=1
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($order=$this->DB->fetchArray($orders)){
				$r.='<option value="'.$order['porderid'].'"'.$this->iif($b['selectedid']==$order['porderid'], ' selected', '').'>'.$order['orderno'].'</option>';
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserOrderRoute($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		$routes = $this->DB->query("
			SELECT *
			FROM `orderroute`
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		if($this->DB->numRows()){
			while($route = $this->DB->fetchArray($routes)){
				$r .= '<label class="bold" for="route'.$route['routeid'].'" title="说明：'.$route['caption'].'"><input type="radio" id="route'.$route['routeid'].'" name="'.$b['name'].'" value="'.$route['routeid'].'"';
				if($route['routeid']==$b['selectedid']){
					$r .= ' checked';
				}
				$r .= ' />'.$route['title'].'<span class="small">('.$route['typelist'].')</label>';
			}
		}
		return $r;
	}

	//
	function chooserPacking($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}
		if($b['condition'] == ''){
			$b['condition'] = '1=1';
		}
		$packings = $this->DB->query("
			SELECT *
			FROM `packing`
			WHERE killed=0 AND ".$b['condition']."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($packing = $this->DB->fetchArray($packings)){
				if($b['selectedid'] == $packing['packingid']){
					$r .= '<option value="'.$packing['packingid'].'" selected>'.$packing['title'].' ('.$packing['entitle'].')</option>';
				}else{
					$r .= '<option value="'.$packing['packingid'].'">'.$packing['title'].' ('.$packing['entitle'].')</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}

	//
	function chooserPaymentterm($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'entitle ASC, ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}
		if($b['module']!=''){
			$b['module']=' AND module="'.$b['module'].'"';
		}
		$payments = $this->DB->query("
			SELECT *
			FROM paymentterm
			WHERE killed=0 ".$b['module']."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($payment = $this->DB->fetchArray($payments)){
				if($b['selectedid'] == $payment['paymenttermid']){
					$r .= '<option value="'.$payment['paymenttermid'].'" selected>'.$payment['title'].' ('.$payment['entitle'].')</option>';
				}else{
					$r .= '<option value="'.$payment['paymenttermid'].'">'.$payment['title'].' ('.$payment['entitle'].')</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}
	/* chosser entrust item
	* @param	array	width,orderby,direction,name,selectedid,entrustid
	* @return	select
	*/
	function chooserEntrustItem($b){
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		if($b['orderby']==''){
			$b['orderby']='entrustid ';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		$entrusts=$this->DB->query("
			SELECT entrustid,entrustno,ifVerify
			FROM `entrust`
			WHERE killed=0 AND ifVerify=1
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while ($entrust=$this->DB->fetchArray($entrusts)){
				$items=$this->DB->query("
					SELECT `entrustitem`.itemid,`entrustitem`.materialid,`entrustitem`.ifChooser,`entrustitem`.quantity,
						`material`.materialno,`material`.title,`material`.standard 
					FROM `entrustitem`
					LEFT JOIN `material` ON (`material`.materialid=`entrustitem`.materialid)
					WHERE `entrustitem`.killed=0 AND `entrustitem`.entrustid='".$entrust['entrustid']."'
					ORDER BY `entrustitem`.itemid ASC
				");
				if($this->DB->numRows()){
					$r.='<option'.$this->iif($entrust['ifVerify']==1,' style="font-weight:bold"','').' value="" >'.$entrust['entrustno'].'</option>';
					while($item=$this->DB->fetchArray($items)){
						$r.='<option '.$this->iif($item['ifChooser']==1,' style="color: gray;"', '').' value="'.$item['itemid'].'"'.$this->iif($b['selectedid']==$item['itemid'], ' selected', '').'>　　'.$item['materialno'].'　'.$item['title'].'　'.$item['standard'].'　　(数量：'.$item['quantity'].')</span></option>';
					}
				}
			}
		}else{
			$r.='<option>暂无采购单</option>';
		}
		$r.='</select>';
		return $r;
	}
	/* chosser item of application for purchase
	* @param	array	width,orderby,direction,name,selectedid,purchaseid
	* @return	select
	*/
	function chooserPurchaseApplyItem($b){
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		if($b['orderby']==''){
			$b['orderby']='purchaseApplyid ASC, ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		$applys=$this->DB->query("
			SELECT purchaseApplyid,applyno,ifVerify
			FROM `purchaseApply`
			WHERE killed=0 AND ifVerify=1 AND ifPlan=1
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			if($b['selectedid']){
				$olItem=$this->DB->queryFirst("
					SELECT `preinbounditem`.itemid,`preinbounditem`.materialid,`preinbounditem`.ifChooser,`preinbounditem`.materialno,
							`preinbounditem`.title,`preinbounditem`.standard,`preinbounditem`.quantity,
						`material`.materialno AS newMaterialno,`material`.title AS newTitle,`material`.standard AS newStandard
					FROM `preinbounditem`
					LEFT JOIN `material` ON (`material`.materialid=`preinbounditem`.materialid)
					WHERE `preinbounditem`.itemid='".$b['selectedid']."'
					ORDER BY `preinbounditem`.ordering ASC
				");
				$r.='<option class="bold normal">当前物资</option><option value="'.$olItem['itemid'].'" selected>　　'.$this->iif($olItem['materialid']==0,$olItem['materialno'].'　'.$olItem['title'].'　'.$olItem['standard'],$olItem['newMaterialno'].'　'.$olItem['newTitle'].'　'.$olItem['newStandard']).'　　(数量：'.$olItem['quantity'].')</span></option><option class="bold normal">其他物资</option>';
			}
			while ($apply=$this->DB->fetchArray($applys)){
				$items=$this->DB->query("
					SELECT `preinbounditem`.itemid,`preinbounditem`.materialid,`preinbounditem`.ifChooser,`preinbounditem`.materialno,
							`preinbounditem`.title,`preinbounditem`.standard,`preinbounditem`.quantity,
						`material`.materialno AS newMaterialno,`material`.title AS newTitle,`material`.standard AS newStandard
					FROM `preinbounditem`
					LEFT JOIN `material` ON (`material`.materialid=`preinbounditem`.materialid)
					WHERE `preinbounditem`.killed=0 AND `preinbounditem`.ifChooser=0 AND `preinbounditem`.module='purchaseApply' AND `preinbounditem`.mid='".$apply['purchaseApplyid']."'
					ORDER BY `preinbounditem`.ordering ASC
				");
				if($this->DB->numRows()){
					$r.='<option'.$this->iif($apply['ifVerify']==1, ' style="font-weight:bold"', '').' value="" >'.$apply['applyno'].'</option>';
					while($item=$this->DB->fetchArray($items)){
						$r.='<option value="'.$item['itemid'].'">　　'.$this->iif($item['materialid']==0,$item['materialno'].'　'.$item['title'].'　'.$item['standard'],$item['newMaterialno'].'　'.$item['newTitle'].'　'.$item['newStandard']).'　　(数量：'.$item['quantity'].')</span></option>';
					}
				}
			}
		}else{
			$r.='<option>暂无采购申请单</option>';
		}
		$r.='</select>';
		return $r;
	}
	/* chosser purchase item
	* @param	array	width,orderby,direction,name,selectedid,purchaseid
	* @return	select
	*/
	function chooserPurchaseItem($b){
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		if($b['orderby']==''){
			$b['orderby']='purchaseid ASC, ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		$purchases=$this->DB->query("
			SELECT purchaseid, purchaseno,ifVerify
			FROM `purchase`
			WHERE killed=0 AND ifVerify=1
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			if($b['selectedid']){
				$olItem=$this->DB->queryFirst("
					SELECT `purchaseitem`.itemid,`purchaseitem`.materialid,`purchaseitem`.ifChooser,`purchaseitem`.materialno,
							`purchaseitem`.title,`purchaseitem`.standard,`purchaseitem`.quantity,
						`material`.materialno AS newMaterialno,`material`.title AS newTitle,`material`.standard AS newStandard
					FROM `purchaseitem`
					LEFT JOIN `material` ON (`material`.materialid=`purchaseitem`.materialid)
					WHERE `purchaseitem`.itemid='".$b['selectedid']."'
					ORDER BY `purchaseitem`.ordering ASC
				");
				$r.='<option class="bold normal">当前物资</option><option value="'.$olItem['itemid'].'" selected>　　'.$this->iif($olItem['materialid']==0,$olItem['materialno'].'　'.$olItem['title'].'　'.$olItem['standard'],$olItem['newMaterialno'].'　'.$olItem['newTitle'].'　'.$olItem['newStandard']).'　　(数量：'.$olItem['quantity'].')</span></option><option class="bold normal">其他物资</option>';
			}
			while ($purchase=$this->DB->fetchArray($purchases)){
				$items=$this->DB->query("
					SELECT `purchaseitem`.itemid,`purchaseitem`.materialid,`purchaseitem`.ifChooser,`purchaseitem`.quantity,
						`preinbounditem`.materialno,`preinbounditem`.title,`preinbounditem`.standard,
						`material`.materialno AS newMaterialno,`material`.title AS newTitle,`material`.standard AS newStandard
					FROM `purchaseitem` 
					LEFT JOIN `preinbounditem` ON (`preinbounditem`.itemid=`purchaseitem`.applyItemid)
					LEFT JOIN `material` ON (`material`.materialid=`purchaseitem`.materialid)
					WHERE `purchaseitem`.killed=0 AND `purchaseitem`.ifChooser=0 AND `purchaseitem`.purchaseid='".$purchase['purchaseid']."'
					ORDER BY `purchaseitem`.ordering ASC
				");
				if($this->DB->numRows()){
					$r.='<option'.$this->iif($purchase['ifVerify']==1,' style="font-weight:bold"','').' value="" >'.$purchase['purchaseno'].'</option>';
					while($item=$this->DB->fetchArray($items)){
						$r.='<option value="'.$item['itemid'].'">　　'.$this->iif($item['materialid']==0,$item['materialno'].'　'.$item['title'].'　'.$item['standard'],$item['newMaterialno'].'　'.$item['newTitle'].'　'.$item['newStandard']).'　　(数量：'.$item['quantity'].')</span></option>';
					}
				}
			}
		}else{
			$r.='<option>暂无采购单</option>';
		}
		$r.='</select>';
		return $r;
	}
	/* chosser purchase 
	* @param	array	width,orderby,direction,name,selectedid,purchaseid
	* @return	select
	*/
	function chooserPurchase($b){
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		if($b['orderby']==''){
			$b['orderby']='created DESC, purchaseid';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['module']!=''){
			$items=$this->DB->query("SELECT DISTINCT purchaseid FROM purchaseitem WHERE killed=0 AND ifChooser=0 AND module='".$b['module']."' ORDER BY created ASC");
			if($this->DB->numRows()){
				while($item=$this->DB->fetchArray($items)){
					$id[]=$item['purchaseid'];
				}
			}
			if(is_Array($id)){
				$condition=" AND purchaseid IN (".implode(',',$id).")";
			}
		}
		$purchases=$this->DB->query("
			SELECT purchaseid, purchaseno 
			FROM `purchase`
			WHERE killed=0 AND ifVerify=1 ".$condition."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($purchase=$this->DB->fetchArray($purchases)){
				$r.='<option value="'.$purchase['purchaseid'].'"';
				if($b['selectedid'] == $purchase['purchaseid']){
					$r.=' selected';
				}
				$r.='>'.$purchase['purchaseno'].'</option>';
			}
		}
		$r .= '</select>';
		return $r;
	}

	//
	function chooserPInvoiceType($b){
		if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		$b['condition']=$this->iif($b['condition'],$b['condition'],'');

		$invoiceTypes=$this->DB->query("
			SELECT *
			FROM pinvoicetype
			WHERE killed=0 ".$b['condition']."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($invoiceType=$this->DB->fetchArray($invoiceTypes)){
				$r.='<option value="'.$invoiceType['pinvoiceTypeid'].'"'.$this->iif($b['selectedid']==$invoiceType['pinvoiceTypeid'], ' selected', '').'>'.$invoiceType['title'].'</option>';
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserPort($b){
		if($b['orderby'] == ''){
			$b['orderby'] = '`region`.encountry ASC, ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$ports = $this->DB->query("
			SELECT `port`.*,
				`region`.country, `region`.encountry
			FROM `port`
			LEFT JOIN `region` ON (`region`.regionid=`port`.regionid)
			WHERE `port`.killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($port = $this->DB->fetchArray($ports)){
				if($b['selectedid'] == $port['portid']){
					$r .= '<option value="'.$port['portid'].'" selected>'.substr($port['encountry'],0,1).' '.$port['country'].'：'.$port['title'].'('.$port['entitle'].')</option>';
				}else{
					$r .= '<option value="'.$port['portid'].'">'.substr($port['encountry'],0,1).' '.$port['country'].'：'.$port['title'].'('.$port['entitle'].')</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}
	//
	function chooserRegion($b){
		if($b['regionid']>0){
			$region = $this->DB->queryFirst("SELECT regionid, countryid, provinceid, pnum, cnum FROM `region` WHERE regionid='".$b['regionid']."'");
		}else{
			$b['regionid']=-1;
		}
		if($b['orderby'] == ''){
			$b['orderby'] = 'encountry';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}
		if($b['areaid']>0){
			$b['areaid'] = " AND areaid='".$b['areaid']."'";
		}else{
			$b['areaid'] = "";
		}
		
		$countrys = $this->DB->query("SELECT regionid, country, encountry, abbr, countryid, pnum FROM region WHERE killed=0 AND countryid=0 ".$b['areaid']." ORDER BY encountry ASC");
		if($this->DB->numRows()){
			$r = '<input type="hidden" id="lastCountryid" value=""><input type="hidden" id="regionid" name="regionid" value="'.$b['regionid'].'"><input type="hidden" id="lastProvinceid" value=""><select id="countryid" name="countryid" style="width:115px" onchange="dc.region.province(this);">';
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			$selCountry = '';
			while($country = $this->DB->fetchArray($countrys)){
				$r .= '<option value="'.$country['regionid'].'"';
				if($country['regionid']==$region['countryid'] OR $country['regionid']==$region['regionid']){
					$r .= ' selected';
					$selCountry = $country;
				}
				$r .= '>'.substr($country['encountry'],0,1).' '.$country['country'] .'</option>';

			}
			$r .= '</select>';
		}
		if(!is_Array($selCountry))$selCountry['pnum']=0;
		if($selCountry['pnum']>0){
			$provinces = $this->DB->query("SELECT regionid, state, enstate, provinceid, sabbr, cnum FROM region WHERE killed=0 AND countryid='".$selCountry['regionid']."' AND provinceid=0 ORDER BY enstate ASC");
			if($this->DB->numRows()){
				$r.='<span id="province" style="display:inline"><select id="provinceid" name="provinceid" style="width:115px" onchange="dc.region.city(this);">';
				if($b['hasBlank']){
					$r .= '<option value="-1">'.$b['topname'].'</option>';
				}
				$selProvince='';
				while($province = $this->DB->fetchArray($provinces)){
					$r .= '<option value="'.$province['regionid'].'"';
					if($province['regionid']==$region['regionid'] OR $province['regionid']==$region['provinceid']){
						$r .= ' selected';
						$selProvince = $province;
					}
					$r .= '>'.substr($province['enstate'],0,1).' '.$province['state']. '</option>';
				}
				$r.='</select></span>';
			}
			if(!is_Array($selProvince))$selProvince['cnum']=0;
			if($selProvince['cnum']>0){ //city
				$citys = $this->DB->query("SELECT regionid, city, encity, cabbr FROM region WHERE killed=0 AND countryid='".$selCountry['regionid']."' AND provinceid='".$selProvince['regionid']."' ORDER BY encity ASC");
				if($this->DB->numRows()){
					$r.='<span id="city" style="display:inline"><select id="cityid" name="cityid" style="width:115px">';
					if($b['hasBlank']){
						$r .= '<option value="-1">'.$b['topname'].'</option>';
					}
					while($city = $this->DB->fetchArray($citys)){
						$r .= '<option value="'.$city['regionid'].'"'.$this->iif($city['regionid']==$region['regionid'], ' selected', '').'>'.substr($city['encity'],0,1).' '.$city['city'].'</option>';
					}
					$r.='</select></span>';
				}
			}else{
				$r .= '<span id="city" style="display:none"></span>';
			}
		}else{
			$r.='<span id="province" style="display:none"></span><span id="city" style="display:none"></span>';
		}
		return $r;
	}

	//
	function chooserProvince($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'provinceid';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$provinces = $this->DB->query("
			SELECT *
			FROM province
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($province = $this->DB->fetchArray($provinces)){
				if($b['selectedid'] == $province['provinceid']){
					$r .= '<option value="'.$province['provinceid'].'" selected>'.$province['title'].'</option>';
				}else{
					$r .= '<option value="'.$province['provinceid'].'">'.$province['title'].'</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}
		//
	function chooserTaxRate($b){
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		$taxRate=array(0=>0,1=>3,2=>13,3=>17);
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].' >';
		foreach($taxRate as $key => $val){
			if($b['selectedid']==$val){
				$r.='<option value="'.$val.'" selected>'.$val.'% </option>';
			}else{
				$r.='<option value="'.$val.'">'.$val.'% </option>';
			}
		}
		$r.='</select>';
		return $r;
	}
	//
	function chooserSampleType($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}
		if($b['selectedid'] != ''){
			$id = explode(',',$b['selectedid']);
		}
		$sampletypes = $this->DB->query("
			SELECT *
			FROM `sampletype`
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		if($this->DB->numRows()){
			$i=1;
			while($sampletype = $this->DB->fetchArray($sampletypes)){
				$r .= '<label for="stype'.$sampletype['typeid'].'" title="('.$sampletype['entitle'].') '.$sampletype['remark'].'"><input type="checkbox" id="stype'.$sampletype['typeid'].'" name="'.$b['name'].'['.$i.']" value="'.$sampletype['typeid'].'"';
				if(is_array($id) AND in_array($sampletype['typeid'], $id)){
					$r .= ' checked';
				}
				$r .= ' />'.$sampletype['title'].'</label>';
				$i++;
			}
		}
		return $r;
	}

	//
	function chooserShipmethod($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$shipmethods = $this->DB->query("
			SELECT *
			FROM shipmethod
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($shipmethod = $this->DB->fetchArray($shipmethods)){
				if($b['selectedid'] == $shipmethod['shipmethodid']){
					$r .= '<option value="'.$shipmethod['shipmethodid'].'" selected>'.$shipmethod['title'].' ('.$shipmethod['remark'].')</option>';
				}else{
					$r .= '<option value="'.$shipmethod['shipmethodid'].'">'.$shipmethod['title'].' ('.$shipmethod['remark'].')</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}

	//
	function chooserSize($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$sizes = $this->DB->query("
			SELECT *
			FROM size
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].''.$b['js'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($size = $this->DB->fetchArray($sizes)){
				if($b['selectedid'] == $size['sizeid']){
					$r .= '<option value="'.$size['sizeid'].'" selected>'.$size['title'].'</option>';
				}else{
					$r .= '<option value="'.$size['sizeid'].'">'.$size['title'].'</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}

	//
	function chooserSupplier($b){
		if($b['width'] > 0){
			$b['width']=' style="width:'.$b['width'].'px;"';
		}
		if($b['line']!=''){
			$b['line']=','.$b['line'];
		}
		return '<input type="hidden" id="'.$this->iif($b['hId'],$b['hId'],$b['hName']).'" name="'.$b['hName'].'" value="'.$this->iif($b['selectedid'],$b['selectedid'],0).'" />
		<input type="text" name="'.$b['name'].'" id="'.$this->iif($b['id'],$b['id'],$b['name']).'" '.$b['width'].' onfocus="javascript:dc.autoComplete(this,\'supplier\''.$b['line'].')" value="'.$b['value'].'" />';
	}
	
	//
	function chooserSupplierSelect($b){
		if($b['field']=='produce'){
			$field=' AND flied="produce"';
		}elseif($b['field']=='trade'){
			$field=' AND flied="trade"';
		}
		if($b['orderby'] == ''){
			$b['orderby'] = 'title';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}
	
		$suppliers = $this->DB->query("
			SELECT *
			FROM supplier
			WHERE killed=0 ".$filed."
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($supplier = $this->DB->fetchArray($suppliers)){
				if($b['selectedid'] == $supplier['supplierid']){
					$r .= '<option value="'.$supplier['supplierid'].'" selected>'.$supplier['title'].'</option>';
				}else{
					$r .= '<option value="'.$supplier['supplierid'].'">'.$supplier['title'].'</option>';
				}
			}
		}
		$r .= '</select>';
	
		return $r;
	}
	
	//
	function chooserStock($b){
		if($b['orderby']==''){
			$b['orderby']='stockno';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width'] > 0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}
		$types=$this->DB->query("SELECT categoryid,title FROM category WHERE parentid=15 ORDER BY categoryid ASC");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			while($type=$this->DB->fetchArray($types)){
				$r.='<option>'.$type['title'].'</option>';
				$stocks=$this->DB->query("
					SELECT *
					FROM stock
					WHERE killed=0 AND categoryid='".$type['categoryid']."'
					ORDER BY ".$b['orderby']." ".$b['direction']."
				");
				if($this->DB->numRows()){
					while($stock=$this->DB->fetchArray($stocks)){
						$ifEmpty=$this->iif($stock['ifEmpty']==1,'（已满）','');
						$ifEmptyColor=$this->iif($stock['ifEmpty']==1,'class="gray"','');
						$r.='<option value="'.$stock['stockid'].'" '.$ifEmptyColor;
						if($b['selectedid']==$stock['stockid']){
							$r.='selected';
						}
						$r.=' >　　'.$stock['stockno'].$ifEmpty.'</option>';
						$items=$this->DB->query("
							SELECT si.quantity,si.materialid,
								m.materialno
							FROM stockitem AS si 
							LEFT JOIN material AS m ON (m.materialid=si.materialid) 
							WHERE si.killed=0 AND si.stockid='".$stock['stockid']."'
						");
						$materialId=$quantity=array();
						if($this->DB->numRows($items)){
							while($item=$this->DB->fetchArray($items)){
								if(in_array($item['materialid'],$materialId)){
									$quantity[$item['materialid']]+=$item['quantity'];
								}else{
									$quantity[$item['materialid']]=$item['quantity'];
									$materialId[]=$item['materialid'];
									$materialno[$item['materialid']]=$item['materialno'];
								}
							}
						}
						foreach($materialId as $key => $val){
							$r.='<option value="'.$stock['stockid'].'" '.$ifEmptyColor.'>　　　　'.$materialno[$val].' ('.$quantity[$val].')</option>';
						}
					}
				}
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserUnit($b){
		if($b['orderby'] == ''){
			$b['orderby'] = 'ordering';
		}
		if($b['direction'] == ''){
			$b['direction'] = 'ASC';
		}
		if($b['width'] > 0){
			$b['width'] = ' style="width: '.$b['width'].'px;"';
		}

		$units = $this->DB->query("
			SELECT *
			FROM unit
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r = '<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r .= '<option value="0">'.$b['topname'].'</option>';
			}
			while($unit = $this->DB->fetchArray($units)){
				if($b['selectedid'] == $unit['unitid']){
					$r .= '<option value="'.$unit['unitid'].'" selected>'.$unit['title'].' ('.$unit['entitle'].')</option>';
				}else{
					$r .= '<option value="'.$unit['unitid'].'">'.$unit['title'].' ('.$unit['entitle'].')</option>';
				}
			}
		}
		$r .= '</select>';

		return $r;
	}
		//NWI BUG
	function chooserProject($b){
		if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$projects=$this->DB->query("
			SELECT *
			FROM project
			WHERE killed=0 AND enabled=1
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($project=$this->DB->fetchArray($projects)){
				if($b['selectedid']==$project['projectid']){
					$r.='<option value="'.$project['projectid'].'" selected>'.$project['title'].'</option>';
				}else{
					$r.='<option value="'.$project['projectid'].'">'.$project['title'].'</option>';
				}
			}
		}
		$r.='</select>';

		return $r;
	}

	// 
	function chooserPriority($b){
			if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$prioritys=$this->DB->query("
			SELECT *
			FROM priority
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($priority=$this->DB->fetchArray($prioritys)){
				if($b['selectedid']==$priority['priorityid']){
					$r.='<option value="'.$priority['priorityid'].'" selected>'.$priority['title'].'</option>';
				}else{
					$r.='<option value="'.$priority['priorityid'].'">'.$priority['title'].'</option>';
				}
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserSeverity($b){
			if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$severitys=$this->DB->query("
			SELECT *
			FROM severity
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($severity=$this->DB->fetchArray($severitys)){
				if($b['selectedid']==$severity['severityid']){
					$r.='<option value="'.$severity['severityid'].'" selected>'.$severity['title'].'</option>';
				}else{
					$r.='<option value="'.$severity['severityid'].'">'.$severity['title'].'</option>';
				}
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserReproducibility($b){
		if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$reproducibilitys=$this->DB->query("
			SELECT *
			FROM reproducibility
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($reproducibility=$this->DB->fetchArray($reproducibilitys)){
				if($b['selectedid']==$reproducibility['reproducibilityid']){
					$r.='<option value="'.$reproducibility['reproducibilityid'].'" selected>'.$reproducibility['title'].'</option>';
				}else{
					$r.='<option value="'.$reproducibility['reproducibilityid'].'">'.$reproducibility['title'].'</option>';
				}
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserBugstatus($b){
		if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$bugstatuses=$this->DB->query("
			SELECT *
			FROM bugstatus
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($bugstatus=$this->DB->fetchArray($bugstatuses)){
				if($b['selectedid']==$bugstatus['bugstatusid']){
					$r.='<option value="'.$bugstatus['bugstatusid'].'" selected>'.$bugstatus['title'].'</option>';
				}else{
					$r.='<option value="'.$bugstatus['bugstatusid'].'">'.$bugstatus['title'].'</option>';
				}
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserProstatus($b){
		if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$prostatuses=$this->DB->query("
			SELECT *
			FROM prostatus
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($prostatus=$this->DB->fetchArray($prostatuses)){
				if($b['selectedid']==$prostatus['prostatusid']){
					$r.='<option value="'.$prostatus['prostatusid'].'" selected>'.$prostatus['title'].'</option>';
				}else{
					$r.='<option value="'.$prostatus['prostatusid'].'">'.$prostatus['title'].'</option>';
				}
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserResolution($b){
			if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$resolutions=$this->DB->query("
			SELECT *
			FROM resolution
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($resolution=$this->DB->fetchArray($resolutions)){
				if($b['selectedid']==$resolution['resolutionid']){
					$r.='<option value="'.$resolution['resolutionid'].'" selected>'.$resolution['title'].'</option>';
				}else{
					$r.='<option value="'.$resolution['resolutionid'].'">'.$resolution['title'].'</option>';
				}
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserOs($b){
		if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$oses=$this->DB->query("
			SELECT *
			FROM os
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($os=$this->DB->fetchArray($oses)){
				if($b['selectedid']==$os['osid']){
					$r.='<option value="'.$os['osid'].'" selected>'.$os['title'].'</option>';
				}else{
					$r.='<option value="'.$os['osid'].'">'.$os['title'].'</option>';
				}
			}
		}
		$r.='</select>';

		return $r;
	}
	//
	function chooserPlatform($b){
		if($b['orderby']==''){
			$b['orderby']='ordering';
		}
		if($b['direction']==''){
			$b['direction']='ASC';
		}
		if($b['width']>0){
			$b['width']=' style="width: '.$b['width'].'px;"';
		}

		$platforms=$this->DB->query("
			SELECT *
			FROM platform
			WHERE killed=0
			ORDER BY ".$b['orderby']." ".$b['direction']."
		");
		$r='<select id="'.$b['name'].'" name="'.$b['name'].'"'.$b['width'].'>';
		if($this->DB->numRows()){
			if($b['hasBlank']){
				$r.='<option value="0">'.$b['topname'].'</option>';
			}
			while($platform=$this->DB->fetchArray($platforms)){
				if($b['selectedid']==$platform['platformid']){
					$r.='<option value="'.$platform['platformid'].'" selected>'.$platform['title'].'</option>';
				}else{
					$r.='<option value="'.$platform['platformid'].'">'.$platform['title'].'</option>';
				}
			}
		}
		$r.='</select>';

		return $r;
	}

	// Fee form & list
	function formFee($f){
		$k=1;
		if($f['mid']>0){
			$items = $this->DB->query("SELECT * FROM `feeitem` WHERE killed=0 AND module='".$f['module']."' AND mid='".$f['mid']."' ORDER BY itemid ASC, modified ASC");
			if($this->DB->numRows()){
				$this->tbline+=1;
				while($item = $this->DB->fetchArray($items)){
					$feetr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
					<td><input type="hidden" name="feeItemid['.$k.']" value="'.$item['itemid'].'">'.$this->chooserFee(array('name'=>'feeid['.$k.']', 'hasBlank'=>1, 'width'=>250, 'selectedid'=>$item['feeid'])).'</td>
					<td><input type="text" name="feeCaption['.$k.']" value="'.$item['caption'].'" size="40"></td>
					<td><input type="text" name="feeRemark['.$k.']" value="'.$item['remark'].'" size="30"></td>
					<td><input type="text" name="feeDiscount['.$k.']" value="'.$item['discount'].'" size="3"></td>
					<td><input type="text" name="feeQuantity['.$k.']" value="'.$item['quantity'].'" size="4"></td>
					<td>'.$this->chooserUnit(array('name'=>'feeUnitid['.$k.']', 'hasBlank'=>1, 'width'=>100, 'selectedid'=>$item['unitid'])).'</td>
					<td><input type="text" name="feePrice['.$k.']" value="'.$item['price'].'" size="5"></td>
					<td><input type="checkbox" name="feeKill['.$k.'] value="'.$item['itemid'].'"></td>
					</tr>';
					$k++;
				}
			}
			$feetr.='<tr><td colspan="12">新建费用项目明细</td></tr>';
		}
		for($i = $k; $i < ($k+2); $i++){
			$feetr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
			<td>'.$this->chooserFee(array('name'=>'feeid['.$i.']', 'hasBlank'=>1, 'width'=>250)).'</td>
			<td><input type="text" name="feeCaption['.$i.']" value="'.$fee['caption'].'" size="40"></td>
			<td><input type="text" name="feeRemark['.$i.']" value="'.$fee['remark'].'" size="30"></td>
			<td><input type="text" name="feeDiscount['.$i.']" value="100" size="3"></td>
			<td><input type="text" name="feeQuantity['.$i.']" value="'.$fee['quantity'].'" size="5"></td>
			<td>'.$this->chooserUnit(array('name'=>'feeUnitid['.$i.']', 'hasBlank'=>1, 'width'=>100, 'selectedid'=>$this->input['unitid'])).'</td>
			<td><input type="text" name="feePrice['.$i.']" value="'.$fee['price'].'" size="5"></td>
			<td></td>
			</tr>';
		}
return <<<EOF
<table class="hundred">
<thead>
<tr>
	<th colspan="12">费用项目明细表 (可填)</th>
</tr>
</thead>
<tr><td>费用项目<span class="red bold">*</span></td><td>说明</td><td>备注</td><td>折扣%</td><td>数量<span class="red bold">*</span></td><td>单位<span class="red bold">*</span></td><td>单价<span class="red bold">*</span></td><td>删</td></tr>
<tbody class="small">
{$feetr}
<tr>
	<td colspan="8" class="gray small">注：①如行数不够，请保存后再进入修改页面。②至少有“名称”、“数量”、“单位”、“单价”等四个项目，该条明细才会被保存。③折扣值范围“1-100”，不填默认为“100”。</td>
</tr>
</tbody>
</table>
EOF;
	}
	// discount form & list
	function formDiscount($f){
		$k=1;
		if($f['mid']>0){
			$items = $this->DB->query("SELECT * FROM `discount` WHERE killed=0 AND module='".$f['module']."' AND mid='".$f['mid']."' ORDER BY modified ASC, discountid DESC");
			if($this->DB->numRows()){
				$this->tbline+=1;
				while($item = $this->DB->fetchArray($items)){
					$a0=$s0=' checked';
					$a1=$s1='';
					if($item['addition']=='+'){
						$a1=$a0;
						$a0='';
					}
					if($item['sign']=='null'){
						$s1=$s0;
						$s0='';
					}
					$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
					<td><input type="hidden" name="discountid['.$k.']" value="'.$item['discountid'].'"><input type="text" name="discountReason['.$k.']" value="'.$item['reason'].'" size="40"></td>
					<td><label for="discountAddition'.$k.'0"><input type="radio" name="discountAddition['.$k.']" value="-" id="discountAddition'.$k.'0"'.$a0.'>减去(<span class="big bold">-</span>)</label> <label for="discountAddition'.$k.'1"><input type="radio" name="discountAddition['.$k.']" value="+" id="discountAddition'.$k.'1"'.$a1.'>加上(<span class="middle bold">+</span>)</label></td>
					<td><input type="text" name="discount['.$k.']" value="'.$item['discount'].'" size="10"></td>
					<td><label for="discountSign'.$k.'0"><input type="radio" name="discountSign['.$k.']" value="%" id="discountSign'.$k.'0"'.$s0.'>百分之(<span class="bold">%</span>)</label> <label for="discountSign'.$k.'1"><input type="radio" name="discountSign['.$k.']" value="null" id="discountSign'.$k.'1"'.$s1.'>无</label></td>
					<td><input type="checkbox" name="discountKill['.$k.'] value="'.$item['discountid'].'"></td>
					</tr>';
					$k++;
				}
			}
			$itemtr.='<tr><td colspan="12">新建折扣明细</td></tr>';
		}
		for($i = $k; $i < ($k+2); $i++){
			$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
			<td><input type="text" name="discountReason['.$i.']" value="'.$item['itemReason'].'" size="40"></td>
			<td><label for="discountAddition'.$i.'0"><input type="radio" name="discountAddition['.$i.']" value="-" id="discountAddition'.$i.'0" checked>减去(<span class="big bold">-</span>)</label> <label for="discountAddition'.$i.'1"><input type="radio" name="discountAddition['.$i.']" value="+" id="discountAddition'.$i.'1">加上(<span class="middle bold">+</span>)</label></td>
			<td><input type="text" name="discount['.$i.']" value="'.$item['Discount'].'" size="10"></td>
			<td><label for="discountSign'.$i.'0"><input type="radio" name="discountSign['.$i.']" value="%" id="discountSign'.$i.'0" checked>百分之(<span class="bold">%</span>)</label> <label for="discountSign'.$i.'1"><input type="radio" name="discountSign['.$i.']" value="null" id="discountSign'.$i.'1">无</label></td>
			<td></td>
			</tr>';
		}
return <<<EOF
<table class="hundred">
<thead>
<tr>
	<th colspan="5">折扣 明细表</th>
</tr>
</thead>
<tbody>
<tr><td title="Reason">折扣说明(理由)<span class="red">*</span></td><td title="Addition">加/减</td><td title="">数量<span class="red">*</span></td><td>百分比</td><td>删</td></tr>
{$itemtr}
<tr class="even">
	<td colspan="5" class="gray small">注：①如行数不够，请保存后再进入修改页面。②至少有“折扣说明”、“数量”等两个项目，该折扣明细才会被保存。③如折扣是百分比"%"，数量值范围“0-100”，否则无限制。</td>
</tr>
</tbody>
</table>
EOF;
	}
	// 
	function formMaterial($f){
		$unit=$this->chooserUnit(array('name'=>'unitid', 'hasBlank'=>1, 'width'=>100,'selectedid'=>$this->iif($f['unitid']>0,$f['unitid'],5)));
		$packing=$this->chooserPacking(array('name'=>'packingid', 'hasBlank'=>1, 'width'=>200,'selectedid'=>$f['packingid']));
		$brand=$this->chooserBrand(array('name'=>'brandid', 'hasBlank'=>1, 'width'=>200,'selectedid'=>$f['brandid']));
		$origin=$this->chooserMaterialOrigin(array('name'=>'originid', 'hasBlank'=>1, 'width'=>100,'selectedid'=>$f['originid']));
		$category=$this->chooserCategory(array('name'=>'categoryid','width'=>200,'selectedid'=>$f['categoryid']));
		$quantity=$this->iif($f['quantity']>0,$f['quantity'],0);
		$qualified=$this->iif($f['qualified']>0,$f['qualified'],0);
		$disqualified=$this->iif($f['disqualified']>0,$f['disqualified'],0);
		if($f['ifPerBarcode']==1){
			$checked2=' checked';
		}else{
			$checked1=' checked';
		}
		if($f['inventoryType']=='choose'){
			$selected1=' selected';
		}elseif($f['inventoryType']=='must'){
			$selected2=' selected';
		}
		$uptolerance=$this->iif($f['uptolerance']!='',$f['uptolerance'],0);
		$belowtolerance=$this->iif($f['belowtolerance']!='',$f['belowtolerance'],0);
		$r=<<<EOF
{$f['hidden']}
<table class="hundred">
<thead><tr><th colspan="4">物资基础资料</th></tr></thead>
<tbody>
<tr class="odd">
<td width="100">物资编号：<span class="red bold">*</span></td><td width="450"><input type="text" name="materialno" value="{$f['materialno']}" /></td>
<td width="100">物资名称：<span class="red bold">*</span></td><td><input type="text" name="title" id="title" style="width:450px" value="{$f['title']}" /></td>
</tr>
<tr class="odd">
<td>物资规格：<span class="red bold">*</span></td><td><input type="text" name="standard" style="width:450px" value="{$f['standard']}" /></td>
<td>物资分类：<span class="red bold">*</span></td><td width="450">{$category}</td>
</tr>
<tr class="even">
<td>单　　位：<span class="red bold">*</span></td><td>{$unit}</td>
<td>包　　装：</td><td>{$packing}</td>
</tr>
<tr class="odd">
<td>物资来源：<span class="red bold">*</span></td><td>{$origin}</td>
<td>盘点类型：<span class="red bold">*</span></td><td><select name="inventoryType" style="width:100px"><option value="choose" {$selected1}>抽盘</option><option value="must" {$selected2}>必盘</option></select></td>
</tr>
<tr class="even">
<td>品　　牌：</td><td>{$brand}</td>
<td>总　　数：</td><td><input type="text" name="quantity" value="{$quantity}" /></td>
</tr>
<tr class="odd">
<td>良品数量：</td><td><input type="text" name="qualified" value="{$qualified}" /></td>
<td>不良品数量：</td><td><input type="text" name="disqualified" value="{$disqualified}" /></td>
</tr>
<tr class="even">
<td>最大峰值：<span class="red bold">*</span></td><td><input type="text" name="max" value="{$f['max']}" /></td>
<td>最小报警值：<span class="red bold">*</span></td><td><input type="text" name="min" value="{$f['min']}" /></td>
</tr>
<tr class="odd">
<td>临界报警值：<span class="red bold">*</span></td><td><input type="text" name="criticalNumber" value="{$f['criticalNumber']}" /></td>
<td>允 差 值：</td><td> < <input type="text" name="uptolerance" value="{$uptolerance}" /> ‰ ,> <input type="text" name="belowtolerance" value="{$belowtolerance}" /> ‰</td>
</tr>
EOF;
$r.=$this->iif($f,'','<tr class="even">
<td>版　　本：<span class="red bold">*</span></td><td><input type="text" name="version" value="'.$f['version'].'" /></td>
<td>版本改变：<span class="red bold">*</span></td><td><input type="text" name="change" value="'.$f['change'].'" style="width:450px"/></td>
</tr>');
$r.=<<<EOF
<tr class="odd">
<td>是否分配流水号条码：<span class="red bold">*</span></td><td><input type="radio" name="ifPerBarcode" value="0" {$checked1} />否 <input type="radio" name="ifPerBarcode" value="1" {$checked2}/>是</td>
<td>备　　注：</td><td><textarea name="remark" style="width:444px;height:111px;">{$f['remark']}</textarea></td>
</tr>
</tbody>
</table>
EOF;
		return $r;
	}

	// update for Fee
	function updateFee($u){
		if($u['module']=='' OR $u['mid']<=0){
			return false;
		}
		for($i = 1; $i < count($this->input['feeid'])+1; $i++){
			$this->input['feeQuantity'][$i]=intVal($this->input['feeQuantity'][$i]);
			$this->input['feePrice'][$i]=floatVal($this->input['feePrice'][$i]);
			$this->input['feeDiscount'][$i]=intVal($this->input['feeDiscount'][$i]);
			if($this->input['feeDiscount'][$i]<1 OR $this->input['feeDiscount'][$i]>100){
				$this->input['feeDiscount'][$i]=100;
			}
			$amount = $this->input['feeQuantity'][$i] * $this->input['feePrice'][$i];
			if($this->input['feeDiscount'][$i]<100){
				$amount = $amount * $this->input['feeDiscount'][$i] / 100;
			}
			$amount = number_format($amount, 2, '.', '');
			if($this->input['feeItemid'][$i]>0){
				if($this->input['feeKill'][$i]=='on'){
					$this->DB->query("UPDATE `feeitem` SET killer='".$this->user['userid']."', killed=".TIMENOW."  WHERE itemid='".$this->input['feeItemid'][$i]."'");
				}else{
					$this->DB->query("
						UPDATE `feeitem` SET
							`feeid`='".$this->input['feeid'][$i]."',
							`caption`='".$this->input['feeCaption'][$i]."',
							`remark`='".$this->input['feeRemark'][$i]."',
							`discount`='".$this->input['feeDiscount'][$i]."',
							`quantity`='".$this->input['feeQuantity'][$i]."',
							`unitid`='".$this->input['feeUnitid'][$i]."',
							`price`='".$this->input['feePrice'][$i]."',
							`amount`='".$amount."',
							`modified`='".TIMENOW."',
							`modifier`='".$this->user['userid']."'
						WHERE itemid='".$this->input['feeItemid'][$i]."'
					");
					$quantity+=$this->input['feeQuantity'][$i];
				}
			}elseif($this->input['feeid'][$i]>0 AND $this->input['feeQuantity'][$i]!='' AND $this->input['feeUnitid'][$i]>0 AND $this->input['feePrice'][$i]>0){
				$this->DB->query("
					INSERT INTO `feeitem` (`module`,`mid`,`feeid`,`caption`,`remark`,`quantity`,`discount`,`unitid`,`price`,`amount`,`modified`,`creator`,`created`)
					VALUES (
					'".$u['module']."', '".$u['mid']."', '".$this->input['feeid'][$i]."', '".$this->input['feeCaption'][$i]."', '".$this->input['feeRemark'][$i]."', '".$this->input['feeQuantity'][$i]."', '".$this->input['feeDiscount'][$i]."', '".$this->input['feeUnitid'][$i]."', '".$this->input['feePrice'][$i]."', '".$amount."', '".TIMENOW."', '".$this->user['userid']."', '".TIMENOW."')
				");
				$quantity+=$this->input['feeQuantity'][$i];
			}
		}
		return true;
	}

	// update for discount
	function updateDiscount($u){
		if($u['module']=='' OR $u['mid']<=0){
			return false;
		}
		for($i = 1; $i < count($this->input['discountReason'])+1; $i++){
			$this->input['discount'][$i]=floatVal($this->input['discount'][$i]);
			$this->input['discount'][$i]=trim($this->input['discount'][$i]);
			if($this->input['discountSign'][$i]=='%'){
				if($this->input['discount'][$i]>0 OR $this->input['discount'][$i]<100){
					$this->input['discount'][$i]=intVal($this->input['discount'][$i]);
				}else{
					$this->input['discount'][$i]=0;
				}
			}else{
				$this->input['discount'][$i]=floatVal($this->input['discount'][$i]);
			}
			if($this->input['discountid'][$i]>0){
				if($this->input['discountKill'][$i]=='on'){
					$this->DB->query("UPDATE `discount` SET killer='".$this->user['userid']."', killed=".TIMENOW."  WHERE discountid='".$this->input['discountid'][$i]."'");
				}else{
					$this->DB->query("
						UPDATE `discount` SET
							`reason`='".$this->input['discountReason'][$i]."',
							`addition`='".$this->input['discountAddition'][$i]."',
							`discount`='".$this->input['discount'][$i]."',
							`sign`='".$this->input['discountSign'][$i]."',
							`remark`='".$this->input['discountRemark'][$i]."',
							`modified`='".TIMENOW."',
							`modifier`='".$this->user['userid']."'
						WHERE discountid='".$this->input['discountid'][$i]."'
					");
				}
			}elseif($this->input['discount'][$i]>=0 AND $this->input['discountReason'][$i]!=''){
				$this->DB->query("
					INSERT INTO `discount` (`module`, `mid`, `reason`,`addition`,`discount`,`sign`,`remark`,`modified`,`creator`,`created`)
					VALUES (
					'".$u['module']."', '".$u['mid']."', '".$this->input['discountReason'][$i]."', '".$this->input['discountAddition'][$i]."', '".$this->input['discount'][$i]."', '".$this->input['discountSign'][$i]."',  '".$this->input['discountRemark'][$i]."', '".TIMENOW."', '".$this->user['userid']."', '".TIMENOW."')
				");
			}
		}
		return true;
	}
	// 
	function updateMaterial($id=0){
		if($id>0){
      $this->DB->query("
        UPDATE material SET
          categoryid='".$this->input['categoryid']."',
          originid='".$this->input['originid']."',
          unitid='".$this->input['unitid']."',
          packingid='".$this->input['packingid']."',
          brandid='".$this->input['brandid']."',
					inventoryType='".$this->input['inventoryType']."',
          materialno='".$this->input['materialno']."',
          title='".$this->input['title']."',
          standard='".$this->input['standard']."',
          quantity='".$this->input['quantity']."',
          qualified='".$this->input['qualified']."',
          disqualified='".$this->input['disqualified']."',
          belowtolerance='".$this->input['belowtolerance']."',
          uptolerance='".$this->input['uptolerance']."',
          min='".$this->input['min']."',
          max='".$this->input['max']."',
          criticalNumber='".$this->input['criticalNumber']."',
          ifPerBarcode='".$this->input['ifPerBarcode']."',
          remark='".$this->input['remark']."',
          modified='".TIMENOW."',
          modifier='".$this->user['userid']."'
        WHERE killed=0 AND materialid='".$this->input['materialid']."'
      ");
			return $this->input['materialid'];
		}else{
			$this->DB->query("
        INSERT INTO material (categoryid,originid,unitid,packingid,brandid,inventoryType,materialno,title,standard,quantity,qualified,disqualified,uptolerance,belowtolerance,min,max,criticalNumber,ifPerBarcode,remark,created,creator)
        VALUES ('".$this->input['categoryid']."','".$this->input['originid']."','".$this->input['unitid']."','".$this->input['packingid']."','".$this->input['brandid']."','".$this->input['inventoryType']."','".$this->input['materialno']."','".$this->input['title']."','".$this->input['standard']."','".$this->input['quantity']."','".$this->input['qualified']."','".$this->input['disqualified']."','".$this->input['uptolerance']."','".$this->input['belowtolerance']."','".$this->input['min']."','".$this->input['max']."','".$this->input['criticalNumber']."','".$this->input['ifPerBarcode']."','".$this->input['remark']."','".TIMENOW."','".$this->user['userid']."')
      ");
			$materialid=$this->DB->insertID();
			$this->DB->query("
				INSERT INTO materialversion 
					(`materialid`,`title`,`quantity`,`qualified`,`disqualified`,`change`,`created`,`creator`)
				VALUES 
					('".$materialid."','".$this->input['version']."','".$this->input['quantity']."','".$this->input['qualified']."','".$this->input['disqualified']."','".$this->input['change']."','".TIMENOW."','".$this->user['userid']."')
			");
			return $materialid;
		}
	}
	function relatedBankDetail($r){
		if($r['supplierid']>0){
			$condition=' AND supplierid='.$r['supplierid'];
		}
		if($r['customerid']>0){
			$condition=' AND customerid='.$r['customerid'];
		}
		$bankDetails=$this->DB->query("
			SELECT bankDetailid,bankAccountName,bank,bankAccount 
			FROM bankdetail 
			WHERE killed=0 ".$condition." 
			ORDER BY ordering,bankDetailid ASC 
		");
		if($rtn['num']=$this->DB->numRows()){
			$rtn['panel']='<table class="hundred"><thead><tr><th width="250">户名</th><th width="500">开户行</th><th width="250">银行账号</th></tr></thead>';
			while($bankDetail=$this->DB->fetchArray($bankDetails)){
				$rtn['panel'].='<tr class="'.$this->iif($this->rotate(),'odd','even').'">
					<td>'.$bankDetail['bankAccountName'].'</td>
					<td>'.$bankDetail['bank'].'</td>
					<td>'.$bankDetail['bankAccount'].'</td>
				</tr>';
			}
			$rtn['panel'].='</table>';
			$rtn['count']='('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 客户
	function relatedCustomer($r){
		$client = $this->DB->queryFirst("SELECT * FROM `customer` WHERE customerid='".$r['id']."'");
		if($client){
			$rtn['link'] = '<a href="/s.php?module=customer&action=view&customerid='.$r['id'].'" target="_blank">'.$client['title'].'</a>';
$rtn['panel'] = <<<EOF
<table class="hundred">
<tr class="odd">
	<td width="80">英文名称：</td><td class="middle">{$rtn['link']}</td>
	<td width="80">简　　称：</td><td class="middle">{$client['abbr']}</td>
</tr>
<tr class="even">
	<td>中文名称：</td><td class="middle">{$client['cntitle']}</td>
	<td>商业类型：</td><td class="middle">{$client['business']}</td>
</tr>
<tr class="odd">
	<td>英文地址：</td><td class="middle">{$client['address']}</td>
	<td>国　　家：</td><td class="middle">{$region}</td>
</tr>
<tr class="even">
	<td>中文地址：</td><td class="middle">{$client['cnaddress']} {$postalcode}</td>
	<td>网　　站：</td><td class="middle">{$client['website']}</td>
</tr>
<tr class="odd">
	<td>主联系人：</td><td class="middle">{$client['linkman']} {$position}</td>
	<td>次联系人：</td><td class="middle">{$client['linkman2']} {$position2}</td>
</tr>
<tr class="even">
	<td>电　　话：</td><td class="middle">{$client['telephone']}</td>
	<td>邮　　箱：</td><td class="middle">{$client['email']}</td>
</tr>
<tr class="odd">
	<td>手　　机：</td><td class="middle">{$client['mobile']}</td>
	<td>传　　真：</td><td class="middle">{$client['fax']}</td>
</tr>
<tr class="even">
	<td valign="top">银行资料：</td><td>{$client['bankdetail']}</td>
	<td valign="top">备　　注：</td><td>{$client['remark']}</td>
</tr>
</table>
EOF;
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 供应商
	function relatedSupplier($r){
		$supplier = $this->DB->queryFirst("SELECT * FROM `supplier` WHERE supplierid='".$r['id']."'");
		if($supplier){
			$rtn['link'] = '<a href="/s.php?module=supplier&action=view&supplierid='.$r['id'].'" target="_blank">'.$supplier['title'].'</a>';
$rtn['panel'] = <<<EOF
<table class="hundred">
<tr class="odd">
	<td>中文名称：</td>
	<td class="middle">{$rtn['link']}</td>
	<td width="80">英文名称：</td>
	<td class="middle">{$supplier['entitle']}</td>
</tr>
<tr class="even">
	<td>简　　称：</td>
	<td class="middle">{$supplier['abbr']}</td>
	<td>商业类型：</td>
	<td class="middle">{$supplier['business']}</td>
</tr>
<tr class="odd">
	<td>中文地址：</td>
	<td class="middle">{$supplier['enaddress']} {$postalcode}</td>
	<td>国　　家：</td>
	<td class="middle">{$region}</td>
</tr>
<tr class="even">
	<td>英文地址：</td>
	<td class="middle">{$supplier['address']}</td>
	<td>网　　站：</td>
	<td class="middle">{$supplier['website']}</td>
</tr>
<tr class="odd">
	<td>主联系人：</td>
	<td class="middle">{$supplier['linkman']} {$position}</td>
	<td>次联系人：</td>
	<td class="middle">{$supplier['linkman2']} {$position2}</td>
</tr>
<tr class="even">
	<td>电　　话：</td>
	<td class="middle">{$supplier['telephone']}</td>
	<td>邮　　箱：</td>
	<td class="middle">{$supplier['email']}</td>
</tr>
<tr class="odd">
	<td>手　　机：</td>
	<td class="middle">{$supplier['mobile']}</td>
	<td>传　　真：</td>
	<td class="middle">{$supplier['fax']}</td>
</tr>
<tr class="even">
	<td valign="top">银行资料：</td>
	<td>{$supplier['bankdetail']}</td>
	<td valign="top">备　　注：</td>
	<td>{$supplier['remark']}</td>
</tr>
</table>
EOF;
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 产品
	function relatedProduct($r){
		$condition = "`product`.killed=0";
		if($r['productid']>0){
			$condition.=" AND INSTR(LCASE(sample.productid),'".(strtolower($r['productid']))."')>0";
		}
		if($r['categoryid']>0){
			$condition.=" AND `product`.categoryid='".$r['categoryid']."'";
		}
		if($r['attrid']>0){
			$condition.=" AND `product`.attrid='".$r['attrid']."'";
		}
		$products = $this->DB->query("
			SELECT `product`.productid, `product`.title, `product`.entitle, `product`.productno, `product`.cover, `product`.attachs, `product`.images, `product`.modified, `product`.created, `product`.killed,
				category.title AS categoryTitle,
				attr.title AS attr,
				m.username AS mname, c.username AS cname
			FROM `product`
			LEFT JOIN `category` ON (category.categoryid=product.categoryid)
			LEFT JOIN `attr` ON (attr.attrid=product.attrid)
			LEFT JOIN `user` AS m ON (m.userid=`product`.modifier)
			LEFT JOIN `user` AS c ON (c.userid=`product`.creator)
			WHERE ".$condition."
			ORDER BY `product`.productid ASC, `product`.modified DESC, `product`.created DESC
		");
		if($this->DB->numRows()){
			$rtn['panel'] = '<ul id="mmlist" class="mmlist clear">';
			$i=1;
			while($product = $this->DB->fetchArray($products)){
				$created = date('y-m-d H:m', $product['created']);
				$modified = date('Y-m-d H:m', $product['modified']);
				$rtn['panel'] .= '<li title="由 '.$product['creator'].' 建于 '.$created.$this->iif($product['modifier']!='', '，'.$product['modifier'].' 改于 '.$modified, '').'"'.$this->iif($i%3==0, ' class="end"', '').'>
				<div class="mmlistt">
					<span class="right normal"></span>
					<a href="/s.php?module=product&action=view&productid='.$product['productid'].'" target="_blank">'.$product['productno'].' <span class="normal">'.$product['title'].'</span></a><br><span class="small">'.$product['attr'].'</span> '.$this->iif($product['attachs']>0, ' <span class="attachFile" title="有'.$product['attachs'].'个附件。"></span> ', '').$this->iif($product['images']>0, ' <span class="attachImage" title="有'.$product['images'].'个图片。"></span> ', '').'<span class="normal">'.$product['entitle'].'</span></div>
				<div class="mmlistb">
					<div title="'.$product['categoryTitle'].'"><span class="small gray">类别：</span>'.$product['categoryTitle'].'</div>
					'.$this->iif($product['cover']!='', '<div class="center"><img src="'.$product['cover'].'"></div>', '').'
					<div class="small clear"><span class="right" title="由 '.$product['creator'].' 建于 '.$created.'">'.$this->iif($product['modifier']!='', '由 '.$product['modifier'].' 改于 ', '建于 ').$modified.'</span></div>
				</div>
				</li>';
				$i++;
			}
			$rtn['panel'] .= '</ul>';
			$rtn['num'] = '<span class="small">('.$rtn['num'].')</span>';
		}else{
			$rtn['disabled'] = ' disabled';
		}
		return $rtn;
	}
	// 样品
	function relatedSample($r){
		$condition = "`sample`.killed=0";
		if($r['productid']>0){
			$condition.=" AND INSTR(LCASE(sample.productid),'".(strtolower($r['productid']))."')>0";
		}
		if($r['customerid']>0){
			$condition.=" AND `sample`.customerid='".$r['customerid']."'";
		}
		if($r['supplierid']>0){
			$condition.=" AND `sample`.supplierid='".$r['supplierid']."'";
		}
		$samples = $this->DB->query("
			SELECT `sample`.sampleid, `sample`.title, `sample`.entitle, `sample`.typeid, `sample`.sampleno, `sample`.attachs, `sample`.cover, `sample`.images, `sample`.modified, `sample`.created, `sample`.killed,
				attr.title AS attr,
				m.username AS modifier, c.username AS creator
			FROM `sample`
			LEFT JOIN `attr` ON (attr.attrid=sample.attrid)
			LEFT JOIN `user` AS m ON (m.userid=`sample`.modifier)
			LEFT JOIN `user` AS c ON (c.userid=`sample`.creator)
			WHERE ".$condition."
			ORDER BY `sample`.sampleid ASC, `sample`.modified DESC, `sample`.created DESC
		");
		$rtn['num'] = $this->DB->numRows();
		if($rtn['num']){
			$rtn['panel'] = '<ul id="mmlist" class="mmlist clear">';
			$i=1;
			while($sample = $this->DB->fetchArray($samples)){
				$sampleType='';
				if($sample['typeid']!=''){
					$stypes = $this->DB->query("SELECT typeid, title FROM `sampletype` WHERE typeid IN (".$sample['typeid'].")");
					if($this->DB->numRows()){
						while($stype = $this->DB->fetchArray($stypes)){
							$sampleType .= '<span title="('.$stype['entitle'].') '.$stype['remark'].'" style="padding-right:12px">'.$stype['title'].'</span>';
						}
					}
				}
				$created = date('y-m-d H:m', $sample['created']);
				$modified = date('Y-m-d H:m', $sample['modified']);
				$rtn['panel'] .= '<li title="由 '.$sample['creator'].' 建于 '.$created.$this->iif($sample['modifier']!='', '，'.$sample['modifier'].' 改于 '.$modified, '').'"'.$this->iif($i%3==0, ' class="end"', '').'>
				<div class="mmlistt">
					<span class="right normal">';
				if($sample['killed']>0){
					$rtn['panel'] .= '<a href="/s.php?module=sample&action=restore&sampleid='.$sample['sampleid'].'&rt=list">恢复</a>';
				}else{
					$rtn['panel'] .= '<a href="/s.php?module=sample&action=kill&sampleid='.$sample['sampleid'].'&rt=list" onclick="return confirm(\'你确定要删除这个样品 '.$sample['title'].' 吗？\');">删</a> <a href="/s.php?module=sample&action=update&sampleid='.$sample['sampleid'].'&rt=list">改</a>';
				}
				$rtn['panel'] .= '</span>
					<span class="small">'.$sample['attr'].'</span> <a href="/s.php?module=sample&action=view&sampleid='.$sample['sampleid'].'">'.$sample['title'].'</a><br>'.$this->iif($sample['attachs']>0, ' <span class="attachFile" title="有'.$sample['attachs'].'个附件。"></span> ', '').$this->iif($sample['images']>0, ' <span class="attachImage" title="有'.$sample['images'].'个图片。"></span> ', '').$this->iif($sample['entitle']!='', '<span class="small">'.$sample['entitle'].'</span>', '').'</div>
				<div class="mmlistb">
					<div><span class="small">类型：</span>'.$sampleType.'</div>'.$this->iif($sample['cover']!='', '<div class="center"><img src="'.$sample['cover'].'"></div>', '').'
					<div class="small clear"><span class="right" title="由 '.$sample['creator'].' 建于 '.date('y-m-d H:m', $sample['created']).'">'.$this->iif($sample['modifier']!='', '由 最后'.$sample['modifier'].' 改于 ', '建于 ').date('Y-m-d H:m', $sample['modified']).'</span></div>
				</div>
				</li>';
				$i++;
			}
			$rtn['panel'] .= '</ul>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 生产供应商样品明细
	function relatedPSampleItem($o){
		$items = $this->DB->query("
			SELECT item.*,
				material.title AS material,
				brand.title AS brand,
				packing.title AS packing,
				unit.title AS unit
			FROM `item`
			LEFT JOIN `material` ON (`material`.materialid=item.materialid)
			LEFT JOIN packing ON (packing.packingid=item.packingid)
			LEFT JOIN brand ON (brand.brandid=item.brandid)
			LEFT JOIN unit ON (unit.unitid=item.unitid)
			WHERE `item`.killed=0 AND module='sample' AND mid='".$o['sampleid']."'
			ORDER BY `item`.ordering, `item`.modified ASC, `item`.itemid ASC
		");
		if($this->DB->numRows()){
			$k=1;
			while($item = $this->DB->fetchArray($items)){
				$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'"><td class="small">'.$item['materialTitle'].'</td><td align="center">'.$item['materialStandard'].'</td>	
				<td>'.$item['supplierNo'].'</td>
				<td>'.$item['customerNo'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td>'.$item['remark'].'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td>
				</tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$rtn['total'] = $total;
			$total=number_format($total, 2);
$rtn['tr']= <<<EOF
		{$itemtr}
		<tr><td colspan="6" align="right">合计：</td><td align="right">{$quantity}</td><td></td><td align="right" class="middle bold">{$total}</td></tr>
EOF;
		}
		return $rtn;
	}
	// 样品明细
	function relatedSampleItem($o){
		$items = $this->DB->query("
			SELECT item.*,
				product.title AS product,
				brand.title AS brand,
				packing.title AS packing,
				unit.title AS unit
			FROM `item`
			LEFT JOIN `product` ON (product.productid=item.productid)
			LEFT JOIN packing ON (packing.packingid=item.packingid)
			LEFT JOIN brand ON (brand.brandid=item.brandid)
			LEFT JOIN unit ON (unit.unitid=item.unitid)
			WHERE `item`.killed=0 AND module='sample' AND mid='".$o['sampleid']."'
			AND `item`.productid='0' ORDER BY `item`.ordering, `item`.modified ASC, `item`.itemid ASC
		");
		if($this->DB->numRows()){
			$k=1;
			while($item = $this->DB->fetchArray($items)){
				$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'"><td class="small">'.$item['title'].'</td><td>'.$item['model'].'</td>
				<td>'.$item['caption'].'</td>
				<td>'.$item['supplierNo'].'</td>
				<td>'.$item['customerNo'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td>
				</tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$rtn['total'] = $total;
			$total=number_format($total, 2);
$rtn['tr']= <<<EOF
		{$itemtr}
		<tr><td colspan="6" align="right">合计：</td><td align="right">{$quantity}</td><td></td><td align="right" class="middle bold">{$total}</td></tr>
EOF;
		}
		return $rtn;
	}
	
	// 样品明细
	function relatedPrintSampleItem($o){
		$items = $this->DB->query("
			SELECT item.*,
				product.entitle AS product,
				brand.title AS brand,
				packing.entitle AS packing,
				unit.entitle AS unit
			FROM `item`
			LEFT JOIN `product` ON (product.productid=item.productid)
			LEFT JOIN packing ON (packing.packingid=item.packingid)
			LEFT JOIN brand ON (brand.brandid=item.brandid)
			LEFT JOIN unit ON (unit.unitid=item.unitid)
			WHERE `item`.killed=0 AND module='sample' AND mid='".$o['sampleid']."'
			AND `item`.productid='0' ORDER BY `item`.ordering, `item`.modified ASC, `item`.itemid ASC
		");
		if($this->DB->numRows()){
			$k=1;
			$itemtr ='<tr><td>Samples</td><td>Model</td><td>Special Note</td><td>Supplier Code</td><td>Customer Code</td><td align="right">Discount</td><td align="right">Quantity</td><td align="right">Price</td><td align="right">Subtotal</td></tr>';
			while($item = $this->DB->fetchArray($items)){
				$itemtr .= '<tr class="odd"><td class="small">'.$item['title'].'</td><td>'.$item['model'].'</td>
				<td>'.$item['caption'].'</td>
				<td>'.$item['supplierNo'].'</td>
				<td>'.$item['customerNo'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td>
				</tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$rtn['total'] = $total;
			$total=number_format($total, 2);
			$rtn['tr']= <<<EOF
		{$itemtr}
		<tr><td colspan="6" align="right">Subtotal：</td><td align="right">{$quantity}</td><td></td><td align="right" class="middle bold">{$total}</td></tr>
EOF;
		}
		return $rtn;
	}
	
	// 样品里产品明细
	function relatedSampleProductItem($o){
		$items = $this->DB->query("
				SELECT item.*,
					product.title AS product,
					brand.title AS brand,
					packing.title AS packing,
					unit.title AS unit
				FROM `item`
				LEFT JOIN `product` ON (product.productid=item.productid)
				LEFT JOIN packing ON (packing.packingid=item.packingid)
				LEFT JOIN brand ON (brand.brandid=item.brandid)
				LEFT JOIN unit ON (unit.unitid=item.unitid)
				WHERE `item`.killed=0 AND module='sample' AND mid='".$o['sampleid']."'
				AND `item`.productid>0 ORDER BY `item`.ordering, `item`.modified ASC, `item`.itemid ASC
		");
		if($this->DB->numRows()){
			$k=1;
			while($item = $this->DB->fetchArray($items)){
				
				$selectStr = '';
				if(!empty($item['productAttributes'])){
					$nameStr = explode("#",$item['productAttributes']);
					$valueStr = explode(",",$nameStr[1]);
					array_pop($valueStr);
					$attributes=$this->DB->query("
						SELECT an.nameid,an.title AS name,
							av.valueid,av.title AS value
						FROM  attributename AS an
						LEFT JOIN attributevalue AS av ON (av.nameid=an.nameid)
						WHERE an.killed=0 AND av.killed=0 AND an.module='product' AND an.mid='".$nameStr[0]."'
						ORDER BY an.ordering ASC
					");
					$nameId=$title=$value=$attributeCount=array();
					if($this->DB->numRows()){
						while($attribute=$this->DB->fetchArray($attributes)){
							if(in_array($attribute['nameid'],$nameId)){
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]++;
							}else{
								$nameId[]=$attribute['nameid'];
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]=1;
							}
						}
					}
					foreach ($nameId as $key=>$val){
						$selectStr .= ''.$title[$val].'：';
						for($n=0;$n<count($value[$val]);$n++){
							if($valueId[$val][$n]==$valueStr[$key]){
								$selectStr .= '<span class="darkred">'.$value[$val][$n].'</span>';
							}
						}
						$selectStr .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
					}
				}else{
					$selectStr .= '此产品或配件没有属性';
				}
				$itemtr .= '<tr class="odd">
				<td><a href="/s.php?module=product&action=view&productid='.$item['productid'].'" target="_blank">'.$item['product'].'</a></td>
				<td>'.$selectStr.'</td>
				<td>'.$item['caption'].'</td>
				<td>'.$item['brand'].'</td>
				<td>'.$item['packing'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td></tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$rtn['total'] = $total;
			$total=number_format($total, 2);
			$rtn['tr']= <<<EOF
		{$itemtr}
		<tr><td colspan="6" align="right">合计：</td><td align="right">{$quantity}</td><td></td><td align="right" class="middle bold">{$total}</td></tr>
EOF;
		}
		return $rtn;
	}
	
	// 样品里产品明细
	function relatedPrintSampleProductItem($o){
		$items = $this->DB->query("
				SELECT item.*,
					product.entitle AS product,
					brand.title AS brand,
					packing.entitle AS packing,
					unit.entitle AS unit
				FROM `item`
				LEFT JOIN `product` ON (product.productid=item.productid)
				LEFT JOIN packing ON (packing.packingid=item.packingid)
				LEFT JOIN brand ON (brand.brandid=item.brandid)
				LEFT JOIN unit ON (unit.unitid=item.unitid)
				WHERE `item`.killed=0 AND module='sample' AND mid='".$o['sampleid']."'
				AND `item`.productid>0 ORDER BY `item`.ordering, `item`.modified ASC, `item`.itemid ASC
		");
		if($this->DB->numRows()){
			$k=1;
			$itemtr='<tr><td width="100">Samples</td><td>Description of Samples</td><td  width="150">Special Note</td><td  width="100">Brand</td><td  width="50">Packaging</td><td  width="45">Discount</td><td width="30">Quantity</td><td  align="right" width="50">Price</td><td width="50">Subtotal</td></tr>';
			while($item = $this->DB->fetchArray($items)){
	
				$selectStr = '';
				if(!empty($item['productAttributes'])){
					$nameStr = explode("#",$item['productAttributes']);
					$valueStr = explode(",",$nameStr[1]);
					array_pop($valueStr);
					$attributes=$this->DB->query("
						SELECT an.nameid,an.entitle AS name,
							av.valueid,av.entitle AS value
						FROM  attributename AS an
						LEFT JOIN attributevalue AS av ON (av.nameid=an.nameid)
						WHERE an.killed=0 AND av.killed=0 AND an.module='product' AND an.mid='".$nameStr[0]."'
						ORDER BY an.ordering ASC
					");
					$nameId=$title=$value=$attributeCount=array();
					if($this->DB->numRows()){
						while($attribute=$this->DB->fetchArray($attributes)){
							if(in_array($attribute['nameid'],$nameId)){
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]++;
							}else{
								$nameId[]=$attribute['nameid'];
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]=1;
							}
						}
					}
					foreach ($nameId as $key=>$val){
						$selectStr .= ''.$title[$val].'：';
						for($n=0;$n<count($value[$val]);$n++){
							if($valueId[$val][$n]==$valueStr[$key]){
								$selectStr .= '<span class="darkred">'.$value[$val][$n].'</span>';
							}
						}
						$selectStr .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
					}
				}else{
					$selectStr .= '此产品或配件没有属性';
				}
				$itemtr .= '<tr class="odd">
				<td>'.$item['product'].'</td>
				<td>'.$selectStr.'</td>
				<td>'.$item['caption'].'</td>
				<td>'.$item['brand'].'</td>
				<td>'.$item['packing'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td></tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$rtn['total'] = $total;
			$total=number_format($total, 2);
			$rtn['tr']= <<<EOF
		{$itemtr}
		<tr><td colspan="6" align="right">合计：</td><td align="right">{$quantity}</td><td></td><td align="right" class="middle bold">{$total}</td></tr>
EOF;
		}
		return $rtn;
	}
	// 
	function relatedPurchase($r){
		if($r['materialid']>0){
			$items=$this->DB->query("SELECT DISTINCT `purchaseid` FROM `purchaseitem` WHERE killed=0 AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item = $this->DB->fetchArray($items)){
					$id[] = $item['purchaseid'];
				}
				$condition.=" AND `purchase`.purchaseid IN (".implode(',', $id).")";
			}else{
				$condition.=" AND `purchase`.purchaseid=0";
			}
		}
		if($r['porderid']>0){
			$items=$this->DB->query("SELECT DISTINCT `purchaseid` FROM `item` WHERE killed=0 AND module='porder' AND mid='".$r['porderid']."'");
			if($this->DB->numRows()){
				while($item = $this->DB->fetchArray($items)){
					$id[] = $item['purchaseid'];
				}
				$condition.=" AND `purchase`.purchaseid IN (".implode(',', $id).")";
			}else{
				$condition.=" AND `purchase`.v=0";
			}
		}
		if($r['orderby'] == ''){
			$r['orderby'] = '`purchase`.modified';
		}
		if($r['direction'] == ''){
			$r['direction'] = 'DESC';
		}
		if($r['limit'] == ''){
			$r['limit'] = '0, 100';
		}
		$purchases=$this->DB->query("
			SELECT `purchase`.purchaseid,`purchase`.purchaseno,`purchase`.applicant,
					`purchase`.amount,`purchase`.ifVerify,`purchase`.modified,`purchase`.created,`purchase`.killed,
				c.title AS currency,
				u.username AS creator,
				us.username AS modifier
			FROM `purchase` 
			LEFT JOIN currency AS c ON (c.currencyid=`purchase`.currencyid)
			LEFT JOIN user AS u ON (u.userid=`purchase`.creator)
			LEFT JOIN user AS us ON (us.userid=`purchase`.modifier)
			WHERE `purchase`.killed=0 ".$condition."
			ORDER BY ".$r['orderby'].' '.$r['direction']." 
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$rtn['panel']='<ul class="mmlist clear" id="mmlist">';
			$i=1;
			while($purchase=$this->DB->fetchArray($purchases)){
				$purchase['created']=date('Y-m-d',$purchase['created']);
					$verify=$this->verify($purchase['ifVerify']);
					$rtn['panel'].='<li title="由 '.$purchase['creator'].' 建于 '.$created.$this->iif($purchase['modifier']!='', '，'.$purchase['modifier'].' 改于 '.date('Y-m-d H:i',$purchase['modified']), '').'"'.$this->iif($i%4==0, ' class="end"', '').'>
					<div class="mmlistt">
						<span class="right normal">';
					if($purchase['killed']>0){
						$rtn['panel'].='<a href="/s.php?module=purchase&action=revival&purchaseid='.$purchase['purchaseid'].'&rt=list" onclick="return confirm(\'你确定要恢复这个采购计划单 '.$purchase['purchaseno'].' 吗？\');">恢复</a>';
					}else{
						$rtn['panel'].='<a href="/s.php?module=purchase&action=kill&purchaseid='.$purchase['purchaseid'].'&rt=list" onclick="return confirm(\'你确定要删除这个采购计划单 '.$purchase['purchaseno'].' 吗？\');">删</a> '.$this->iif($purchase['ifVerify']==0,'<a href="/s.php?module=purchase&action=update&purchaseid='.$purchase['purchaseid'].'&rt=list">改</a>','');
					}
					$rtn['panel'].='</span>
					<span class="small">'.$purchase['attr'].'</span> <a href="/s.php?module=purchase&action=view&purchaseid='.$purchase['purchaseid'].'">'.$purchase['purchaseno'].'</a><br><span class="small gray right">'.$purchase['created'].'</span>'.$this->iif($purchase['attachs']>0, ' <span class="attachFile" title="有'.$purchase['attachs'].'个附件。"></span> ', '').$this->iif($purchase['images']>0, ' <span class="attachImage" title="有'.$purchase['images'].'个图片。"></span> ', '').''.$verify.'</div>
				<div class="mmlistb">
					<div><span class="small gray">采购员：'.$purchase['applicant'].'</span></div>
					<div class="small clear"><span class=right title="由 '.$prchase['creator'].' 建于 '.$purchase['created'].'">建于 '.$purchase['created'].'</span></div></div></li>';
					$i++;
			}
			$rtn['panel'].='</ul>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}

		return $rtn;
	}
	// 
	function relatedPurchaseApply($r){
		if($r['materialid']>0){
			$items = $this->DB->query("SELECT DISTINCT `mid` FROM `preinbounditem` WHERE killed=0 AND module='purchaseApply' AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item = $this->DB->fetchArray($items)){
					$id[] = $item['mid'];
				}
				$condition.=" AND `purchaseapply`.purchaseApplyid IN (".implode(',', $id).")";
			}else{
				$condition.=" AND `purchaseapply`.purchaseApplyid=0";
			}
		}
		if($r['purchaseid']>0){
			$items = $this->DB->query("SELECT DISTINCT `mid` FROM `purchaseitem` WHERE killed=0 AND module='purchaseApply' AND purchaseid='".$r['purchaseid']."'");
			if($this->DB->numRows()){
				while($item = $this->DB->fetchArray($items)){
					$id[] = $item['mid'];
				}
				$condition.=" AND `purchaseapply`.purchaseApplyid IN (".implode(',', $id).")";
			}else{
				$condition.=" AND `purchaseapply`.purchaseApplyid=0";
			}
		}
		if($r['orderby'] == ''){
			$r['orderby'] = '`purchaseapply`.modified';
		}
		if($r['direction'] == ''){
			$r['direction'] = 'DESC';
		}
		if($r['limit'] == ''){
			$r['limit'] = '0, 100';
		}
		$applys=$this->DB->query("
			SELECT `purchaseapply`.purchaseApplyid,`purchaseapply`.typeid,`purchaseapply`.applyno,`purchaseapply`.applicant,
					`purchaseapply`.ifVerify,`purchaseapply`.modified,`purchaseapply`.created,`purchaseapply`.killed,
				d.title AS department,
				u.username AS creator,
				us.username AS modifier
			FROM `purchaseapply` 
			LEFT JOIN department AS d ON (d.departmentid=`purchaseapply`.departmentid)
			LEFT JOIN user AS u ON (u.userid=`purchaseapply`.creator)
			LEFT JOIN user AS us ON (us.userid=`purchaseapply`.modifier)
			WHERE `purchaseapply`.killed=0".$condition."
			ORDER BY ".$r['orderby'].' '.$r['direction']." 
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$rtn['panel']='<ul class="mmlist clear" id="mmlist">';
			$i=1;
			while($apply=$this->DB->fetchArray($applys)){
				$typeValue='';
				$types=$this->DB->query("SELECT title FROM purchasetype WHERE killed=0 AND typeid IN (".$apply['typeid'].")");
				if($counter=$this->DB->numRows()){
					$i=1;
					while($type=$this->DB->fetchArray($types)){
						if($i<$counter){
							$typeValue.=$type['title'].'、';
						}else{
							$typeValue.=$type['title'];
						}
						$i++;
					}
				}
				$apply['created']=date('Y-m-d',$apply['created']);
				$verify=$this->verify($apply['ifVerify']);
				$rtn['panel'].='<li title="由 '.$apply['creator'].' 建于 '.$apply['created'].$this->iif($apply['modifier']!='','，'.$apply['modifier'].' 改于 '.date('Y-m-d H:i',$apply['modified']),'').'"'.$this->iif($i%4==0, ' class="end"', '').'>
				<div class="mmlistt">
				<a href="/s.php?module=purchaseApply&action=view&purchaseApplyid='.$apply['purchaseApplyid'].'">'.$apply['applyno'].'</a><br><span class="small gray right">'.$apply['created'].'</span>'.$this->iif($apply['attachs']>0, ' <span class="attachFile" title="有'.$apply['attachs'].'个附件。"></span> ', '').$this->iif($apply['images']>0, ' <span class="attachImage" title="有'.$apply['images'].'个图片。"></span> ', '').$verify.'</div>
			<div class="mmlistb"><div><span class="small gray">申请人：</span>'.$apply['applicant'].'</div>
				<div><span class="small gray">申请部门：</span>'.$apply['department'].'</div>
				<div><span class="small gray">采购类型：</span>'.$typeValue.'</div>
				<div class="small clear"><span class=right title="由 '.$apply['creator'].' 建于 '.$apply['created'].'">由 '.$apply['creator'].' 建于 '.$apply['created'].'</span></div></div></li>';
				$i++;
			}
			$rtn['panel'].='</ul>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}

		return $rtn;
	}
	// 
	function relatedEntrust($r){
		if($r['materialid']>0){
			$items = $this->DB->query("SELECT DISTINCT `mid` FROM `entrustitem` WHERE killed=0 AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item = $this->DB->fetchArray($items)){
					$id[] = $item['mid'];
				}
				$condition.=" AND `entrust`.entrustid IN (".implode(',', $id).")";
			}else{
				$condition.=" AND `entrust`.entrustid=0";
			}
		}
		if($r['purchaseid']>0){
			$items = $this->DB->query("SELECT DISTINCT `mid` FROM `purchaseitem` WHERE killed=0 AND purchaseid='".$r['purchaseid']."'");
			if($this->DB->numRows()){
				while($item = $this->DB->fetchArray($items)){
					$id[] = $item['mid'];
				}
				$condition.=" AND `entrust`.entrustid IN (".implode(',', $id).")";
			}else{
				$condition.=" AND `entrust`.entrustid=0";
			}
		}
		if($r['orderby'] == ''){
			$r['orderby'] = '`entrust`.modified';
		}
		if($r['direction'] == ''){
			$r['direction'] = 'DESC';
		}
		if($r['limit'] == ''){
			$r['limit'] = '0, 100';
		}
		$entrusts=$this->DB->query("
			SELECT `entrust`.entrustid,`entrust`.entrustno,`entrust`.applicant,`entrust`.applied,
					`entrust`.ifVerify,`entrust`.modified,`entrust`.created,`entrust`.killed,
				u.username AS creator,
				us.username AS modifier
			FROM entrust 
			LEFT JOIN user AS u ON (u.userid=`entrust`.creator)
			LEFT JOIN user AS us ON (us.userid=`entrust`.modifier)
			WHERE `entrust`.killed=0".$condition."
			ORDER BY ".$r['orderby'].' '.$r['direction']." 
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$rtn['panel']='<ul class="mmlist clear" id="mmlist">';
			$i=1;
			while($entrust=$this->DB->fetchArray($entrusts)){
				$entrust['created']=date('Y-m-d',$entrust['created']);
				$verify=$this->verify($entrust['ifVerify']);
				$rtn['panel'].='<li title="由 '.$entrust['creator'].' 建于 '.$entrust['created'].$this->iif($entrust['modifier']!='','，'.$entrust['modifier'].' 改于 '.date('Y-m-d H:i',$entrust['modified']),'').'"'.$this->iif($i%4==0, ' class="end"', '').'>
				<div class="mmlistt">
				<a href="/s.php?module=entrust&action=view&entrustid='.$entrust['entrustid'].'">'.$entrust['entrustno'].'</a><br><span class="small gray right">'.$entrust['created'].'</span>'.$this->iif($entrust['attachs']>0, ' <span class="attachFile" title="有'.$entrust['attachs'].'个附件。"></span> ', '').$this->iif($entrust['images']>0, ' <span class="attachImage" title="有'.$entrust['images'].'个图片。"></span> ', '').''.$verify.'</div>
			<div class="mmlistb">
				<div><span class="small gray">申请人：'.$entrust['applicant'].'</span></div>
				<div><span class="small gray">申请时间：'.date('Y-m-d',$entrust['applied']).'</span></div>
				<div class="small clear"><span class=right title="由 '.$entrust['creator'].' 建于 '.$entrust['created'].'">建于 '.$entrust['created'].'</span></div></div></li>';
				$i++;
			}
			$rtn['panel'].='</ul>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}

		return $rtn;
	}
	// 询价
	function relatedInquiry($r){
		if($r['productid']>0){
			$items = $this->DB->query("SELECT DISTINCT mid FROM `item` WHERE module='inquiry' AND productid='".$r['productid']."'");
			if($this->DB->numRows()){
				while($item = $this->DB->fetchArray($items)){
					$id[] = $item['inquiryid'];
				}
				if(is_Array($id)){
					$r['condition'] .= " AND `inquiry`.inquiryid IN (".implode(',',$id).")";
				}
			}else{
				return array('num'=>0, 'panel'=>'');
			}
		}
		if($r['customerid']>0){
			$r['condition'] .= " AND `inquiry`.customerid='".$r['customerid']."'";
			$options = '<a href="/s.php?module=customer&action=removeInquiry&inquiryid='.$inquiry['inquiryid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=customer&action=updateInquiry&inquiryid='.$inquiry['inquiryid'].'">修改</a>　<a href="/p.php?action=customerInquiry&inquiryid='.$inquiry['inquiryid'].'" target="_blank">打印</a>　<a href="/s.php?module=customer&action=addQuoting&customerid='.$inquiry['customerid'].'&inquiryid='.$inquiry['inquiryid'].'">回复</a>';
		}
		if($r['supplierid']>0){
			$r['condition'] .= " AND `inquiry`.supplierid='".$r['supplierid']."'";
			$options = '<a href="/s.php?module=supplier&action=removeInquiry&inquiryid='.$inquiry['inquiryid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=supplier&action=updateInquiry&inquiryid='.$inquiry['inquiryid'].'">修改</a>　<a href="/p.php?action=supplierInquiry&inquiryid='.$inquiry['inquiryid'].'" target="_blank">打印</a>　<a href="/s.php?module=supplier&action=addQuoting&supplierid='.$inquiry['supplierid'].'&inquiryid='.$inquiry['inquiryid'].'">回复</a>';
		}
		if($r['orderby'] == ''){
			$r['orderby'] = '`inquiry`.modified';
		}
		if($r['direction'] == ''){
			$r['direction'] = 'DESC';
		}
		if($r['limit'] == ''){
			$r['limit'] = '0, 100';
		}
		$inquirys=$this->DB->query("
			SELECT inquiry.*,
				supplier.title AS supplier,
				customer.title AS customer,
				shipmethod.title AS shipmethod,
				port.title AS port,
				paymentterm.title AS paymentterm,
				deliveryterm.title AS deliveryterm,
				currency.title AS currency
			FROM `inquiry`
			LEFT JOIN supplier ON (supplier.supplierid=`inquiry`.supplierid)
			LEFT JOIN customer ON (customer.customerid=`inquiry`.customerid)
			LEFT JOIN currency ON (currency.currencyid=`inquiry`.currencyid)
			LEFT JOIN shipmethod ON (shipmethod.shipmethodid=`inquiry`.shipmethodid)
			LEFT JOIN port ON (port.portid=`inquiry`.portid)
			LEFT JOIN paymentterm ON (paymentterm.paymenttermid=`inquiry`.paymenttermid)
			LEFT JOIN deliveryterm ON (deliveryterm.deliverytermid=`inquiry`.deliverytermid)
			WHERE `inquiry`.killed=0".$r['condition']."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num'] = $this->DB->numRows();
		if($rtn['num']){
			while($inquiry = $this->DB->fetchArray($inquirys)){
				if($inquiry['quotingid']>0 AND $inquiry['replied']>0){
					$reply='最后回复时间：'.date('Y-m-d H:i:s', $inquiry['replied']);
					$replyLink='<a href="javascript:nextTabs();" title="查看已经回复的报价单"><span class="small">('.$inquiry['replyTimes'].')</span></a>';
				}else{
					$reply='';
					$replyLink='<span class="small">('.$inquiry['replyTimes'].')</span>';
				}
				if($inquiry['customerid']>0){
					$options = '<a href="/s.php?module=customer&action=removeInquiry&inquiryid='.$inquiry['inquiryid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=customer&action=updateInquiry&inquiryid='.$inquiry['inquiryid'].'">修改</a>　<a href="/p.php?action=customerInquiry&inquiryid='.$inquiry['inquiryid'].'" target="_blank">打印</a>　<a href="/s.php?module=customer&action=addQuoting&customerid='.$inquiry['customerid'].'&inquiryid='.$inquiry['inquiryid'].'" title="'.$reply.'">回复</a>'.$replyLink;
				}
				if($inquiry['supplierid']>0){
					$options = '<a href="/s.php?module=supplier&action=removeInquiry&inquiryid='.$inquiry['inquiryid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=supplier&action=updateInquiry&inquiryid='.$inquiry['inquiryid'].'">修改</a>　<a href="/p.php?action=supplierInquiry&inquiryid='.$inquiry['inquiryid'].'" target="_blank">打印</a>　<a href="/s.php?module=supplier&action=addQuoting&supplierid='.$inquiry['supplierid'].'&inquiryid='.$inquiry['inquiryid'].'" title="'.$reply.'"><span class="small">供应商</span>回复</a>'.$replyLink;
				}
				$items = $this->DB->query("
					SELECT `item`.*,
						product.title AS product,
						packing.title AS packing,
						unit.title AS unit
					FROM `item`
					LEFT JOIN product ON (product.productid=`item`.productid)
					LEFT JOIN packing ON (packing.packingid=`item`.packingid)
					LEFT JOIN unit ON (unit.unitid=`item`.unitid)
					WHERE `item`.module='inquiry' AND mid='".$inquiry['inquiryid']."'
					ORDER BY `item`.itemid ASC
				");
				$itemtr='';
				if($itemNum=$this->DB->numRows()){
					$itemtr = '<tr><td colspan="8"><table><thead><tr><th>询价产品</th><th>产品特有属性</th><th>说明</th><th>包装</th><th>折扣</th><th>数量</th></tr></thead><tbody>';
					while($item = $this->DB->fetchArray($items)){
						
						
						$selectStr = '';
						if(!empty($item['productAttributes'])){
							$nameStr = explode("#",$item['productAttributes']);
							$valueStr = explode(",",$nameStr[1]);
							array_pop($valueStr);
							$attributes=$this->DB->query("
								SELECT an.nameid,an.title AS name,
									av.valueid,av.title AS value
								FROM  attributename AS an
								LEFT JOIN attributevalue AS av ON (av.nameid=an.nameid)
								WHERE an.killed=0 AND av.killed=0 AND an.module='product' AND an.mid='".$nameStr[0]."'
								ORDER BY an.ordering ASC
							");
									$nameId=$title=$value=$attributeCount=array();
									if($this->DB->numRows()){
										while($attribute=$this->DB->fetchArray($attributes)){
											if(in_array($attribute['nameid'],$nameId)){
												$title[$attribute['nameid']]=$attribute['name'];
												$value[$attribute['nameid']][]=$attribute['value'];
												$valueId[$attribute['nameid']][]=$attribute['valueid'];
												$attributeCount[$attribute['nameid']]++;
											}else{
												$nameId[]=$attribute['nameid'];
												$title[$attribute['nameid']]=$attribute['name'];
												$value[$attribute['nameid']][]=$attribute['value'];
												$valueId[$attribute['nameid']][]=$attribute['valueid'];
												$attributeCount[$attribute['nameid']]=1;
											}
										}
									}
									foreach ($nameId as $key=>$val){
										$selectStr .= ''.$title[$val].'：';
										for($n=0;$n<count($value[$val]);$n++){
											if($valueId[$val][$n]==$valueStr[$key]){
												$selectStr .= '<span class="darkred">'.$value[$val][$n].'</span>';
											}
										}
										$selectStr .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
									}
								}else{
									$selectStr .= '此产品或配件没有属性';
								}
								
						$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
						<td><a href="/s.php?module=product&action=view&productid='.$item['productid'].'" target="_blank">'.$item['product'].'</a></td>
						<td>'.$selectStr.'</td>
						<td>'.$item['caption'].'</td>
						<td>'.$item['packing'].'</td>
						<td>'.$item['discount'].'</td>
						<td>'.$item['quantity'].' '.$item['unit'].'</td>
						</tr>';
					}
					$itemtr .= '</tbody></table></td></tr>';
				}
				$title = '';
				if($inquiry['currency']!='')$title .= '　<span class="small">币种：</span>'.$inquiry['currency'];
				if($inquiry['paymentterm']!='')$title .= '　<span class="small">支付条款：</span>'.$inquiry['paymentterm'];
				if($inquiry['shipmethod']!='')$title .= '　<span class="small">运送方式：</span>'.$inquiry['shipmethod'];
				if($inquiry['port']!='')$title .= '　<span class="small">交货地点：</span>'.$inquiry['port'];
				if($inquiry['deliveryterm']!='')$title .= '　<span class="small">交货条款：</span>'.$inquiry['deliveryterm'];
$rtn['panel'] .= <<<EOF
<table class="hundred">
<thead>
<tr><th colspan="8"><span class="right">{$options} <span class="plus" onclick="dc.showInquiry('inquiry{$inquiry['inquiryid']}')"></span></span>	<span class="normal">[<b>{$itemNum}</b>]</span> <span class="small">联系人：</span><span class="middle bold">{$inquiry['contact']}</span>{$title}</th></tr>
</thead>
<tbody id="inquiry{$inquiry['inquiryid']}" style="display:none">
<tr class="odd">
	<td width="80">运送方式：</td><td class="middle">{$inquiry['shipmethod']}</td>
	<td width="80">交货地点：</td><td class="middle">{$inquiry['port']}</td>
	<td width="80">支付条款：</td><td class="middle">{$inquiry['paymentterm']}</td>
	<td width="80">交货条款：</td><td class="middle">{$inquiry['deliveryterm']}</td>
</tr>
<tr class="even">
	<td>规格说明：</td><td class="middle">{$inquiry['standrad']}</td>
	<td>主要材料：</td><td class="middle">{$inquiry['material']}</td>
	<td>工艺说明：</td><td class="middle">{$inquiry['technics']}</td>
	<td>备　　注：</td><td class="middle">{$inquiry['remark']}</td>
</tr>
{$itemtr}
</tbody>
</table>
EOF;
			}
			$rtn['panel'] .= '</tbody></table>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 报价
	function relatedQuoting($r){
		if($r['productid']>0){
			$items = $this->DB->query("SELECT DISTINCT mid FROM `item` WHERE module='quoting' AND productid='".$r['productid']."'");
			if($this->DB->numRows()){
				while($item = $this->DB->fetchArray($items)){
					$id[] = $item['mid'];
				}
				if(is_Array($id)){
					$r['condition'] .= " AND `quoting`.quotingid IN (".implode(',',$id).")";
				}
			}else{
				return array('num'=>0, 'panel'=>'');
			}
		}
		if($r['customerid']>0){
			$r['condition'] .= " AND `quoting`.customerid='".$r['customerid']."'";
			//$options = '<a href="/s.php?module=customer&action=removeQuoting&quotingid='.$quoting['quotingid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=customer&action=updateQuoting&quotingid='.$quoting['quotingid'].'">修改</a>　<a href="/p.php?action=customerQuoting&quotingid='.$quoting['quotingid'].'" target="_blank">打印</a>　<a href="/s.php?module=customer&action=addQuoting&customerid='.$quoting['customerid'].'&quotingid='.$quoting['quotingid'].'">回复</a>';
		}
		if($r['supplierid']>0){
			$r['condition'] .= " AND `quoting`.supplierid='".$r['supplierid']."'";
			//$options = '<a href="/s.php?module=supplier&action=removeQuoting&quotingid='.$quoting['quotingid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=supplier&action=updateQuoting&quotingid='.$quoting['quotingid'].'">修改</a>　<a href="/p.php?action=supplierQuoting&quotingid='.$quoting['quotingid'].'" target="_blank">打印</a>　<a href="/s.php?module=supplier&action=addQuoting&supplierid='.$quoting['supplierid'].'&quotingid='.$quoting['quotingid'].'">回复</a>';
		}
		if($r['orderby'] == ''){
			$r['orderby'] = '`quoting`.modified';
		}
		if($r['direction'] == ''){
			$r['direction'] = 'DESC';
		}
		if($r['limit'] == ''){
			$r['limit'] = '0, 100';
		}
		$quotings=$this->DB->query("
			SELECT quoting.*,
				supplier.title AS supplier,
				customer.title AS customer,
				shipmethod.title AS shipmethod,
				port.title AS port,
				paymentterm.title AS paymentterm, paymentterm.entitle AS enpaymentterm,
				deliveryterm.title AS deliveryterm,
				currency.title AS currency,
				m.username AS mname, c.username AS cname
			FROM `quoting`
			LEFT JOIN supplier ON (supplier.supplierid=`quoting`.supplierid)
			LEFT JOIN customer ON (customer.customerid=`quoting`.customerid)
			LEFT JOIN currency ON (currency.currencyid=`quoting`.currencyid)
			LEFT JOIN shipmethod ON (shipmethod.shipmethodid=`quoting`.shipmethodid)
			LEFT JOIN port ON (port.portid=`quoting`.portid)
			LEFT JOIN paymentterm ON (paymentterm.paymenttermid=`quoting`.paymenttermid)
			LEFT JOIN deliveryterm ON (deliveryterm.deliverytermid=`quoting`.deliverytermid)
			LEFT JOIN `user` AS m ON (m.userid=customer.modifier)
			LEFT JOIN `user` AS c ON (c.userid=customer.creator)
			WHERE `quoting`.killed=0".$r['condition']."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num'] = $this->DB->numRows();
		if($rtn['num']){
			while($quoting = $this->DB->fetchArray($quotings)){
				if($quoting['inquiryid']>0){
					$orgLink='<a href="javascript:previewTabs();" title="查看对应的询价单" class="small">对应询价单</a> ';
				}else{
					$orgLink='';
				}
				if($quoting['customerid']>0){
					$options = $orgLink.'<a href="/s.php?module=customer&action=removeQuoting&quotingid='.$quoting['quotingid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=customer&action=updateQuoting&quotingid='.$quoting['quotingid'].'">修改</a>　<a href="/p.php?action=customerQuoting&quotingid='.$quoting['quotingid'].'" target="_blank">打印</a>';
				}
				if($quoting['supplierid']>0){
					$options = $orgLink.'<a href="/s.php?module=supplier&action=removeQuoting&quotingid='.$quoting['quotingid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=supplier&action=updateQuoting&quotingid='.$quoting['quotingid'].'">修改</a>　<a href="/p.php?action=supplierQuoting&quotingid='.$quoting['quotingid'].'" target="_blank">打印</a>';
				}
				if($quoting['modifier']>0){
					$modified = '，'.$quoting['mname'].'于'.date('y-m-d H:i:s', $quoting['modified']).'最后修改';
				}
				$items = $this->DB->query("
					SELECT `item`.*,
						product.title AS product,
						packing.title AS packing,
						unit.title AS unit
					FROM `item`
					LEFT JOIN product ON (product.productid=`item`.productid)
					LEFT JOIN packing ON (packing.packingid=`item`.packingid)
					LEFT JOIN unit ON (unit.unitid=`item`.unitid)
					WHERE `item`.module='quoting' AND `item`.mid='".$quoting['quotingid']."'
					ORDER BY itemid ASC
				");
				$itemtr='';
				$total=$quantity=0;
				if($itemNum=$this->DB->numRows()){
					$itemtr = '<tr><td colspan="8"><table class="hundred"><thead><tr><th>询价产品</th><th>产品特有属性</th><th>说明</th><th>包装</th><th align="right">折扣</th><th align="right">数量</th><th align="right">单价</th><th align="right">小计</th></tr></thead><tbody>';
					while($item = $this->DB->fetchArray($items)){
						if($item['quantity']>0 AND $item['price']>0){
							$amount=$item['quantity']*$item['price'];
							$total+=$amount;
							$quantity+=$item['quantity'];
						}
						$selectStr = '';
						if(!empty($item['productAttributes'])){
							$nameStr = explode("#",$item['productAttributes']);
							$valueStr = explode(",",$nameStr[1]);
							array_pop($valueStr);
							$attributes=$this->DB->query("
								SELECT an.nameid,an.title AS name,
									av.valueid,av.title AS value
								FROM  attributename AS an
								LEFT JOIN attributevalue AS av ON (av.nameid=an.nameid)
								WHERE an.killed=0 AND av.killed=0 AND an.module='product' AND an.mid='".$nameStr[0]."'
								ORDER BY an.ordering ASC
							");
									$nameId=$title=$value=$attributeCount=array();
									if($this->DB->numRows()){
										while($attribute=$this->DB->fetchArray($attributes)){
											if(in_array($attribute['nameid'],$nameId)){
												$title[$attribute['nameid']]=$attribute['name'];
												$value[$attribute['nameid']][]=$attribute['value'];
												$valueId[$attribute['nameid']][]=$attribute['valueid'];
												$attributeCount[$attribute['nameid']]++;
											}else{
												$nameId[]=$attribute['nameid'];
												$title[$attribute['nameid']]=$attribute['name'];
												$value[$attribute['nameid']][]=$attribute['value'];
												$valueId[$attribute['nameid']][]=$attribute['valueid'];
												$attributeCount[$attribute['nameid']]=1;
											}
										}
									}
									foreach ($nameId as $key=>$val){
										$selectStr .= ''.$title[$val].'：';
										for($n=0;$n<count($value[$val]);$n++){
											if($valueId[$val][$n]==$valueStr[$key]){
												$selectStr .= '<span class="darkred">'.$value[$val][$n].'</span>';
											}
										}
										$selectStr .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
									}
								}else{
									$selectStr .= '此产品或配件没有属性';
								}
								
						$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
						<td><a href="/s.php?module=product&action=view&productid='.$item['productid'].'" target="_blank">'.$item['product'].'</a></td>
						<td>'.$selectStr.'</td>
						<td>'.$item['caption'].'</td>
						<td>'.$item['packing'].'</td>
						<td align="right">'.$item['discount'].'</td>
						<td align="right">'.$item['quantity'].' '.$item['unit'].'</td>
						<td align="right">'.$item['price'].'</td>
						<td align="right">'.number_format($amount,2).'</td>
						</tr>';
					}
					$itemtr .= '<tr><td colspan="5" align="right">合计：</td><td align="right">'.number_format($quantity).'</td><td></td><td align="right">'.number_format($total, 2).'</td></tr></tbody></table></td></tr>';
				}
				$title = '';
				if($quoting['shipmethod']!='')$title .= '　<span class="small">运送方式：</span>'.$quoting['shipmethod'];
				if($quoting['port']!='')$title .= '　<span class="small">交货地点：</span>'.$quoting['port'];
				if($quoting['paymentterm']==''){
					$quoting['paymentterm']=$quoting['enpaymentterm'];
				}
				if($quoting['paymentterm']!='')$title .= '　<span class="small">支付条款：</span>'.$quoting['paymentterm'];
				if($quoting['deliveryterm']!='')$title .= '　<span class="small">交货条款：</span>'.$quoting['deliveryterm'];
				$title.='　<span class="small">总数：</span>'.number_format($quantity).'<span class="small">['.$itemNum.']</span>　<span class="small">合计：</span>'.$this->iif($quoting['currency']!='', '<span class="normal">'.$quoting['currency'].'</span>', '').number_format($total,2).'　<span class="small" title="由 '.$quoting['cname'].' 建立于'.date('Y-m-d H:i', $quoting['created']).$modified.'。">'.date('y-m-d H:i', $quoting['modified']).'</span>';
$rtn['panel'] .= <<<EOF
<table class="hundred">
<thead>
<tr><th colspan="8"><span class="right">{$options} <span class="plus hand" onclick="$('#quoting{$quoting['quotingid']}').toggle('fast');$(this).toggleClass('minus');"></span></span>	<span class="small">联系人：</span><span class="middle bold">{$quoting['contact']}</span>{$title}</th></tr>
</thead>
<tbody id="quoting{$quoting['quotingid']}" style="display:none">
<tr class="odd">
	<td width="80">运送方式：</td><td class="middle">{$quoting['shipmethod']}</td>
	<td width="80">交货地点：</td><td class="middle">{$quoting['port']}</td>
	<td width="80">支付条款：</td><td class="middle">{$quoting['paymentterm']}</td>
	<td width="80">交货条款：</td><td class="middle">{$quoting['deliveryterm']}</td>
</tr>
<tr class="even">
	<td>规格说明：</td><td class="middle">{$quoting['standrad']}</td>
	<td>主要材料：</td><td class="middle">{$quoting['material']}</td>
	<td>工艺说明：</td><td class="middle">{$quoting['technics']}</td>
	<td>备　　注：</td><td class="middle">{$quoting['remark']}</td>
</tr>
{$itemtr}
</tbody>
</table>
EOF;
			}
			$rtn['panel'] .= '</tbody></table>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 互访
	function relatedVisit($r){
		if($r['customerid']>0){
			$r['condition'] .= " AND `visit`.customerid='".$r['customerid']."'";
			$module='customer';
		}
		if($r['supplierid']>0){
			$r['condition'] .= " AND `visit`.supplierid='".$r['supplierid']."'";
			$module='supplier';
		}
		if($r['orderby'] == ''){
			$r['orderby'] = '`visit`.modified';
		}
		if($r['direction'] == ''){
			$r['direction'] = 'DESC';
		}
		if($r['limit'] == ''){
			$r['limit'] = '0, 100';
		}
		$visits=$this->DB->query("
			SELECT visit.*,
				mu.username AS modifier,
				cu.username AS creator
			FROM `visit`
			LEFT JOIN user AS cu ON (cu.userid=`visit`.creator)
			LEFT JOIN user AS mu ON (mu.userid=`visit`.modifier)
			WHERE `visit`.killed=0".$r['condition']."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num'] = $this->DB->numRows();
		if($rtn['num']){
			$rtn['panel']='<table class="hundred"><thead><tr><th>访问时间</th><th>客户方</th><th>我方人员</th><th>地点</th><th>目的</th><th>关键内容</th><th>操作</th></tr><tbody>';
			while($visit = $this->DB->fetchArray($visits)){
				$rtn['panel'].='<tr class="'.$this->rotateLine().'">
				<td><span class="small">开始于</span> '.date('Y-m-d H:i', $visit['start']).'<br><span class="small">结束于</span> '.date('Y-m-d H:i', $visit['end']).'</td>
				<td>'.$visit['theirstaff'].'</td>
				<td>'.$visit['ourstaff'].'</td>
				<td>'.$visit['place'].'</td>
				<td>'.$visit['purpose'].'</td>
				<td>'.$visit['point'].'</td>
				<td><a href="/s.php?module='.$module.'&action=removeVisit&visitid='.$visit['visitid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module='.$module.'&action=updateVisit&visitid='.$visit['visitid'].'">修改</a></td></tr>';
			}
			$rtn['panel'] .= '</tbody></table>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 询价
	function relatedPInquiry($r){
		if($r['materialid']>0){
			$items=$this->DB->query("SELECT DISTINCT mid FROM `item` WHERE module='inquiry' AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item=$this->DB->fetchArray($items)){
					$id[]=$item['mid'];
				}
				if(is_Array($id)){
					$r['condition'].=" AND `inquiry`.inquiryid IN (".implode(',',$id).")";
				}
			}else{
				return array('num'=>0, 'panel'=>'','off'=>' disabled');
			}
		}
		if($r['customerid']>0){
			$r['condition'].=" AND `inquiry`.customerid='".$r['customerid']."'";
			$options='<a href="/s.php?module=customer&action=removeInquiry&inquiryid='.$inquiry['inquiryid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=customer&action=updateInquiry&inquiryid='.$inquiry['inquiryid'].'">修改</a>　<a href="/p.php?action=customerInquiry&inquiryid='.$inquiry['inquiryid'].'" target="_blank">打印</a>　<a href="/s.php?module=customer&action=addQuoting&customerid='.$inquiry['customerid'].'&inquiryid='.$inquiry['inquiryid'].'">回复</a>';
		}
		if($r['supplierid']>0){
			$r['condition'].=" AND `inquiry`.supplierid='".$r['supplierid']."'";
			$options='<a href="/s.php?module=psupplier&action=removeInquiry&inquiryid='.$inquiry['inquiryid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=psupplier&action=updateInquiry&inquiryid='.$inquiry['inquiryid'].'">修改</a>　<a href="/p.php?action=supplierInquiry&inquiryid='.$inquiry['inquiryid'].'" target="_blank">打印</a>　<a href="/s.php?module=psupplier&action=addQuoting&supplierid='.$inquiry['supplierid'].'&inquiryid='.$inquiry['inquiryid'].'">回复</a>';
		}
		if($r['orderby']==''){
			$r['orderby']='`inquiry`.modified';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$inquirys=$this->DB->query("
			SELECT inquiry.*,
				supplier.title AS supplier,
				customer.title AS customer,
				shipmethod.title AS shipmethod,
				port.title AS port,
				paymentterm.title AS paymentterm,paymentterm.entitle AS enpaymentterm,
				deliveryterm.title AS deliveryterm,
				currency.title AS currency
			FROM `inquiry`
			LEFT JOIN supplier ON (supplier.supplierid=`inquiry`.supplierid)
			LEFT JOIN customer ON (customer.customerid=`inquiry`.customerid)
			LEFT JOIN currency ON (currency.currencyid=`inquiry`.currencyid)
			LEFT JOIN shipmethod ON (shipmethod.shipmethodid=`inquiry`.shipmethodid)
			LEFT JOIN port ON (port.portid=`inquiry`.portid)
			LEFT JOIN paymentterm ON (paymentterm.paymenttermid=`inquiry`.paymenttermid)
			LEFT JOIN deliveryterm ON (deliveryterm.deliverytermid=`inquiry`.deliverytermid)
			WHERE `inquiry`.killed=0".$r['condition']."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		if($rtn['num']=$this->DB->numRows()){
			while($inquiry=$this->DB->fetchArray($inquirys)){
				if($inquiry['quotingid']>0 AND $inquiry['replied']>0){
					$quoting=$this->DB->queryFirst("SELECT quotingid FROM quoting WHERE killed=0 AND inquiryid='".$inquiry['inquiryid']."' ORDER BY created DESC LIMIT 0,1");
					$reply='最后回复时间：'.date('Y-m-d H:i:s', $inquiry['replied']);
					$replyLink='<a href="/s.php?module=psupplier&action=quoting&quotingid='.$quoting['quotingid'].'" title="查看最新回复的报价单"><span class="small">('.$inquiry['replyTimes'].')</span></a>';
				}else{
					$reply='';
					$replyLink='<span class="small">('.$inquiry['replyTimes'].')</span>';
				}
				if($inquiry['customerid']>0){
					$options='<a href="/s.php?module=customer&action=removeInquiry&inquiryid='.$inquiry['inquiryid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=customer&action=updateInquiry&inquiryid='.$inquiry['inquiryid'].'">修改</a>　<a href="/s.php?module=psupplier&action=updateInquiry&options=version&inquiryid='.$inquiry['inquiryid'].'">更新版本</a>　<a href="/p.php?action=customerInquiry&inquiryid='.$inquiry['inquiryid'].'" target="_blank">打印</a>　<a href="/s.php?module=customer&action=addQuoting&customerid='.$inquiry['customerid'].'&inquiryid='.$inquiry['inquiryid'].'" title="'.$reply.'">回复</a>'.$replyLink;
				}
				if($inquiry['supplierid']>0){
					$options='<a href="/s.php?module=psupplier&action=removeInquiry&inquiryid='.$inquiry['inquiryid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=psupplier&action=updateInquiry&inquiryid='.$inquiry['inquiryid'].'">修改</a>　<a href="/s.php?module=psupplier&action=updateInquiry&options=version&inquiryid='.$inquiry['inquiryid'].'">更新版本</a>　<a href="/p.php?action=supplierInquiry&inquiryid='.$inquiry['inquiryid'].'" target="_blank">打印</a>　<a href="/s.php?module=psupplier&action=addQuoting&supplierid='.$inquiry['supplierid'].'&inquiryid='.$inquiry['inquiryid'].'" title="'.$reply.'"><span class="small">供应商</span>回复</a>'.$replyLink;
				}
				$items=$this->DB->query("
					SELECT `item`.*, 
						`material`.materialno AS olMaterialno,`material`.title AS olMaterialTitle,`material`.standard AS olMaterialStandard, 
						`packing`.title AS packing, 
						`unit`.title AS unit
					FROM `item` 
					LEFT JOIN `material` ON (`material`.materialid=`item`.materialid) 
					LEFT JOIN `packing` ON (`packing`.packingid=`item`.packingid) 
					LEFT JOIN `unit` ON (`unit`.unitid=`item`.unitid) 
					WHERE `item`.killed=0 AND `item`.module='inquiry' AND `item`.mid='".$inquiry['inquiryid']."' 
					ORDER BY itemid ASC
				");
				$itemtr='';
				if($itemNum=$this->DB->numRows()){
					$itemtr='<tr><td colspan="8"><table><thead><tr><th>询价物资编号</th><th>名称</th><th>规格</th><th>包装方式</th><th>包装</th><th>折扣</th><th>数量</th></tr></thead><tbody>';
					while($item=$this->DB->fetchArray($items)){
						$materialno=$this->iif($item['materialid']==0,$item['materialno'],$item['olMaterialno']);
						$materialTitle=$this->iif($item['materialid']==0,$item['materialTitle'],$item['olMaterialTitle']);
						$materialStandard=$this->iif($item['materialid']==0,$item['materialStandard'],$item['olMaterialStandard']);
						$itemtr.='<tr class="'.$this->rotateLine().'">
						<td><a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'" target="_blank">'.$materialno.'</a></td>
						<td>'.$materialTitle.'</td>
						<td>'.$materialStandard.'</td>
						<td>'.$item['package'].'</td>
						<td>'.$item['packing'].'</td>
						<td>'.$item['discount'].'</td>
						<td>'.$item['quantity'].' '.$item['unit'].'</td>
						</tr>';
					}
					$itemtr.='</tbody></table></td></tr>';
				}
				$title='';
				if($inquiry['currency']!='')$title.='　<span class="small">币种：</span>'.$inquiry['currency'];
				if($inquiry['paymentterm']!='')$title.='　<span class="small">支付条款：</span>'.$inquiry['paymentterm'];
				if($inquiry['shipmethod']!='')$title.='　<span class="small">运送方式：</span>'.$inquiry['shipmethod'];
				if($inquiry['port']!='')$title.='　<span class="small">交货地点：</span>'.$inquiry['port'];
				if($inquiry['deliveryterm']!='')$title.='　<span class="small">交货条款：</span>'.$inquiry['deliveryterm'];
$rtn['panel'].=<<<EOF
<table class="hundred">
<thead>
<tr><th colspan="8"><span class="right">{$options} <span class="plus hand"></span></span>	<span class="normal">[<b>{$itemNum}</b>]</span> <span class="small">联系人：</span><span class="middle bold">{$inquiry['contact']}</span>{$title}</th></tr>
</thead>
<tbody id="inquiry{$inquiry['inquiryid']}" style="display:none">
<tr class="odd">
	<td width="80">运送方式：</td><td class="middle">{$inquiry['shipmethod']}</td>
	<td width="80">交货地点：</td><td class="middle">{$inquiry['port']}</td>
	<td width="80">支付条款：</td><td class="middle">{$inquiry['paymentterm']}({$inquiry['enpaymentterm']})</td>
	<td width="80">交货条款：</td><td class="middle">{$inquiry['deliveryterm']}</td>
</tr>
<tr class="even">
	<td>规格说明：</td><td class="middle">{$inquiry['standard']}</td>
	<td>主要材料：</td><td class="middle">{$inquiry['material']}</td>
	<td>工艺说明：</td><td class="middle">{$inquiry['technics']}</td>
	<td>备　　注：</td><td class="middle">{$inquiry['remark']}</td>
</tr>
{$itemtr}
</tbody>
</table>
EOF;
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 报价
	function relatedPQuoting($r){
		if($r['materialid']>0){
			$items=$this->DB->query("SELECT DISTINCT mid FROM `item` WHERE module='quoting' AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item=$this->DB->fetchArray($items)){
					$id[]=$item['mid'];
				}
				if(is_Array($id)){
					$r['condition'].=" AND `quoting`.quotingid IN (".implode(',',$id).")";
				}
			}else{
				return array('num'=>0,'off'=>'disabled','panel'=>'');
			}
		}
		if($r['customerid']>0){
			$r['condition'].=" AND `quoting`.customerid='".$r['customerid']."'";
			$options='<a href="/s.php?module=customer&action=removeQuoting&quotingid='.$quoting['quotingid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=customer&action=updateQuoting&quotingid='.$quoting['quotingid'].'">修改</a>　<a href="/p.php?action=customerQuoting&quotingid='.$quoting['quotingid'].'" target="_blank">打印</a>　<a href="/s.php?module=customer&action=addQuoting&customerid='.$quoting['customerid'].'&quotingid='.$quoting['quotingid'].'">回复</a>';
		}
		if($r['supplierid']>0){
			$r['condition'].=" AND `quoting`.supplierid='".$r['supplierid']."'";
			$options='<a href="/s.php?module=psupplier&action=removeQuoting&quotingid='.$quoting['quotingid'].'" onclick="return confirm(\'你确定要删除这张询价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=psupplier&action=updateQuoting&quotingid='.$quoting['quotingid'].'">修改</a>　<a href="/p.php?action=supplierQuoting&quotingid='.$quoting['quotingid'].'" target="_blank">打印</a>　<a href="/s.php?module=psupplier&action=addQuoting&supplierid='.$quoting['supplierid'].'&quotingid='.$quoting['quotingid'].'">回复</a>';
		}
		if($r['orderby']==''){
			$r['orderby']='`quoting`.modified';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$quotings=$this->DB->query("
			SELECT quoting.*,
				supplier.title AS supplier,
				customer.title AS customer,
				shipmethod.title AS shipmethod,
				port.title AS port,
				paymentterm.title AS paymentterm,paymentterm.entitle AS enpaymentterm,
				deliveryterm.title AS deliveryterm,
				currency.title AS currency
			FROM `quoting`
			LEFT JOIN supplier ON (supplier.supplierid=`quoting`.supplierid)
			LEFT JOIN customer ON (customer.customerid=`quoting`.customerid)
			LEFT JOIN currency ON (currency.currencyid=`quoting`.currencyid)
			LEFT JOIN shipmethod ON (shipmethod.shipmethodid=`quoting`.shipmethodid)
			LEFT JOIN port ON (port.portid=`quoting`.portid)
			LEFT JOIN paymentterm ON (paymentterm.paymenttermid=`quoting`.paymenttermid)
			LEFT JOIN deliveryterm ON (deliveryterm.deliverytermid=`quoting`.deliverytermid)
			WHERE `quoting`.killed=0".$r['condition']."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		if($rtn['num']=$this->DB->numRows()){
			while($quoting=$this->DB->fetchArray($quotings)){
				if($quoting['inquiryid']>0){
					$orgLink='<a href="/s.php?module=psupplier&action=inquiry&inquiryid='.$quoting['inquiryid'].'" title="查看对应的询价单" class="small">对应询价单</a> ';
				}else{
					$orgLink='';
				}
				if($quoting['customerid']>0){
					$options=$orgLink.'<a href="/s.php?module=customer&action=removeQuoting&quotingid='.$quoting['quotingid'].'" onclick="return confirm(\'你确定要删除这张报价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=customer&action=updateQuoting&quotingid='.$quoting['quotingid'].'">修改</a>　<a href="/p.php?action=customerQuoting&quotingid='.$quoting['quotingid'].'" target="_blank">打印</a>';
				}
				if($quoting['supplierid']>0){
					$options=$orgLink.'<a href="/s.php?module=psupplier&action=removeQuoting&quotingid='.$quoting['quotingid'].'" onclick="return confirm(\'你确定要删除这张报价单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module=psupplier&action=updateQuoting&quotingid='.$quoting['quotingid'].'">修改</a>　<a href="/p.php?action=supplierQuoting&quotingid='.$quoting['quotingid'].'" target="_blank">打印</a>';
				}
				$items=$this->DB->query("
					SELECT `item`.*,
						`material`.materialno AS olMaterialno,`material`.title AS olMaterialTitle,`material`.standard AS olMaterialStandard, 
						packing.title AS packing,
						unit.title AS unit
					FROM `item`
					LEFT JOIN `material` ON (`material`.materialid=`item`.materialid)
					LEFT JOIN `packing` ON (`packing`.packingid=`item`.packingid)
					LEFT JOIN `unit` ON (`unit`.unitid=`item`.unitid)
					WHERE `item`.module='quoting' AND `item`.mid='".$quoting['quotingid']."'
					ORDER BY itemid ASC
				");
				$itemtr='';
				if($itemNum=$this->DB->numRows()){
					$itemtr='<tr><td colspan="9"><table><thead><tr><th>询价物资</th><th>物资名称</th><th>规格</th><th>包装方式</th><th>包装</th><th>折扣</th><th>数量</th></tr></thead><tbody>';
					while($item=$this->DB->fetchArray($items)){
						$materialno=$this->iif($item['materialid']==0,$item['materialno'],$item['olMaterialno']);
						$materialTitle=$this->iif($item['materialid']==0,$item['materialTitle'],$item['olMaterialTitle']);
						$materialStandard=$this->iif($item['materialid']==0,$item['materialStandard'],$item['olMaterialStandard']);
						$itemtr.='<tr class="'.$this->rotateLine().'">
						<td><a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'" target="_blank">'.$materialno.'</a></td>
						<td>'.$materialTitle.'</td>
						<td>'.$materialStandard.'</td>
						<td>'.$item['package'].'</td>
						<td>'.$item['packing'].'</td>
						<td>'.$item['discount'].'</td>
						<td>'.$item['quantity'].' '.$item['unit'].'</td>
						</tr>';
					}
					$itemtr.='</tbody></table></td></tr>';
				}
				$title='';
				if($quoting['currency']!='')$title.='　<span class="small">币种：</span>'.$quoting['currency'];
				if($quoting['paymentterm']!='' OR $quoting['enpaymentterm']!='' )$title.='　<span class="small">支付条款：</span>'.$quoting['paymentterm'].'('.$quoting['enpaymentterm'].')';
				if($quoting['shipmethod']!='')$title.='　<span class="small">运送方式：</span>'.$quoting['shipmethod'];
				if($quoting['port']!='')$title.='　<span class="small">交货地点：</span>'.$quoting['port'];
				if($quoting['deliveryterm']!='')$title.='　<span class="small">交货条款：</span>'.$quoting['deliveryterm'];
$rtn['panel'].=<<<EOF
<table class="hundred">
<thead>
<tr><th colspan="8"><span class="right">{$options} <span class="plus hand"></span></span>	<span class="normal">[<b>{$itemNum}</b>]</span> <span class="small">联系人：</span><span class="middle bold">{$quoting['contact']}</span>{$title}</th></tr>
</thead>
<tbody id="quoting{$quoting['quotingid']}" style="display:none">
<tr class="odd">
	<td width="80">运送方式：</td><td class="middle">{$quoting['shipmethod']}</td>
	<td width="80">交货地点：</td><td class="middle">{$quoting['port']}</td>
	<td width="80">支付条款：</td><td class="middle">{$quoting['paymentterm']}({$quoting['enpaymentterm']})</td>
	<td width="80">交货条款：</td><td class="middle">{$quoting['deliveryterm']}</td>
</tr>
<tr class="even">
	<td>规格说明：</td><td class="middle">{$quoting['standard']}</td>
	<td>主要材料：</td><td class="middle">{$quoting['material']}</td>
	<td>工艺说明：</td><td class="middle">{$quoting['technics']}</td>
	<td>备　　注：</td><td class="middle">{$quoting['remark']}</td>
</tr>
{$itemtr}
</tbody>
</table>
EOF;
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 互访
	function relatedPVisit($r){
		if($r['customerid']>0){
			$r['condition'].=" AND `visit`.customerid='".$r['customerid']."'";
			$module='customer';
		}
		if($r['supplierid']>0){
			$r['condition'].=" AND `visit`.supplierid='".$r['supplierid']."'";
			$module='psupplier';
		}
		if($r['orderby']==''){
			$r['orderby']='`visit`.modified';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$visits=$this->DB->query("
			SELECT visit.*,
				mu.username AS modifier,
				cu.username AS creator
			FROM `visit`
			LEFT JOIN user AS cu ON (cu.userid=`visit`.creator)
			LEFT JOIN user AS mu ON (mu.userid=`visit`.modifier)
			WHERE `visit`.killed=0".$r['condition']."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$rtn['panel']='<table class="hundred"><thead><tr><th>访问时间</th><th>客户方</th><th>我方人员</th><th>地点</th><th>目的</th><th>关键内容</th><th>操作</th></tr><tbody>';
			while($visit=$this->DB->fetchArray($visits)){
				$rtn['panel'].='<tr class="'.$this->rotateLine().'">
				<td><span class="small">开始于</span> '.date('Y-m-d H:i', $visit['start']).'<br><span class="small">结束于</span> '.date('Y-m-d H:i', $visit['end']).'</td>
				<td>'.$visit['theirstaff'].'</td>
				<td>'.$visit['ourstaff'].'</td>
				<td>'.$visit['place'].'</td>
				<td>'.$visit['purpose'].'</td>
				<td>'.$visit['point'].'</td>
				<td><a href="/s.php?module='.$module.'&action=removeVisit&visitid='.$visit['visitid'].'" onclick="return confirm(\'你确定要删除这张互访单吗？(删除不可恢复！)\')">删除</a>　<a href="/s.php?module='.$module.'&action=updateVisit&visitid='.$visit['visitid'].'">修改</a></td></tr>';
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 发票
	function relatedPInvoice($r){
		if($r['materialid']>0){
			$items=$this->DB->query("SELECT DISTINCT mid FROM `item` WHERE module='invoice' AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item=$this->DB->fetchArray($items)){
					$id[]=$item['mid'];
				}
				if(is_Array($id)){
					$r['condition'].=" AND `pinvoice`.pinvoiceid IN (".implode(',',$id).")";
				}
			}else{
				return array('num'=>0, 'panel'=>'','off'=>' disabled');
			}
		}
		if($r['customerid']>0){
			$r['condition'].=" AND `pinvoice`.customerid='".$r['customerid']."'";
		}
		if($r['supplierid']>0){
			$r['condition'].= " AND `pinvoice`.supplierid='".$r['supplierid']."'";
		}
		if($r['porderid']>0){
			$r['condition'].= " AND `pinvoice`.porderid='".$r['porderid']."'";
		}
		if($r['orderby']==''){
			$r['orderby']='`pinvoice`.modified';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$invoices=$this->DB->query("
			SELECT `pinvoice`.pinvoiceid,`pinvoice`.title,`pinvoice`.invoiceno,`pinvoice`.dateOfArrival,
					`pinvoice`.taxRate,`pinvoice`.created,`pinvoice`.killed,`pinvoice`.amount,
				`supplier`.supplierid,`supplier`.title AS supplier,
				`porder`.porderid,`porder`.orderno,
				`currency`.title AS currency,
				u.username AS creator,
				us.username AS modifier
			FROM `pinvoice`
			LEFT JOIN `supplier` ON (`supplier`.supplierid=`pinvoice`.supplierid)
			LEFT JOIN `porder` ON (`porder`.porderid=`pinvoice`.porderid)
			LEFT JOIN `currency` ON (`currency`.currencyid=`pinvoice`.currencyid)
			LEFT JOIN `user` AS u ON (u.userid=`pinvoice`.creator)
			LEFT JOIN `user` AS us ON (us.userid=`pinvoice`.modifier)
			WHERE `pinvoice`.killed=0 ".$r['condition']."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$index=1;
			while($invoice=$this->DB->fetchArray($invoices)){
				$invoice['dateOfArrival']=date('Y-m-d',$invoice['dateOfArrival']);
				$invoice['created']=date('Y-m-d',$invoice['created']);
				$itemtr='';
				$items=$this->DB->query("
					SELECT `item`.itemid,`item`.materialid,`item`.discount,`item`.quantity,`item`.tax,`item`.price,`item`.amount,
						`material`.materialno,`material`.title AS material,`material`.standard,
						`porder`.orderno,
						brand.title AS brand,
						packing.title AS packing,
						unit.title AS unit
					FROM `item`
					LEFT JOIN `material` ON (`material`.materialid=`item`.materialid)
					LEFT JOIN `porder` ON (`porder`.porderid=`item`.porderid)
					LEFT JOIN packing ON (packing.packingid=`item`.packingid)
					LEFT JOIN brand ON (brand.brandid=`item`.brandid)
					LEFT JOIN unit ON (unit.unitid=`item`.unitid)
					WHERE `item`.killed=0 AND `item`.module='pinvoice' AND mid='".$invoice['pinvoiceid']."'
					ORDER BY `item`.ordering, `item`.modified ASC, `item`.itemid ASC
				");
				if($this->DB->numRows()){
					$i=1;
					$itemtr.='<tr class="even center" colspan=10><td width="15">ID</td><td width="30">订单号</td><td width="250">货物或应税劳务名称</td><td width="50">总数/单位</td><td width="50">单价</td><td width="60">总金额</td><td width="50">税率</td><td width="100">税额</td></tr>';
					while($item=$this->DB->fetchArray($items)){
						$itemtr.='<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
							<td>'.$i.'</td>
							<td><a href="/s.php?module=porder&action=view&porderid='.$item['porderid'].'" target="_blank">'.$item['orderno'].'</a></td>
							<td>'.$item['materialno'].' <a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'" target="_blank">'.$item['material'].' '.$item['standard'].'</a></td>
							<td align="right">'.$item['quantity'].$item['unit'].'</td>
							<td align="right">'.$item['price'].'</td>
							<td align="right">'.$item['amount'].'</td>
							<td align="right">'.($invoice['taxRate']*100).'%</td>
							<td align="right">'.$item['tax'].'</td></tr>';
					}
				}
				if($invoice['invoiceno']!='')$title.='　<span class="small">发票编号：</span><a href="/s.php?module=pinvoice&action=view&pinvoiceid='.$invoice['pinvoiceid'].'">'.$invoice['invoiceno'].'</a>';
				if($invoice['supplier']!='')$title.='　<span class="small">供应商：</span><a href="/s.php?module='.$supplierM.'&action=view&supplierid='.$invoice['supplierid'].'">'.$invoice['supplier'].'</a>';
				if($invoice['currency']!='')$title.='　<span class="small">币种：</span>'.$invoice['currency'];
				if($invoice['created']!='')$title.='　<span class="small">创建时间：</span>'.$invoice['created'];
				$options=$this->iif($invoice['killed']==0,'<a href="/s.php?module=pinvoice&action=update&pinvoiceid='.$invoice['pinvoiceid'].'">修改</a> <a href="/s.php?module=pinvoice&action=kill&pinvoiceid='.$invoice['pinvoiceid'].'&rt=list" onclick="return confirm(\'你确定要删除这个应付 '.$invoice['orderno'].' 吗？\');">删除</a>','<a href="/s.php?module=pinvoice&action=restorePayment&pinvoiceid='.$invoice['pinvoiceid'].'">恢复</a>');
				$rtn['panel'].=<<<EOF
<table class="hundred">
<thead>
<tr><th colspan="15"><span class="right">{$options} <span class="plus"></span></span>	<span class="normal">[<b>{$index}</b>]</span>{$title}</th></tr>
</thead>
<tbody id="invoice{$invoice['pinvoiceid']}" style="display:none">
{$itemtr}
</tbody>
</table>
EOF;
				$index++;
			}
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 发票明细
	function relatedPInvoiceItem($o){
		$items=$this->DB->query("
			SELECT `item`.itemid,`item`.materialid,`item`.discount,`item`.quantity,`item`.tax,`item`.price,`item`.amount,
				`material`.materialno,`material`.title AS material,`material`.standard,
				`porder`.orderno,
				brand.title AS brand,
				packing.title AS packing,
				unit.title AS unit
			FROM `item`
			LEFT JOIN `material` ON (`material`.materialid=`item`.materialid)
			LEFT JOIN `porder` ON (`porder`.porderid=`item`.porderid)
			LEFT JOIN packing ON (packing.packingid=`item`.packingid)
			LEFT JOIN brand ON (brand.brandid=`item`.brandid)
			LEFT JOIN unit ON (unit.unitid=`item`.unitid)
			WHERE `item`.killed=0 AND `item`.module='pinvoice' AND mid='".$o['pinvoiceid']."'
			ORDER BY `item`.ordering, `item`.modified ASC, `item`.itemid ASC
		");
		if($this->DB->numRows()){
			$i=1;
			$r='<tr class="even center" colspan=10><td width="20">ID</td><td width="20">订单号</td><td width="250">货物或应税劳务名称</td><td width="50">数量</td><td width="50">单位</td><td width="50">单价</td><td width="60">金额</td><td width="50">税率</td><td width="100">税额</td></tr>';
			while($item=$this->DB->fetchArray($items)){
				$r.='<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
					<td>'.$i.'</td>
					<td><a href="/s.php?module=porder&action=view&porderid='.$item['porderid'].'" target="_blank">'.$item['orderno'].'</a></td>
					<td>'.$item['materialno'].' <a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'" target="_blank">'.$item['material'].' '.$item['standard'].'</a></td>
					<td align="right">'.$item['quantity'].'</td>
					<td>'.$item['unit'].'</td>
					<td align="right">'.$item['price'].'</td>
					<td align="right">'.$item['amount'].'</td>
					<td>'.$invoice['taxRate'].'</td>
					<td align="right">'.$item['tax'].'</td></tr>';
				$i++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
				$tax+=$item['tax'];
			}
			$total=number_format($total, 2);
			$r.='<tr><td colspan="6" align="right">合计：</td><td align="right" class="middle bold">'.$total.'</td><td align="right">税额：</td><td align="right" class="middle bold">'.$tax.'</td></tr>';
		}
		return $r;
	}
	
	
	// 发票
	function relatedInvoice($r){
		if($r['materialid']>0){
			$items=$this->DB->query("SELECT DISTINCT mid FROM `item` WHERE module='invoice' AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item=$this->DB->fetchArray($items)){
					$id[]=$item['mid'];
				}
				if(is_Array($id)){
					$r['condition'].=" AND `pinvoice`.pinvoiceid IN (".implode(',',$id).")";
				}
			}else{
				return array('num'=>0, 'panel'=>'','off'=>' disabled');
			}
		}
		if($r['customerid']>0){
			$r['condition'].=" AND `invoice`.customerid='".$r['customerid']."'";
		}
		if($r['supplierid']>0){
			$r['condition'].= " AND `invoice`.supplierid='".$r['supplierid']."'";
		}
		if($r['orderid']>0){
			$r['condition'].= " AND `invoice`.orderid='".$r['orderid']."'";
		}
		if($r['orderby']==''){
			$r['orderby']='`invoice`.modified';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		
		$sql = "
			SELECT `invoice`.invoiceid,`invoice`.title,`invoice`.invoiceno,`invoice`.dateOfArrival,
					`invoice`.created,`invoice`.killed,
				`order`.orderid,`order`.orderno,
				`currency`.title AS currency,
				u.username AS creator,
				us.username AS modifier
			FROM `invoice`
			LEFT JOIN `order` ON (`order`.orderid=`invoice`.orderid)
			LEFT JOIN `currency` ON (`currency`.currencyid=`invoice`.currencyid)
			LEFT JOIN `user` AS u ON (u.userid=`invoice`.creator)
			LEFT JOIN `user` AS us ON (us.userid=`invoice`.modifier)
			WHERE `invoice`.killed=0 ".$r['condition']."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		";
		//echo $sql;
		
		$invoices=$this->DB->query($sql);
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$index=1;
			while($invoice=$this->DB->fetchArray($invoices)){
				$titles='';
				$invoice['dateOfArrival']=date('Y-m-d',$invoice['dateOfArrival']);
				$invoice['created']=date('Y-m-d',$invoice['created']);
				$itemtr='';
				$s = "
					SELECT `item`.itemid,`item`.productid,`item`.productAttributes,`item`.materialid,`item`.discount,`item`.quantity,`item`.tax,`item`.price,`item`.amount,
						`material`.materialno,`material`.title AS material,`material`.standard,
						`order`.orderno,
						product.title AS product,
						brand.title AS brand,
						packing.title AS packing,
						unit.title AS unit
					FROM `item`
					LEFT JOIN `material` ON (`material`.materialid=`item`.materialid)
					LEFT JOIN `product` ON (product.productid=item.productid)
					LEFT JOIN `order` ON (`order`.orderid=`item`.orderid)
					LEFT JOIN packing ON (packing.packingid=`item`.packingid)
					LEFT JOIN brand ON (brand.brandid=`item`.brandid)
					LEFT JOIN unit ON (unit.unitid=`item`.unitid)
					WHERE `item`.killed=0 AND `item`.module='invoice' AND mid='".$invoice['invoiceid']."'
					ORDER BY `item`.ordering, `item`.modified ASC, `item`.itemid ASC
				";
				//echo "<br/><br/>====<br>".$s."<br>===<br>";
				$items=$this->DB->query($s);
				if($this->DB->numRows()){
					$i=1;
					$itemtr.='<tr class="even center" colspan=10><td width="15">ID</td><td width="30">订单号</td><td width="150">产品或配件名称</td><td>产品或配件特有属性</td><td width="50">总数/单位</td><td width="50">单价</td><td width="60">总金额</td><td width="50">税率</td><td width="100">税额</td></tr>';
					while($item=$this->DB->fetchArray($items)){
						$selectStr = '';
						if(!empty($item['productAttributes'])){
							$nameStr = explode("#",$item['productAttributes']);
							$valueStr = explode(",",$nameStr[1]);
							array_pop($valueStr);
							$attributes=$this->DB->query("
								SELECT an.nameid,an.title AS name,
									av.valueid,av.title AS value
								FROM  attributename AS an
								LEFT JOIN attributevalue AS av ON (av.nameid=an.nameid)
								WHERE an.killed=0 AND av.killed=0 AND an.module='product' AND an.mid='".$nameStr[0]."'
								ORDER BY an.ordering ASC
							");
							$nameId=$title=$value=$attributeCount=array();
							if($this->DB->numRows()){
								while($attribute=$this->DB->fetchArray($attributes)){
									if(in_array($attribute['nameid'],$nameId)){
										$title[$attribute['nameid']]=$attribute['name'];
										$value[$attribute['nameid']][]=$attribute['value'];
										$valueId[$attribute['nameid']][]=$attribute['valueid'];
										$attributeCount[$attribute['nameid']]++;
									}else{
										$nameId[]=$attribute['nameid'];
										$title[$attribute['nameid']]=$attribute['name'];
										$value[$attribute['nameid']][]=$attribute['value'];
										$valueId[$attribute['nameid']][]=$attribute['valueid'];
										$attributeCount[$attribute['nameid']]=1;
									}
								}
							}
							foreach ($nameId as $key=>$val){
								$selectStr .= ''.$title[$val].'：';
								for($n=0;$n<count($value[$val]);$n++){
									if($valueId[$val][$n]==$valueStr[$key]){
										$selectStr .= '<span class="darkred">'.$value[$val][$n].'</span>';
									}
								}
								$selectStr .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
							}
						}else{
							$selectStr .= '此产品或配件没有属性';
						}
						
						$itemtr.='<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
							<td>'.$i.'</td>
							<td><a href="/s.php?module=order&action=view&orderid='.$item['orderid'].'" target="_blank">'.$item['orderno'].'</a></td>
							<td><a href="/s.php?module=product&action=view&productid='.$item['productid'].'" target="_blank">'.$item['product'].'</a></td>
							<td>'.$selectStr.'</td>
							<td align="right">'.$item['quantity'].$item['unit'].'</td>
							<td align="right">'.$item['price'].'</td>
							<td align="right">'.$item['amount'].'</td>
							<td align="right">'.($invoice['taxRate']*100).'%</td>
							<td align="right">'.$item['tax'].'</td></tr>';
					}
				}
				if($invoice['invoiceno']!='') $titles.='　<span class="small">发票编号：</span><a href="/s.php?module=invoice&action=view&invoiceid='.$invoice['invoiceid'].'">'.$invoice['invoiceno'].'</a>';
				if($invoice['supplier']!='') $titles.='　<span class="small">供应商：</span><a href="/s.php?module='.$supplierM.'&action=view&supplierid='.$invoice['supplierid'].'">'.$invoice['supplier'].'</a>';
				if($invoice['currency']!='') $titles.='　<span class="small">币种：</span>'.$invoice['currency'];
				if($invoice['created']!='') $titles.='　<span class="small">创建时间：</span>'.$invoice['created'];
				$options=$this->iif($invoice['killed']==0,'<a href="/s.php?module=invoice&action=update&invoiceid='.$invoice['invoiceid'].'">修改</a> <a href="/s.php?module=invoice&action=kill&invoiceid='.$invoice['invoiceid'].'&rt=list" onclick="return confirm(\'你确定要删除这个应付 '.$invoice['orderno'].' 吗？\');">删除</a>','<a href="/s.php?module=pinvoice&action=restorePayment&pinvoiceid='.$invoice['pinvoiceid'].'">恢复</a>');
				$rtn['panel'].=<<<EOF
<table class="hundred">
<thead>
<tr><th colspan="15"><span class="right">{$options} <span class="plus hand" onclick="$('#invoice{$invoice['invoiceid']}').toggle('fast');$(this).toggleClass('minus');"></span></span>	<span class="normal">[<b>{$index}</b>]</span>{$titles}</th></tr>
</thead>
<tbody id="invoice{$invoice['invoiceid']}" style="display:none">
{$itemtr}
</tbody>
</table>
EOF;
				$index++;
			}
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 发票明细
	function relatedInvoiceItem($o){
		$items=$this->DB->query("
			SELECT item.*,
				product.title AS product,
				order.orderno,
				brand.title AS brand,
				packing.title AS packing,
				unit.title AS unit
			FROM `item`
			LEFT JOIN `product` ON (product.productid=item.productid)
			LEFT JOIN `order` ON (order.orderid=item.orderid)
			LEFT JOIN packing ON (packing.packingid=item.packingid)
			LEFT JOIN brand ON (brand.brandid=item.brandid)
			LEFT JOIN unit ON (unit.unitid=item.unitid)
			WHERE `item`.killed=0 AND `item`.module='invoice' AND mid='".$o['invoiceid']."'
			ORDER BY `item`.ordering, `item`.modified ASC, `item`.itemid ASC
		");
		if($this->DB->numRows()){
			$k=1;
			while($item=$this->DB->fetchArray($items)){
				
				$selectStr = '';
				if(!empty($item['productAttributes'])){
					$nameStr = explode("#",$item['productAttributes']);
					$valueStr = explode(",",$nameStr[1]);
					array_pop($valueStr);
					$attributes=$this->DB->query("
						SELECT an.nameid,an.title AS name,
							av.valueid,av.title AS value
						FROM  attributename AS an
						LEFT JOIN attributevalue AS av ON (av.nameid=an.nameid)
						WHERE an.killed=0 AND av.killed=0 AND an.module='product' AND an.mid='".$nameStr[0]."'
						ORDER BY an.ordering ASC
					");
					$nameId=$title=$value=$attributeCount=array();
					if($this->DB->numRows()){
						while($attribute=$this->DB->fetchArray($attributes)){
							if(in_array($attribute['nameid'],$nameId)){
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]++;
							}else{
								$nameId[]=$attribute['nameid'];
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]=1;
							}
						}
					}
					foreach ($nameId as $key=>$val){
						$selectStr .= ''.$title[$val].'：';
						for($n=0;$n<count($value[$val]);$n++){
							if($valueId[$val][$n]==$valueStr[$key]){
								$selectStr .= '<span class="darkred">'.$value[$val][$n].'</span>';
							}
						}
						$selectStr .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
					}
				}else{
					$selectStr .= '此产品或配件没有属性';
				}
				
				$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'"><td class="small">'.$item['itemid'].'</td><td align="center">'.$item['ordering'].'</td>
				<td><a href="/s.php?module=order&action=view&orderid='.$item['orderid'].'" target="_blank">'.$item['orderno'].'</a></td>
				<td><a href="/s.php?module=product&action=view&productid='.$item['productid'].'" target="_blank">'.$item['product'].'</a></td>
				<td>'.$selectStr.'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td>
				</tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$rtn['total'] = $total;
			$total=number_format($total, 2);
$rtn['tr']= <<<EOF
		<tr><td>ID</td><td>排序</td><td>订单号</td><td>产品</td><td>产品或配件特有属性</td><td align="right">折扣</td><td align="right">数量/单位</td><td align="right">单价</td><td align="right">小计</td></tr>
		{$itemtr}
		<tr><td colspan="6" align="right">合计：</td><td align="right">{$quantity}</td><td></td><td align="right" class="middle bold">{$total}</td></tr>
EOF;
		}
		return $rtn;
	}
	// 包装清单
	function relatedPackinglist($o){
		$packs = $this->DB->query("
			SELECT p.packinglistid, p.title, p.address, p.refno, p.remark, p.modified, p.modifier, p.created, p.creator,
				region.encountry AS regionEncountry, region.country AS regionCountry, region.enstate AS regionEnstate, region.state AS regionState, region.encity AS regionEncity, region.city AS regionCity,
				customer.title AS customerTitle, customer.address AS customerAddress, customer.linkman AS customerLinkman, customer.position AS customerPosition, customer.telephone AS customerTelephone, customer.fax AS customerFax,
				m.username AS mname, c.username AS cname
			FROM `packinglist` AS p
			LEFT JOIN region ON (region.regionid=`p`.regionid)
			LEFT JOIN customer ON (customer.customerid=`p`.customerid)
			LEFT JOIN `user` AS m ON (m.userid=p.modifier)
			LEFT JOIN `user` AS c ON (c.userid=p.creator)
			WHERE p.killed=0 AND p.invoiceid='".$o['invoiceid']."'
		");
		if($this->DB->numRows()){
			while($pl = $this->DB->fetchArray($packs)){
				$rtn['tabs'] .= '<dt>包装清单<span class="tiny">'.date('y-m-d', $pl['modified']).'</span></dt>';

				if($pl['modifier']>0){
					$modified = '，'.$pl['mname'].' 于 '.date('y-m-d H:i:s', $pl['modified']).' 最后修改';
				}
				$created = date('y-m-d H:i:s', $pl['created']);
				if($pl['regionid']>0){
					if($pl['regionEncity']!=''){
						$region = $pl['regionEncity'].', ';
					}
					if($pl['regionEnstate']!=''){
						$region .= $pl['regionEnstate'].', <br>';
					}
					if($pl['regionEncountry']!=''){
						$region .= $pl['regionEncountry'];
					}
				}
				$items = $this->DB->query("
					SELECT `item`.*,
						`unit`.title AS unitTitle,
						`order`.orderno, `order`.created,
						`product`.productno, `product`.title AS productTitle
					FROM `item`
					LEFT JOIN `order` ON (`order`.orderid=`item`.orderid)
					LEFT JOIN `unit` ON (`unit`.unitid=`item`.unitid)
					LEFT JOIN `product` ON (`product`.productid=`item`.productid)
					WHERE `item`.killed=0 AND `item`.module='packinglist' AND mid='".$pl['packinglistid']."'
					ORDER BY itemid ASC, modified ASC
				");
				if($this->DB->numRows()){
					$cartons=$grossWeight=$netWeight=$volume=0;
					$itemtr='';
					while($item = $this->DB->fetchArray($items)){
						$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'"><td>'.$item['itemid'].'</td><td title="创建时间：'.date('Y-m-d', $item['created']).'"><a href="/s.php?module=order&action=view&orderid='.$item['orderid'].'" target="_blank">'.$item['orderno'].'</a></td>
						<td><input type="hidden" name="itemid['.$i.']" value="'.$item['itemid'].'">'.$order['customerNo'].'</td>
						<td>'.$item['productno'].' <a href="/s.php?module=product&action=view&productid='.$item['productid'].'" target="_blank">'.$item['productTitle'].'</a></td>
						<td>'.$item['articleNo'].'</td>
						<td align="right">'.$item['quantity'].''.$item['unitTitle'].'</td>
						<td align="right">'.$item['perCarton'].'</td>
						<td>'.$item['cartonNo'].'</td>
						<td align="right">'.$item['cartons'].'</td>
						<td align="right">'.$item['grossWeight'].'</td>
						<td align="right">'.$item['netWeight'].'</td>
						<td align="right">'.$item['length'].'X'.$item['width'].'X'.$item['height'].'</td>
						</tr>';

						$cartons+=$item['cartons'];
						$grossWeight+=$item['grossWeight'];
						$netWeight+=$item['netWeight'];
						$volume+=$item['cartons']*$item['length']*$item['width']*$item['height'];
					}
					$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'"><td colspan="8" align="right">合计：</td><td align="right">'.number_format($cartons).'</td><td align="right">'.number_format($grossWeight, 2).'</td><td align="right">'.number_format($netWeight, 2).'</td><td align="right">'.number_format($volume/1000000, 3).'M<sup>3</sup></td></tr>';
				}
				$rtn['panel'] .= <<<EOF
<dd>
<div class="gray small"><span class="right normal"><a href="/s.php?module=invoice&action=updatePacking&packinglistid={$pl['packinglistid']}">修改</a>　<a href="/p.php?action=packinglist&packinglistid={$pl['packinglistid']}" target="_blank">打印</a></span>由 {$pl['cname']} 于 {$created} 建立{$modified}。</div>
<table class="hundred">
<thead>
<tr>
	<th colspan="4">基本信息 (Basic Information)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
	<td width="100">客户名称：<br>发票抬头：</td>
	<td><a href="/s.php?module=customer&action=view&customerid={$pl['customerid']}" target="_blank">{$pl['customerTitle']}</a><br>{$pl['title']}</td>
	<td width="70">抬头地址：</td>
	<td>{$pl['address']}</td>
</tr>
<tr class="odd">
	<td width="100">备注：</td>
	<td>{$pl['remark']}</td>
	<td width="70">国家地区：</td>
	<td>{$region}</td>
</tr>
</tbody>
</table>
<table class="hundred">
<thead>
<tr><th colspan="12">包装明细</th></tr>
</thead>
<tbody class="small">
<tr>
	<td>ID</td><td>订单号</td><td>客户订单号</td><td>产品编号/名称</td><td>客户产品编号</td><td align="right">数量</td><td align="right">每箱数量</td><td>箱编号</td><td align="right">总箱数</td><td align="right">毛重(kg)</td><td align="right">净重(kg)</td><td align="right">每箱尺寸(cm<sup>3</sup>)</td>
</tr>
{$itemtr}
</tbody>
</table>
</dd>
EOF;
			}
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 采购订单
	function relatedPOrder($r){
		$condition="`porder`.killed=0";
		if($r['materialid']>0){
			$items=$this->DB->query("SELECT DISTINCT mid FROM `item` WHERE module='porder' AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item=$this->DB->fetchArray($items)){
					$id[]=$item['mid'];
				}
				$condition.=" AND `porder`.porderid IN (".implode(',', $id).")";
			}else{
				$condition.=" AND `porder`.porderid=0";
			}
		}
		if($r['pinvoiceid']>0){
			$items=$this->DB->query("SELECT DISTINCT porderid FROM `item` WHERE module='pinvoice' AND mid='".$r['pinvoiceid']."'");
			if($this->DB->numRows()){
				while($item=$this->DB->fetchArray($items)){
					$id[]=$item['porderid'];
				}
				$condition.=" AND `porder`.porderid IN (".implode(',', $id).")";
			}else{
				$condition.=" AND `porder`.porderid=0";
			}
		}
		if($r['customerid']>0){
			$condition.=" AND `porder`.customerid='".$r['customerid']."'";
		}
		if($r['supplierid']>0){
			$condition.=" AND `porder`.supplierid='".$r['supplierid']."'";
		}
		$orders=$this->DB->query("
			SELECT `porder`.porderid,`porder`.orderno,`porder`.shipmentDate,`porder`.supplierid,`porder`.ifVerify,
					`porder`.paymentDate,`porder`.modified,`porder`.created,`porder`.killed,`porder`.purchaseType,
				`currency`.title AS currency,
				`supplier`.title AS supplier,
				m.username AS modifier, c.username AS creator
			FROM `porder`
			LEFT JOIN `pinvoicetype` AS pi ON (pi.pinvoiceTypeid=`porder`.pinvoiceTypeid)
			LEFT JOIN `supplier` ON (`supplier`.supplierid=`porder`.supplierid)
			LEFT JOIN `currency` ON (`currency`.currencyid=`porder`.currencyid)
			LEFT JOIN `user` AS m ON (m.userid=`porder`.modifier)
			LEFT JOIN `user` AS c ON (c.userid=`porder`.creator)
			WHERE ".$condition."AND `porder`.ifVerify=1
			ORDER BY `porder`.porderid ASC, `porder`.modified DESC, `porder`.created DESC
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$index=1;
			while($order=$this->DB->fetchArray($orders)){
				$created=date('Y-m-d', $order['created']);
				$itemtr='';
				$items=$this->DB->query("
					SELECT i.itemid,i.mid AS porderid,i.materialid,i.title,i.quantity,i.package,i.price,i.amount,i.discount,i.dateline,i.remark,
						m.materialno,m.title AS material,m.standard,
						u.title AS unit,
						br.title AS brand,
						p.purchaseid,p.purchaseno
					FROM `item` AS i
					LEFT JOIN `purchase` AS p ON (p.purchaseid=i.purchaseid)
					LEFT JOIN `material` AS m ON (m.materialid=i.materialid)
					LEFT JOIN `unit` AS u ON (u.unitid=i.unitid)
					LEFT JOIN `brand` AS br ON (br.brandid=i.brandid)
					WHERE i.killed=0 AND i.module='porder' AND i.mid='".$order['porderid']."'
					ORDER BY itemid ASC
				");
				if($this->DB->numRows()){
					$i=1;
					$amount=$payment=0;
					$itemtr.='<tr><td width="15">ID</td><td width="60">采购计划单号</td><td width="200">物资编号</td><td>品牌</td><td>包装方式</td><td>应到时间</td><td width="60">总数</td><td>折扣</td><td>单价</td><td width="60">已到</td><td>金额</td><td>已付</td><td></td></tr>';
					while($item=$this->DB->fetchArray($items)){
						$tracking=$this->DB->queryFirst("SELECT SUM(quantity) AS count,SUM(amount) AS payment FROM ordertracking WHERE killed=0 AND module='porder' AND itemid='".$item['itemid']."' LIMIT 0,1");
						$itemtr.='<tr class="'.$this->rotateLine(). ' small">
							<td>'.$i.'</td>
							<td><a href="/s.php?module=purchase&action=view&purchaseid='.$item['purchaseid'].'">'.$item['purchaseno'].'</a></td>
							<td title=""><a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'">'.$item['materialno'].'</a><br>
							<span class="small">名称：'.$this->iif(strlen($item['material'])>12,mb_substr($item['material'],0,12, 'UTF-8').'...',$item['material']).'</span><br><span class="small">规格：'.$this->iif(strlen($item['standard'])>12,mb_substr($item['standard'],0,12, 'UTF-8').'...',$item['standard']).'</span></td>
							<td>'.$item['brand'].'</td>
							<td>'.$item['package'].'</td>
							<td>'.date('Y-m-d',$item['dateline']).'</td>
							<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
							<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
							<td>'.number_format($item['price'],2).'</td>
							<td>'.$this->iif($tracking['count']=='',0,$tracking['count']).$item['unit'].'</td>
							<td>'.$item['amount'].'</td>
							<td>'.$this->iif($tracking['payment'],$tracking['payment'],0).'</td>
							<td><a href="/s.php?module=porderTracking&action=view&itemid='.$item['itemid'].'">查看记录</a><br><a href="/s.php?module=porderTracking&action=addQuantity&itemid='.$item['itemid'].'">新增到货记录</a><br><a href="/s.php?module=accounting&action=addPayment&porderid='.$item['porderid'].'">已付</a></td>
						</tr>';
						$quantity+=$item['quantity'];
						$amount+=$item['amount'];
						$payment+=$tracking['payment'];
						$i++;
					}
				}
				$title='';
				if($order['orderno']!='')$title.='　<span class="small">订单：</span><a href="/s.php?module=porder&action=view&porderid='.$order['porderid'].'">'.$order['orderno'].'</a>('.$this->verify($order['ifVerify']).')';
				if($order['supplier']!='')$title.='　<span class="small">供应商：</span><a href="/s.php?module='.$supplierM.'&action=view&supplierid='.$order['supplierid'].'">'.$order['supplier'].'</a>';
				if($amount!='')$title.='　<span class="small">总金额：</span>'.$amount;
				if($payment!='')$title.='　<span class="small">已付：</span>'.$payment;
				if($order['currency']!='')$title.='　<span class="small">币种：</span>'.$order['currency'];
				if($order['created']!='')$title.='　<span class="small">创建时间：</span>'.$created;
				$options=$this->iif($order['killed']==0,$this->iif($order['ifVerify']==0,'<a href="/s.php?module=porder&action=verify&porderid='.$order['porderid'].'">审核</a> ','<a href="/s.php?module=pinvoice&action=add&porderid='.$order['porderid'].'">新增发票</a> ').'<a href="/s.php?module=porder&action=update&porderid='.$order['porderid'].'">修改</a> <a href="/s.php?module=porder&action=kill&porderid='.$order['porderid'].'&rt=list" onclick="return confirm(\'你确定要删除这个应付 '.$order['orderno'].' 吗\');">删除</a>','<a href="/s.php?module=order&action=restorePayment&porderid='.$order['porderid'].'">恢复</a>');
				$rtn['panel'].=<<<EOF
<table class="hundred">
<thead>
<tr><th colspan="15"><span class="right">{$options} <span class="plus"></span></span>	<span class="normal">[<b>{$index}</b>]</span>{$title}</th></tr>
</thead>
<tbody id="order{$order['porderid']}" style="display:none">
{$itemtr}
</tbody>
</table>
EOF;
				$index++;
			}
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 采购订单明细
	function relatedPOrderItem($o){
		$order=$this->DB->queryFirst("SELECT porderid,ifVerify FROM `porder` WHERE killed=0 AND porderid='".$this->input['porderid']."'");
		$items=$this->DB->query("
			SELECT i.itemid,i.mid AS porderid,i.materialid,i.title,i.quantity,i.package,i.price,i.amount,i.discount,i.requirement,i.dateline,i.remark,
				m.materialno,m.title AS material,m.standard,
				u.title AS unit,
				br.title AS brand,
				p.purchaseid,p.purchaseno
			FROM `item` AS i
			LEFT JOIN `purchase` AS p ON (p.purchaseid=i.purchaseid)
			LEFT JOIN `material` AS m ON (m.materialid=i.materialid)
			LEFT JOIN `unit` AS u ON (u.unitid=i.unitid)
			LEFT JOIN `brand` AS br ON (br.brandid=i.brandid)
			WHERE i.killed=0 AND i.module='porder' AND i.mid='".$o['porderid']."'
			ORDER BY itemid ASC
		");
		if($this->DB->numRows()){
			$i=1;
			if($o['hasTable']=='no'){
				$r.='<table class="hundred"><thead></tr><th colspan="13">订单明细 </th></tr></thead><tbody>';
			}
			if($o['purchaseType']=='normal'){
				$r.='<table class="hundred small"><thead></tr><th colspan="13">订单明细</th></tr></thead>
				<tbody><tr class="center"><td width="15">ID</td><td width="70">采购单编号</td><td>物资编号</td><td>物资名称</td><td>规格</td><td>品牌</td><td>包装方式</td><td align="right">数量/单位</td><td>折扣</td><td>单价</td><td>金额</td><td>到货时间</td><td>备注</td></tr>';
			}elseif($o['purchaseType']=='entrust'){
				$r.='<table class="hundred small"><thead></tr><th colspan="13">订单明细</th></tr></thead><tbody><tr class="center"><td width="15">ID</td><td width="70">采购单编号</td><td>物资编号</td><td>物资名称</td><td>规格</td><td>品牌</td><td>包装方式</td><td align="right">数量/单位</td><td>折扣</td><td>单价</td><td>金额</td><td>加工要求</td><td>备注</td></tr>';
			}
			while($item=$this->DB->fetchArray($items)){
				$total+=$item['amount'];
				$r.='<tr class="'.$this->rotateLine().'">
					<td>'.$i.'</td>
					<td><a href="/s.php?module=purchase&action=view&purchaseid='.$item['purchaseid'].'">'.$item['purchaseno'].'</a></td>
					<td><a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'">'.$item['materialno'].'</a></td>
					<td>'.$item['material'].'</td>
					<td>'.$item['standard'].'</td>
					<td>'.$item['brand'].'</td>
					<td>'.$item['package'].'</td>
					<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
					<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
					<td>'.number_format($item['price'],4).'</td>
					<td>'.number_format($item['amount'],2).'</td>
					<td>'.$this->iif($o['purchaseType']=='entrust',$item['requirement'],date('Y-m-d',$item['dateline'])).'</td>
					<td>'.$item['remark'].'</td></tr>';
				$i++;
			}
			$total=number_format($total,2);
			$cntotal=$this->numberToCNAccount($total);
			$r.='<tr class="even"><td colspan="3" align="center">合　　计</td><td colspan="7">人　民　币：　 <span class="bold middle">'.$cntotal.'</span></td><td colspan="3">小写： <span class="bold middle">'.$total.'</span></td></tr>
			<tr class="odd"><td class="small gray" colspan="13">注意事项：可以点击“修改订单”，继续添加所需要购买的物资</td></tr></tbody></table>';
			if($o['purchaseType']=='entrust'){
				$items=$this->DB->query("
					SELECT i.itemid,i.mid AS porderid,i.materialid,i.title,i.quantity,i.package,i.price,i.amount,i.discount,i.requirement,i.dateline,i.remark,
						m.materialno,m.title AS material,m.standard,
						u.title AS unit
					FROM `item` AS i
					LEFT JOIN `material` AS m ON (m.materialid=i.materialid)
					LEFT JOIN `unit` AS u ON (u.unitid=i.unitid)
					WHERE i.killed=0 AND i.module='porder' AND i.mid='".$o['porderid']."'
					ORDER BY itemid ASC
				");
				if($this->DB->numRows()){
					$r.='<table class="hundred small"><thead></tr><th colspan="12">物资提供明细</th></tr></thead><tbody><tr class="center"><td width="30">ID</td><td>物资编号</td><td>物资名称</td><td>规格</td><td>包装方式</td><td align="right">数量/单位</td><td>到货时间</td><td>备注</td></tr>';
					$k=1;
					while($item=$this->DB->fetchArray($items)){
						$total+=$item['amount'];
						$r.='<tr class="'.$this->rotateLine().'">
							<td width="30">'.$k.'</td>
							<td><a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'">'.$item['materialno'].'</a></td>
							<td>'.$item['material'].'</td>
							<td>'.$item['standard'].'</td>
							<td>'.$item['package'].'</td>
							<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
							<td>'.date('Y-m-d',$item['dateline']).'</td>
							<td>'.$item['remark'].'</td></tr>';
						$k++;
					}
					$r.='	<tr class="odd"><td class="small gray" colspan="12">注意事项：可以点击“修改订单”，继续添加所需要购买的物资</td></tr></tbody></table>';
				}
			}
		}
		return $r;
	}
	// 销售订单
	function relatedOrder($r){
		$condition = "`order`.killed=0";
		if($r[''])
		if($r['type']=='PO'){
			$condition.=" AND `order`.parentid>0 AND `order`.`type`='PO'";
		}elseif($r['type']=='PI'){
			$condition.=" AND `order`.parentid=0 AND `order`.`type`='PI'";
		}
		if($r['productid']>0){
			$items = $this->DB->query("SELECT DISTINCT `orderid` FROM `item` WHERE productid='".$r['productid']."'");
			if($this->DB->numRows()){
				while($item = $this->DB->fetchArray($items)){
					$id[] = $item['orderid'];
				}
				$condition.=" AND `order`.orderid IN (".implode(',', $id).")";
			}else{
				$condition.=" AND `order`.orderid=0";
			}
		}
		if($r['customerid']>0){
			$condition.=" AND `order`.customerid='".$r['customerid']."'";
		}
		if($r['supplierid']>0){
			$condition.=" AND `order`.supplierid='".$r['supplierid']."'";
		}
		$orders = $this->DB->query("
			SELECT `order`.orderid, `order`.orderno, `order`.shipmentDate, `order`.cover, `order`.attachs, `order`.images, `order`.modified, `order`.created, `order`.killed,
				route.title AS routeTitle, route.caption AS routeCaption, `route`.typelist,
				customer.title AS customerTitle,
				m.username AS modifier, c.username AS creator
			FROM `order`
			LEFT JOIN orderroute AS route ON (route.routeid=`order`.routeid)
			LEFT JOIN `customer` ON (customer.customerid=`order`.customerid)
			LEFT JOIN `user` AS m ON (m.userid=`order`.modifier)
			LEFT JOIN `user` AS c ON (c.userid=`order`.creator)
			WHERE ".$condition."
			ORDER BY `order`.orderid ASC, `order`.modified DESC, `order`.created DESC
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$rtn['panel'] = '<ul id="mmlist" class="mmlist clear">';
			$i=1;
			while($order = $this->DB->fetchArray($orders)){
				$created = date('y-m-d H:m', $order['created']);
				$modified = date('Y-m-d H:m', $order['modified']);
				$rtn['panel'] .= '<li title="由 '.$order['creator'].' 建于 '.$created.$this->iif($order['modifier']!='', '，'.$order['modifier'].' 改于 '.$modified, '').'"'.$this->iif($i%3==0, ' class="end"', '').'>
				<div class="mmlistt">
					<span class="right normal"></span>
					<span class="small">'.$order['attr'].'</span> <a href="/s.php?module=order&action=view&orderid='.$order['orderid'].'" target="_blank">'.$order['orderno'].'</a><span class="small">('.$order['typelist'].')</span><br>'.$this->iif($order['attachs']>0, ' <span class="attachFile" title="有'.$order['attachs'].'个附件。"></span> ', '').$this->iif($order['images']>0, ' <span class="attachImage" title="有'.$order['images'].'个图片。"></span> ', '').'<span class="small gray">交货日期：</span>'.date('Y-m-d', $order['shipmentDate']).'</div>
				<div class="mmlistb">
					<div title="'.$order['routeCaption'].'"><span class="small gray">类型：</span>'.$order['routeTitle'].'</div>
					<div title="'.$order['customerTitle'].'"><span class="small gray">客户：</span><a href="/s.php?module=customer&action=view&customerid='.$customer['customerid'].'" target="_blank">'.$order['customerTitle'].'</a></div>
					'.$this->iif($order['cover']!='', '<div class="center"><img src="'.$order['cover'].'"></div>', '').'
					<div class="small clear"><span class="right" title="由 '.$order['creator'].' 建于 '.date('y-m-d H:m', $order['created']).'">'.$this->iif($order['modifier']!='', '由 '.$order['modifier'].' 改于 ', '建于 ').date('Y-m-d H:m', $order['modified']).'</span></div>
				</div>
				</li>';
				$i++;
			}
			$rtn['panel'] .= '</ul>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 订单明细
	function relatedOrderItem($o){
		$items = $this->DB->query("
			SELECT item.*,
				product.title AS product,
				brand.title AS brand,
				packing.title AS packing,
				unit.title AS unit
			FROM `item`
			LEFT JOIN `product` ON (product.productid=item.productid)
			LEFT JOIN packing ON (packing.packingid=item.packingid)
			LEFT JOIN brand ON (brand.brandid=item.brandid)
			LEFT JOIN unit ON (unit.unitid=item.unitid)
			WHERE `item`.killed=0 AND `item`.module='order' AND mid='".$o['orderid']."'
			ORDER BY itemid ASC, modified ASC
		");
		if($this->DB->numRows()){
			$k=1;
			while($item = $this->DB->fetchArray($items)){
				$selectStr = '';
				if(!empty($item['productAttributes'])){
					$nameStr = explode("#",$item['productAttributes']);
					$valueStr = explode(",",$nameStr[1]);
					array_pop($valueStr);
					$attributes=$this->DB->query("
						SELECT an.nameid,an.title AS name,
							av.valueid,av.title AS value
						FROM  attributename AS an
						LEFT JOIN attributevalue AS av ON (av.nameid=an.nameid)
						WHERE an.killed=0 AND av.killed=0 AND an.module='product' AND an.mid='".$nameStr[0]."'
						ORDER BY an.ordering ASC
					");
					$nameId=$title=$value=$attributeCount=array();
					if($this->DB->numRows()){
						while($attribute=$this->DB->fetchArray($attributes)){
							if(in_array($attribute['nameid'],$nameId)){
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]++;
							}else{
								$nameId[]=$attribute['nameid'];
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]=1;
							}
						}
					}
					foreach ($nameId as $key=>$val){
						$selectStr .= ''.$title[$val].'：';
						for($n=0;$n<count($value[$val]);$n++){
							if($valueId[$val][$n]==$valueStr[$key]){
								$selectStr .= '<span class="darkred">'.$value[$val][$n].'</span>';
							}
						}
						$selectStr .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
					}
				}else{
					$selectStr .= '此产品或配件没有属性';
				}
				
				$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
				<td>'.$k.'</td>
				<td><a href="/s.php?module=product&action=view&productid='.$item['productid'].'" target="_blank">'.$item['product'].'</a></td>
				<td>'.$selectStr.'</td>
				<td>'.$item['caption'].'</td>
				<td>'.$item['brand'].'</td>
				<td>'.$item['packing'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td></tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$total=number_format($total, 2);
return <<<EOF
		<tr><td>ID</td><td>产品或配件</td><td>产品或配件的属性</td><td>说明</td><td>品牌</td><td>包装</td><td align="right">折扣</td><td align="right">数量</td><td align="right">单价</td><td align="right">小计</td></tr>
		{$itemtr}
		<tr><td colspan="7" align="right">合计：</td><td align="right">{$quantity}</td><td></td><td align="right">{$total}</td></tr>
EOF;
		}
	}
	
	//打印订单明细
	function relatedPrintOrderItem($o){
		$items = $this->DB->query("
			SELECT item.*,
				product.entitle AS product,
				brand.title AS brand,
				packing.entitle AS packing,
				unit.entitle AS unit
			FROM `item`
			LEFT JOIN `product` ON (product.productid=item.productid)
			LEFT JOIN packing ON (packing.packingid=item.packingid)
			LEFT JOIN brand ON (brand.brandid=item.brandid)
			LEFT JOIN unit ON (unit.unitid=item.unitid)
			WHERE `item`.killed=0 AND `item`.module='order' AND mid='".$o['orderid']."'
			ORDER BY itemid ASC, modified ASC
		");
		if($this->DB->numRows()){
			$k=1;
			while($item = $this->DB->fetchArray($items)){
				$selectStr = '';
				if(!empty($item['productAttributes'])){
					$nameStr = explode("#",$item['productAttributes']);
					$valueStr = explode(",",$nameStr[1]);
					array_pop($valueStr);
					$attributes=$this->DB->query("
						SELECT an.nameid,an.entitle AS name,
							av.valueid,av.entitle AS value
						FROM  attributename AS an
						LEFT JOIN attributevalue AS av ON (av.nameid=an.nameid)
						WHERE an.killed=0 AND av.killed=0 AND an.module='product' AND an.mid='".$nameStr[0]."'
						ORDER BY an.nameid ASC
					");
					$nameId=$title=$value=$valueId=$attributeCount=array();
					if($this->DB->numRows()){
						while($attribute=$this->DB->fetchArray($attributes)){
							if(in_array($attribute['nameid'],$nameId)){
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]++;
							}else{
								$nameId[]=$attribute['nameid'];
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]=1;
							}
						}
					}
					foreach ($nameId as $key=>$val){
						$selectStr .= ''.$title[$val].'：';
						for($n=0;$n<count($value[$val]);$n++){
							if($valueId[$val][$n]==$valueStr[$key]){
								$selectStr .= '<span class="darkred">'.$value[$val][$n].'</span>';
							}
						}
						$selectStr .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
					}
				}else{
					$selectStr .= 'The products or parts has no attributes';
				}
	
				$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
				<td>'.$k.'</td>
				<td>'.$item['product'].'</td>
				<td>'.$selectStr.'</td>
				<td>'.$item['caption'].'</td>
				<td>'.$item['brand'].'</td>
				<td>'.$item['packing'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td></tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$total=number_format($total, 2);
			return <<<EOF
		<tr><td>ID</td><td>Products or Parts</td><td>Description of Products or Parts</td><td>Special Note</td><td>Brand</td><td>Packaging</td><td align="right">Discount</td><td align="right">Quantity</td><td align="right">Price</td><td align="right">Total</td></tr>
		{$itemtr}
		<tr><td colspan="7" align="right">Total：</td><td align="right">{$quantity}</td><td></td><td align="right" class="bold">{$total}</td></tr>
EOF;
		}
	}
	
	
	
	//打印订单明细
	function relatedPrintPOOrderItem($o){
		$items = $this->DB->query("
			SELECT item.*,
				product.title AS product,
				brand.title AS brand,
				packing.title AS packing,
				unit.title AS unit
			FROM `item`
			LEFT JOIN `product` ON (product.productid=item.productid)
			LEFT JOIN packing ON (packing.packingid=item.packingid)
			LEFT JOIN brand ON (brand.brandid=item.brandid)
			LEFT JOIN unit ON (unit.unitid=item.unitid)
			WHERE `item`.killed=0 AND `item`.module='order' AND mid='".$o['orderid']."'
			ORDER BY itemid ASC, modified ASC
		");
		if($this->DB->numRows()){
			$k=1;
			while($item = $this->DB->fetchArray($items)){
				$selectStr = '';
				if(!empty($item['productAttributes'])){
					$nameStr = explode("#",$item['productAttributes']);
					$valueStr = explode(",",$nameStr[1]);
					array_pop($valueStr);
					$attributes=$this->DB->query("
						SELECT an.nameid,an.title AS name,
							av.valueid,av.title AS value
						FROM  attributename AS an
						LEFT JOIN attributevalue AS av ON (av.nameid=an.nameid)
						WHERE an.killed=0 AND av.killed=0 AND an.module='product' AND an.mid='".$nameStr[0]."'
						ORDER BY an.nameid ASC
					");
					$nameId=$title=$value=$valueId=$attributeCount=array();
					if($this->DB->numRows()){
						while($attribute=$this->DB->fetchArray($attributes)){
							if(in_array($attribute['nameid'],$nameId)){
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]++;
							}else{
								$nameId[]=$attribute['nameid'];
								$title[$attribute['nameid']]=$attribute['name'];
								$value[$attribute['nameid']][]=$attribute['value'];
								$valueId[$attribute['nameid']][]=$attribute['valueid'];
								$attributeCount[$attribute['nameid']]=1;
							}
						}
					}
					foreach ($nameId as $key=>$val){
						$selectStr .= ''.$title[$val].'：';
						for($n=0;$n<count($value[$val]);$n++){
							if($valueId[$val][$n]==$valueStr[$key]){
								$selectStr .= '<span class="darkred">'.$value[$val][$n].'</span>';
							}
						}
						$selectStr .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
					}
				}else{
					$selectStr .= '<span class="small">此产品或配件没有属性</span>';
				}
	
				$itemtr .= '<tr class="odd">
				<td>'.$k.'</td>
				<td>'.$item['product'].'</td>
				<td>'.$selectStr.'</td>
				<td>'.$item['caption'].'</td>
				<td>'.$item['brand'].'</td>
				<td>'.$item['packing'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td></tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$total=number_format($total, 2);
			return <<<EOF
		<tr><td>ID</td><td>产品或配件</td><td>产品或配件的属性</td><td>说明</td><td>品牌</td><td>包装</td><td align="right">折扣</td><td align="right">数量</td><td align="right">单价</td><td align="right">小计</td></tr>
		{$itemtr}
		<tr><td colspan="7" align="right">Total：</td><td align="right">{$quantity}</td><td></td><td align="right" class="bold">{$total}</td></tr>
EOF;
		}
	}
	
	
	
	// 费用项目明细
	function relatedFee($r){
		if($r['orderid']>0){
			$condition.=" AND `item`.module='order' AND mid='".$r['orderid']."'";
		}
		if($r['porderid']>0){
			$condition.=" AND `item`.module='porder' AND mid='".$r['porderid']."'";
		}
		if($r['invoiceid']>0){
			$condition.=" AND `item`.module='invoice' AND mid='".$r['invoiceid']."'";
		}
		if($r['sampleid']>0){
			$condition.=" AND `item`.module='sample' AND mid='".$r['sampleid']."'";
		}
		$items = $this->DB->query("
			SELECT item.*,
				fee.title AS fee,
				unit.title AS unit
			FROM `feeitem` AS `item`
			LEFT JOIN `fee` ON (fee.feeid=item.feeid)
			LEFT JOIN unit ON (unit.unitid=item.unitid)
			WHERE `item`.killed=0".$condition."
			ORDER BY `item`.itemid ASC, `item`.modified ASC
		");
		if($this->DB->numRows()){
			$k=1;
			while($item = $this->DB->fetchArray($items)){
				$itemtr .= '<tr class="'.$this->iif($this->rotate(), 'odd', 'even').'">
				<td>'.$k.'</td>
				<td>'.$item['fee'].'</td>
				<td>'.$item['caption'].'</td>
				<td>'.$item['remark'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td></tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$rtn['total'] = $total;
			$total=number_format($total, 2);
$rtn['tr']= <<<EOF
		<tr><td>ID</td><td>费用项目</td><td>说明</td><td>备注</td><td align="right">折扣</td><td align="right">数量</td><td align="right">单价</td><td align="right">小计</td></tr>
		{$itemtr}
		<tr><td colspan="5" align="right">合计：</td><td align="right">{$quantity}</td><td></td><td align="right" class="bold">{$total}</td></tr>
EOF;
		}else{
			$rtn['tr']='<tr><td class="gray"><i>无费用信息</i></td></tr>';
		}
		return $rtn;
	}
	
	//打印费用项目明细
	function relatedPrintFee($r){
		if($r['orderid']>0){
			$condition.=" AND `item`.module='order' AND mid='".$r['orderid']."'";
		}
		if($r['porderid']>0){
			$condition.=" AND `item`.module='porder' AND mid='".$r['porderid']."'";
		}
		if($r['invoiceid']>0){
			$condition.=" AND `item`.module='invoice' AND mid='".$r['invoiceid']."'";
		}
		if($r['sampleid']>0){
			$condition.=" AND `item`.module='sample' AND mid='".$r['sampleid']."'";
		}
		$items = $this->DB->query("
			SELECT item.*,
				fee.entitle AS fee,
				unit.entitle AS unit
			FROM `feeitem` AS `item`
			LEFT JOIN `fee` ON (fee.feeid=item.feeid)
			LEFT JOIN unit ON (unit.unitid=item.unitid)
			WHERE `item`.killed=0".$condition."
			ORDER BY `item`.itemid ASC, `item`.modified ASC
		");
		if($this->DB->numRows()){
			$k=1;
			while($item = $this->DB->fetchArray($items)){
				$itemtr .= '<tr class="odd">
				<td>'.$k.'</td>
				<td>'.$item['fee'].'</td>
				<td>'.$item['caption'].'</td>
				<td>'.$item['remark'].'</td>
				<td align="right">'.$this->iif($item['discount']>0, $item['discount'].'%', '').'</td>
				<td align="right">'.number_format($item['quantity']).' '.$item['unit'].'</td>
				<td align="right">'.number_format($item['price'], 2).'</td>
				<td align="right">'.number_format($item['amount'], 2).'</td></tr>';
				$k++;
				$quantity+=$item['quantity'];
				$total+=$item['amount'];
			}
			$rtn['total'] = $total;
			$total=number_format($total, 2);
			$rtn['tr']= <<<EOF
<table class="hundred">
<tbody>
	<tr>
		<td colspan="12">Fee Information</td>
	</tr>
	<tr><td>ID</td><td>Fee Item</td><td>Special Note</td><td>Remark</td><td align="right">Discont</td><td align="right">Quantity</td><td align="right">Price</td><td align="right">Total</td></tr>
	{$itemtr}
	<tr><td colspan="5" align="right">Total：</td><td align="right">{$quantity}</td><td></td><td align="right" class="bold">{$total}</td></tr>
</tbody>
</table>
EOF;
		}else{
			$rtn['tr']='';
		}
		return $rtn;
	}
	
	// 与PI相关的PO/PI订单
	function relatedOtherOrder($o){
		$orders = $this->DB->query("
			SELECT `order`.*,
				route.title AS routeTitle, route.caption AS routeCaption,
				customer.title AS customerTitle, customer.address AS customerAddress, customer.linkman AS customerLinkman, customer.position AS customerPosition, customer.telephone AS customerTelephone, customer.fax AS customerFax,
				supplier.title AS supplierTitle, supplier.address AS supplierAddress, supplier.linkman AS supplierLinkman, supplier.position AS supplierPosition, supplier.telephone AS supplierTelephone, supplier.fax AS supplierFax,
				shipmethod.title AS shipmethodTitle, shipmethod.entitle AS shipmethodEntitle,
				loading.title AS loadingTitle, loading.entitle AS loadingEntitle,
				loadingCountry.country AS loadingCountryTitle, loadingCountry.encountry AS loadingCountryEntitle,
				discharge.title AS dischargeTitle, discharge.entitle AS dischargeEntitle,
				dischargeCountry.country AS dischargeCountryTitle, dischargeCountry.encountry AS dischargeCountryEntitle,
				paymentterm.title AS paymenttermTitle, paymentterm.entitle AS paymenttermEntitle,
				deliveryterm.title AS deliverytermTitle, deliveryterm.entitle AS deliverytermEntitle,
				currency.title AS currencyTitle, currency.symbol AS currencySymbol, currency.remark AS currencyRemark,
				m.username AS mname, c.username AS cname
			FROM `order`
			LEFT JOIN orderroute AS route ON (route.routeid=`order`.routeid)
			LEFT JOIN customer ON (customer.customerid=`order`.customerid)
			LEFT JOIN supplier ON (supplier.supplierid=`order`.supplierid)
			LEFT JOIN currency ON (currency.currencyid=`order`.currencyid)
			LEFT JOIN shipmethod ON (shipmethod.shipmethodid=`order`.shipmethodid)
			LEFT JOIN port AS loading ON (loading.portid=`order`.loading)
			LEFT JOIN `region` AS loadingCountry ON (loadingCountry.regionid=loading.regionid)
			LEFT JOIN port AS discharge ON (discharge.portid=`order`.discharge)
			LEFT JOIN `region` AS dischargeCountry ON (dischargeCountry.regionid=discharge.regionid)
			LEFT JOIN paymentterm ON (paymentterm.paymenttermid=`order`.paymenttermid)
			LEFT JOIN deliveryterm ON (deliveryterm.deliverytermid=`order`.deliverytermid)
			LEFT JOIN `user` AS m ON (m.userid=order.modifier)
			LEFT JOIN `user` AS c ON (c.userid=order.creator)
			WHERE `order`.killed=0 AND `order`.parentid='".$o['parentid']."'
		");
		if($this->DB->numRows()){
			while($order = $this->DB->fetchArray($orders)){
				if($order['modifier']>0){
					$modified = '，'.$order['mname'].' 于 '.date('y-m-d H:i:s', $order['modified']).' 最后修改';
				}
				$created = date('y-m-d H:i:s', $order['created']);
				$shipmentDate=date('Y-m-d', $order['shipmentDate']);
				$gray='';
				if($order['type']=='PI'){
					$itemTitle = '客户';
					$rtn['tabs'] .= '<dt>PI (销售订单)</dt>';
					$gray['supplier'] = 'gray';
				}elseif($order['type']=='PO'){
					$itemTitle = '供应商';
					$rtn['tabs'] .= '<dt>PO (采购订单)</dt>';
					$gray['customer'] = 'gray';
				}
				$item = $this->relatedOrderItem(array('orderid'=>$order['orderid'], 'title'=>$itemTitle));
$rtn['panel'] .= <<<EOF
<dd>
<div class="gray small"><span class="right normal"><a href="/s.php?module=order&action=update&orderid={$order['orderid']}">修改</a>　<a href="/p.php?action=orderPO&orderid={$order['orderid']}" target="_blank">打印{$order['type']}</a></span>由 {$order['cname']} 于 {$created} 建立{$modified}。</div>
<table class="hundred">
<thead>
<tr>
	<th colspan="4">基本信息 (Basic Information)</th>
</tr>
</thead>
<tbody>
<tr>
	<td width="573" colspan="2" class="bold {$gray['customer']}" align="center">客户 (Buyer)</td>
	<td width="573" colspan="2" class="bold {$gray['supplier']}" align="center">供应商 (Seller)</td>
</tr>
<tr class="odd">
	<td class="{$gray['customer']}" width="70">订单号：</td>
	<td class="{$gray['customer']}">{$order['customerNo']}</td>
	<td width="70" class="{$gray['supplier']}">订单号：</td>
	<td class="{$gray['supplier']}">{$order['supplierNo']}</td>
</tr>
<tr class="odd">
	<td class="{$gray['customer']}">名　称：</td>
	<td class="{$gray['customer']}">{$order['customerTitle']}</td>
	<td class="{$gray['supplier']}">名　称：</td>
	<td class="{$gray['supplier']}">{$order['supplierTitle']}</td>
</tr>
<tr class="odd">
	<td class="{$gray['customer']}">地　址：</td>
	<td class="{$gray['customer']}">{$order['customerAddress']}</td>
	<td class="{$gray['supplier']}">地　址：</td>
	<td class="{$gray['supplier']}">{$order['supplierAddress']}</td>
</tr>
<tr class="odd">
	<td class="{$gray['customer']}">联系人：</td>
	<td class="{$gray['customer']}">{$order['customerLinkman']} <span class="{$gray['supplier']}">{$order['customerPosition']}</span></td>
	<td class="{$gray['supplier']}">联系人：</td>
	<td class="{$gray['supplier']}">{$order['supplierLinkman']} <span class="{$gray['supplier']}">{$order['supplierPosition']}</span></td>
</tr>
<tr class="odd">
	<td class="{$gray['customer']}">电　话：</td>
	<td class="{$gray['customer']}">{$order['customerTelephone']}</td>
	<td class="{$gray['supplier']}">电　话：</td>
	<td class="{$gray['supplier']}">{$order['supplierTelephone']}</td>
</tr>
<tr class="odd">
	<td class="{$gray['customer']}">传　真：</td>
	<td class="{$gray['customer']}">{$order['customerFax']}</td>
	<td class="{$gray['supplier']}">传　真：</td>
	<td class="{$gray['supplier']}">{$order['supplierFax']}</td>
</tr>
</tbody>
</table>

<table class="hundred">
<thead>
<tr>
	<th colspan="4"><span class="right"><span class="normal" title="Currency">币种：</span><span class="darkred">{$order['currencyTitle']} {$order['currencySymbol']}</span> <span class="gray">{$order['currencyRemark']}</span></span>一般信息 (General Information)</th>
</tr>
</thead>
<tbody>
<tr>
	<td width="70" title="Shipment Method">运输方式：</td>
	<td width="494" class="middle">{$order['shipmethodTitle']} <span class="gray">{$order['shipmethodEntitle']}</span></td>
	<td width="70" title="Payment Term">支付条款：</td>
	<td class="middle">{$order['paymenttermTitle']} <span class="gray">{$order['paymenttermEntitle']}</span></td>
</tr>
<tr>
	<td title="Port of Loading">装货地点：</td>
	<td class="middle">{$order['loadingCountryTitle']} {$order['loadingTitle']} <span class="gray">{$order['loadingCountryTitle']} {$order['loadingTitle']}</span></td>
	<td title="Delivery Term">交货条款：</td>
	<td class="middle">{$order['deliverytermTitle']} <span class="gray">{$order['deliverytermEntitle']}</span></td>
</tr>
<tr>
	<td title="Port of Discharge">卸货地点：</td>
	<td class="middle">{$order['dischargeCountryTitle']} {$order['dischargeTitle']} <span class="gray">{$order['dischargeCountryEntitle']} {$order['dischargeEntitle']}</span></td>
	<td title="Shipment Date">交货日期：</td>
	<td class="middle"><span class="bold darkred">{$shipmentDate}</span></td>
</tr>
</tbody>
</table>

<table class="hundred">
<thead>
<tr>
	<th colspan="4">标准信息 (Critertion Information)</th>
</tr>
</thead>
<tbody>
<tr>
	<td width="70" valign="top" title="Labeling">标签说明：</td>
	<td width="494" class="middle">{$order['labeling']}</td>
	<td width="70" valign="top" title="Packing">包装说明：</td>
	<td class="middle">{$order['packing']}</td>
</tr>
<tr>
	<td valign="top" title="Special">特别说明：</td>
	<td class="middle">{$order['special']}</td>
	<td valign="top" title="Remark">备　　注：</td>
	<td class="middle">{$order['remark']}</td>
</tr>
</tbody>
</table>

<table class="hundred">
<thead>
<tr>
	<th colspan="12">订单明细 (Item Information)</th>
</tr>
</thead>
<tbody>
{$item}
</tbody>
</table>
</dd>
EOF;
			}
		}
		return $rtn;
	}
	// 
	function relatedOrderTracking($b){
		if($b['porderid']){
			$porder=$this->DB->queryFirst("SELECT ifApprove FROM porder WHERE killed=0 AND porderid='".$b['porderid']."'");
			$condition1=" AND `item`.module='porder' AND `item`.mid=".$b['porderid'];
			$condition2=" AND ot.module='porder' AND ot.mid=".$b['porderid'];
		}elseif($b['supplierid']){
			$orders=$this->DB->query("SELECT porderid FROM porder WHERE killed=0 AND supplierid='".$b['supplierid']."'");
			if($this->DB->numRows()){
				while($order=$this->DB->fetchArray($orders)){
					$id[]=$order['porderid'];
				}
			}else{
				return false;
			}
			if(is_Array($id)){
				$condition1.=" AND `item`.module='porder' AND `item`.mid IN (".implode(',',$id).")";
				$condition2.=" AND ot.module='porder' AND ot.mid IN (".implode(',',$id).")";
			}
		}else{
			return false;
		}
		$items=$this->DB->query("
			SELECT `item`.itemid,`item`.quantity AS total,`item`.amount, 
				`material`.materialno,`material`.title,`material`.standard, 
				`unit`.title AS unit
			FROM `item` 
			LEFT JOIN `material` ON (`material`.materialid=`item`.materialid) 
			LEFT JOIN `unit` ON (`unit`.unitid=`item`.unitid)
			WHERE `item`.killed=0 ".$condition1." 
			ORDER BY `item`.created ASC
		");
		if($this->DB->numRows()){
			$i=1;
			$r.='<table class="hundred"><thead><tr><th colspan=10>物资跟踪 '.$this->iif($porder['ifApprove']==1,'<span class="right"><a href="/s.php?module=porderTracking&action=add&porderid='.$b['porderid'].'">新增到货记录</a></span>','').'</th></tr></thead><tbody><tr class="even bold center"><td>ID</td><td>编号</td><td>名称</td><td>规格</td><td>应到</td><td>已到</td><td>应收</td><td>已收</td><td>操作</td></tr>';
			while($item=$this->DB->fetchArray($items)){
				$tracking=$this->DB->queryFirst("SELECT SUM(quantity) AS arrivalCount,SUM(amount) AS amount FROM ordertracking WHERE  itemid='".$item['itemid']."' LIMIT 0,1");
				$r.='<tr class="'.$this->iif($this->rotate(),'odd','even').'">
					<td width="20">'.$i.'</td>
					<td width="50"><a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'">'.$item['materialno'].'</a></td>
					<td>'.$item['title'].'</td>
					<td>'.$item['standard'].'</td>
					<td>'.number_format($item['total'],2).' '.$item['unit'].'</td>
					<td>'.number_format($tracking['arrivalCount'],2).' '.$item['unit'].'</td>
					<td>'.$item['amount'].'</td>
					<td>'.$tracking['amount'].'</td>
					<td><a href="/s.php?module=porderTracking&action=view&itemid='.$item['itemid'].'">查看记录</a>
					</tr>';
				$i++;
			}
			$r.='</tbody></table>';
		}
		$times=$this->DB->query("SELECT DISTINCT created,arrivalno,inboundid FROM `ordertracking` WHERE killed=0 ORDER BY created ASC ");
		if($this->DB->numRows()){
			while($time=$this->DB->fetchArray($times)){
				$title='';
				$orderTrackings=$this->DB->query("
					SELECT ot.trackingid,ot.mid,ot.itemid,ot.materialid, 
							ot.quantity,ot.dateline,ot.remark, 
						m.materialno,m.title,m.standard, 
						u.title AS unit,
						po.porderid,po.orderno
					FROM `ordertracking` AS ot
					LEFT JOIN `material` AS m ON (m.materialid=ot.materialid) 
					LEFT JOIN `unit` AS u ON (u.unitid=ot.unitid) 
					LEFT JOIN `porder` AS po ON (po.porderid=ot.mid)
					WHERE ot.paymentid=0 AND ot.created='".$time['created']."' ".$condition2." 
					ORDER BY ot.created ASC 
				");
				if($this->DB->numRows()){
					$i=1;
					$inbound=$this->DB->queryFirst("SELECT inboundno FROM inbound WHERE killed=0 AND inboundid='".$time['inboundid']."'");
					$created=date('Y-m-d H:i:s',$time['created']);
					if($time['arrivalno']!=''){
						$title='收货单号：'.$time['arrivalno'];
					}
					if($time['inboundid']!=0){
						$title.='入库申请单：<a href="/s.php?module=inbound&action=view&inboundid='.$time['inboundid'].'">'.$inbound['inboundno'].'</a>';
					}
					$r.='<table class="hundred"><thead><tr><th colspan=10>于'.$created.' 记录 '.$title.'<span class="right">'.$this->iif($time['inboundid']==0,'<a href="/s.php?module=pordertracking&action=insertInbound&porderid='.$b['porderid'].'&created='.$time['created'].'">添加入库申请单</a>','').$this->iif($time['inboundid']==0,'　<a href="/s.php?module=porderTracking&action=update&porderid='.$b['porderid'].'&created='.$time['created'].'">修改</a>','').'</span></th></tr></thead><tbody><tr class="even bold center"><td>ID</td><td>订单编号</td><td>编号</td><td>名称</td><td>规格</td><td>已到数量</td><td>到货时间</td></tr>';
					while($orderTracking=$this->DB->fetchArray($orderTrackings)){
						$r.='<tr class="'.$this->iif($this->rotate(),'odd','even').'">
							<td width="20">'.$i.'</td>
							<td width="50"><a href="/s.php?module=porder&action=view&porderid='.$orderTracking['porderid'].'">'.$orderTracking['orderno'].'</a></td>
							<td width="50"><a href="/s.php?module=material&action=view&materialid='.$orderTracking['materialid'].'">'.$orderTracking['materialno'].'</a></td>
							<td>'.$orderTracking['title'].'</td>
							<td>'.$orderTracking['standard'].'</td>
							<td align="right" width="80">'.number_format($orderTracking['quantity']).' '.$orderTracking['unit'].'</td>
							<td align="right" width="80">'.date('Y-m-d',$orderTracking['dateline']).'</td></tr>';
						$i++;
					}
					$r.='</tbody></table>';
				}
			}
		}

		return $r;
	}
	// 佣金
	function relatedCommission(){
		return array('off'=>' disabled', 'num'=>0);
	}
	// 保证金
	function relatedGuarantee(){
		return array('off'=>' disabled', 'num'=>0);
	}
	// 定金
	function relatedDeposit(){
		return array('off'=>' disabled', 'num'=>0);
	}
	// 应收
	function relatedCreditnote(){
		return array('off'=>' disabled', 'num'=>0);
	}
	// 已收
	function relatedRecipt(){
		return array('off'=>' disabled', 'num'=>0);
	}
	// 应付
	function relatedDebitnote($r){
		if($r['module']=='porder'){
			$t='porder';
			$tid='porderid';
			$supplierM='psupplier';
		}elseif($r['module']=='order'){
			$t='order';
			$tid='orderid';
			$supplierM='supplier';
		}
		if($r['materialid']>0){
			$id=array();
			$items=$this->DB->query("SELECT mid FROM `item` WHERE killed=0 AND module='porder' AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item=$this->DB->fetchArray($items)){
					if(!in_array($item['mid'],$id)){
						$id[]=$item['mid'];
					}
				}
			}else{
				$rtn['off']=' disabled';
				return $rtn;
			}
			if(is_Array($id)){
				$condition=' AND `debitnote`.module="'.$r['module'].'" AND `debitnote`.mid IN ('.implode(',',$id).')';
			}
		}
		if($r['mid']>0){
			$condition=' AND `debitnote`.module="'.$r['module'].'" AND `debitnote`.mid='.$r['mid'];
		}
		if($r['supplierid']>0){
			$condition=' AND `debitnote`.supplierid='.$r['supplierid'];
		}
		if($r['orderby']==''){
			$r['orderby']='`debitnote`.created';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$debitnotes=$this->DB->query("
			SELECT `debitnote`.*,
				o.".$t."id AS orderid,o.orderno,
				`supplier`.supplierid,`supplier`.title AS supplier, 
				`currency`.title AS currency
			FROM `debitnote`
			LEFT JOIN `currency` ON (currency.currencyid=debitnote.currencyid) 
			LEFT JOIN `".$t."` AS o ON (o.".$tid."=`debitnote`.mid) 
			LEFT JOIN `supplier` ON (`supplier`.supplierid=`debitnote`.supplierid)
			WHERE `debitnote`.killed=0 ".$condition."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$index=0;
			while($debitnote=$this->DB->fetchArray($debitnotes)){
				$nextDebitnote=$this->DB->queryFirst("SELECT amount FROM `debitnote` WHERE `debitnote`.killed=0 AND `debitnote`.module='".$r['module']."' AND `debitnote`.mid='".$debitnote['orderid']."' AND created>".$debitnote['created']." ORDER BY created LIMIT 0,1");
				$payment=$debitnote['amount']-$nextDebitnote['amount'];
				$index+=1;
				$options=$this->iif($debitnote['killed']==0,'<a href="/s.php?module=accounting&action=updateDebitnote&debitnoteid='.$debitnote['debitnoteid'].'">修改</a> <a href="/s.php?module=accounting&action=killDebitnote&debitnoteid='.$debitnote['debitnoteid'].'&rt=list" onclick="return confirm(\'你确定要删除这个应付 '.$debitnote['title'].' 吗,删除后无法恢复？\');">删除</a>','<a href="/s.php?module=accounting&action=restoreDebitnote&debitnoteid='.$debitnote['debitnoteid'].'">恢复</a>');
				$title='';
				if($debitnote['title']!='')$title.='　<span class="small">标题：</span>'.$debitnote['title'];
				if($debitnote['supplier']!='')$title.='　<span class="small">供应商：</span><a href="/s.php?module='.$supplierM.'&action=view&supplierid='.$debitnote['supplierid'].'">'.$debitnote['supplier'].'</a>';
				if($debitnote['amount']!='')$title.='　<span class="small">应付金额：</span>'.$debitnote['amount'];
				if($debitnote['currency']!='')$title.='　<span class="small">币种：</span>'.$debitnote['currency'];
				if($nextDebitnote['amount']>0)$title.='　<span class="small">(已付：'.$payment.')</span>';
				if($debitnote['remark']!='')$title.='　<span class="small">备注：</span>'.$debitnote['remark'];
				$rtn['panel'].=<<<EOF
<table class="hundred">
<thead>
<tr><th colspan="8"><span class="right">{$options} </span>	<span class="normal">[<b>{$index}</b>]</span> <span class="small">订单：</span><span class="middle bold"><a href="/s.php?module={$t}&action=view&{$tid}={$debitnote['orderid']}">{$debitnote['orderno']}</a></span>{$title}</th></tr>
</thead>
</table>
EOF;
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 已付
	function relatedPayment($r){
		if($r['module']=='porder'){
			$t='porder';
			$tid='porderid';
			$supplierM='psupplier';
		}elseif($r['module']=='order'){
			$t='order';
			$tid='orderid';
			$supplierM='supplier';
		}
		
		if($r['materialid']>0){
			$id=array();
			$items=$this->DB->query("SELECT mid FROM `item` WHERE killed=0 AND module='porder' AND materialid='".$r['materialid']."'");
			if($this->DB->numRows()){
				while($item=$this->DB->fetchArray($items)){
					if(!in_array($item['mid'],$id)){
						$id[]=$item['mid'];
					}
				}
			}else{
				$rtn['off']=' disabled';
				return $rtn;
			}
			if(is_Array($id)){
				$condition=' AND `payment`.module="'.$r['module'].'" AND `payment`.mid IN ('.implode(',',$id).')';
			}
		}
		if($r['mid']>0){
			$condition=' AND `payment`.module="'.$r['module'].'" AND '.$r['mid'].' IN (`payment`.mid)';
			$itemCondition=' AND `ordertracking`.mid='.$r['mid'];
		}
		if($r['supplierid']>0){
			$condition=' AND `payment`.supplierid='.$r['supplierid'];
		}
		if($r['orderby']==''){
			$r['orderby']='`payment`.created';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$payments=$this->DB->query("
			SELECT `payment`.*,
				o.".$t."id AS orderid,o.orderno,
				`supplier`.supplierid,`supplier`.title AS supplier, 
				`currency`.title AS currency
			FROM `payment`
			LEFT JOIN `currency` ON (`currency`.currencyid=`payment`.currencyid)
			LEFT JOIN `".$t."` AS o ON (o.".$tid."=`payment`.mid) 
			LEFT JOIN `supplier` ON (`supplier`.supplierid=`payment`.supplierid)
			WHERE `payment`.killed=0 ".$condition."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		if($rtn['num']=$this->DB->numRows()){
			$index=0;
			while($payment=$this->DB->fetchArray($payments)){
				$index+=1;
				$title='';
				if($payment['title']!='')$title.='　<span class="small">标题：</span>'.$payment['title'];
				if($payment['supplier']!='')$title.='　<span class="small">供应商：</span><a href="/s.php?module='.$supplierM.'&action=view&supplierid='.$payment['supplierid'].'">'.$payment['supplier'].'</a>';
				if($payment['amount']!='')$title.='　<span class="small">已付金额：</span>'.$payment['amount'];
				if($payment['currency']!='')$title.='　<span class="small">币种：</span>'.$payment['currency'];
				if($payment['dateline']!='')$title.='　<span class="small">付款时间：</span>'.date('Y-m-d',$payment['dateline']);
				if($payment['remark']!='')$title.='　<span class="small">备注：</span>'.$payment['remark'];
				$trackingid=array();
				$items=$this->DB->query("
					SELECT `ordertracking`.*,
						`material`.materialno,`material`.title,`material`.standard,
						m.".$tid." AS orderid,m.orderno,
						`unit`.title AS unit
					FROM `ordertracking`
					LEFT JOIN `material` ON (`material`.materialid=`ordertracking`.materialid)
					LEFT JOIN `unit` ON (`unit`.unitid=`ordertracking`.unitid)
					LEFT JOIN `".$t."` AS m ON (m.".$tid."=`ordertracking`.mid)
					WHERE `ordertracking`.killed=0 AND `ordertracking`.module='".$t."' AND `ordertracking`.paymentid='".$payment['paymentid']."' ".$itemCondition."
					ORDER BY `ordertracking`.mid ASC,created DESC
				");
			
				if($this->DB->numRows()){
					$i=1;
					while($item=$this->DB->fetchArray($items)){
						$total+=$item['amount'];
						$itemtr.='<tr class="'.$this->iif($this->rotate(),'even','odd').'">
						<td width="20">'.$i.'</td>
						<td width="100"><a href="/s.php?module='.$t.'&action=view&'.$tid.'='.$item['orderid'].'">'.$item['orderno'].'</a></td>
						<td width="50"><a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'">'.$item['materialno'].'</a></td>
						<td>'.$this->iif(strlen($item['title'])>12, mb_substr($item['title'], 0, 12, 'UTF-8').'...', $item['title']).'</td>
						<td>'.$this->iif(strlen($item['standard'])>12, mb_substr($item['standard'], 0, 12, 'UTF-8').'...', $item['standard']).'</td>
						<td align="right" width="80">'.number_format($item['amount'],2).'</td>
						<td align="right" width="80">'.date('Y-m-d',$item['dateline']).'</td></tr>';
						$trackingid[]=$item['trackingid'];
						$i++;
					}
				}
				if(is_array($trackingid) AND $tracking){
					$trackingId=implode(',',$trackingid);
					$olItems=$this->DB->query("
						SELECT `ordertracking`.*,
							`material`.materialno,`material`.title,`material`.standard,
							m.".$tid." AS orderid,m.orderno,
							`unit`.title AS unit
						FROM `ordertracking`
						LEFT JOIN `material` ON (`material`.materialid=`ordertracking`.materialid)
						LEFT JOIN `unit` ON (`unit`.unitid=`ordertracking`.unitid) 
						LEFT JOIN `".$t."` AS m ON (m.".$tid."=`ordertracking`.mid)
						WHERE `ordertracking`.killed=0 AND `ordertracking`.module='".$t."' AND `ordertracking`.paymentid='".$payment['paymentid']."' AND `ordertracking`.trackingid NOT IN (".$trackingId.")
						ORDER BY `ordertracking`.mid ASC,created DESC
					");
					if($counter=$this->DB->numRows()){
						$i=1;
						$itemtr.='<tr><td colspan=8>供应商 <span class="bold darkred">'.$payment['supplier'].'</span> 的其他订单下的条目明细 <span class="small gray">(共'.$counter.'个，但没有明细内容的订单不会显示)</span></td></tr>';
						while($olItem=$this->DB->fetchArray($olItems)){
							$total+=$olItem['amount'];
							$itemtr.='<tr class="'.$this->iif($this->rotate(),'even','odd').'">
							<td width="20">'.$i.'</td>
							<td width="100"><a href="/s.php?module='.$t.'&action=view&'.$tid.'='.$olItem['orderid'].'">'.$olItem['orderno'].'</a></td>
							<td width="50"><a href="/s.php?module=material&action=view&materialid='.$olItem['materialid'].'">'.$olItem['materialno'].'</a></td>
							<td>'.$this->iif(strlen($olItem['title'])>12, mb_substr($olItem['title'], 0, 12, 'UTF-8').'...', $olItem['title']).'</td>
							<td>'.$this->iif(strlen($olItem['standard'])>12, mb_substr($olItem['standard'], 0, 12, 'UTF-8').'...', $olItem['standard']).'</td>
							<td align="right" width="80">'.number_format($olItem['amount'],2).'</td>
							<td align="right" width="80">'.date('Y-m-d',$olItem['dateline']).'</td></tr>';
							$i++;
						}
					}
				}
				$options=$this->iif($debitnote['killed']==0,'<a href="/s.php?module=accounting&action=updatePayment&paymentid='.$payment['paymentid'].'&step=item">修改和新增应付明细</a> <a href="/s.php?module=accounting&action=updatePayment&paymentid='.$payment['paymentid'].'">修改</a> <a href="/s.php?module=accounting&action=killPayment&paymentid='.$payment['paymentid'].'&rt=list" onclick="return confirm(\'你确定要删除这个应付 '.$payment['title'].' 吗,删除后无法恢复？\');">删除</a>','<a href="/s.php?module=accounting&action=restorePayment&paymentid='.$payment['paymentid'].'">恢复</a>');
				$rtn['panel'].=<<<EOF
<table class="hundred">
<thead>
<tr><th colspan="8"><span class="right">{$options} <span class="plus"></span></span>	<span class="normal">[<b>{$index}</b>]</span>{$title}</th></tr>
</thead>
<tbody id="payment{$payment['paymentid']}" style="display:none">
<tr class="even bold center"><td>ID</td><td>订单编号</td><td>编号</td><td>名称</td><td>规格</td><td>已付金额</td><td>付款时间</td></tr>{$itemtr}
</tbody>
</table>
EOF;
			}
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 索赔
	function relatedClaim($r){
		if($r['module']=='porder'){
			$t='porder';
			$tid='porderid';
		}elseif($r['module']=='order'){
			$t='order';
			$tid='orderid';
		}
		if($r['mid']>0){
			$condition=' AND `claim`.module="'.$r['module'].'" AND `claim`.mid='.$r['mid'];
		}

		if($r['supplierid']>0){
			$condition=' AND `claim`.supplierid='.$r['supplierid'];
		}
		if($r['orderby']==''){
			$r['orderby']='`claim`.created';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$claims=$this->DB->query("
			SELECT `claim`.*,
				o.orderno,
				`item`.materialid,`item`.productid,
				`currency`.title AS currency,
				u.username AS creator,
				us.username AS modifier
			FROM `claim`
			LEFT JOIN `".$t."` AS o ON (o.".$tid."=`claim`.mid)
			LEFT JOIN `item` ON (`item`.itemid=`claim`.itemid)
			LEFT JOIN `currency` ON (`currency`.currencyid=`claim`.currencyid)
			LEFT JOIN `user` AS u ON (u.userid=`claim`.creator)
			LEFT JOIN `user` AS us ON (us.userid=`claim`.modifier)
			WHERE `claim`.killed=0 ".$condition."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$index=0;
			$rtn['panel']='<table class="hundred"><thead><tr><th>编号</th><th>标题</th><th>索赔物资</th><th>币种</th><th>索赔金额</th><th>原因</th><th>备注</th><th></th></tr></thead><tbody>';
			while($claim=$this->DB->fetchArray($claims)){
				if($t=='porder'){
					$result=$this->DB->queryFirst('SELECT materialid,materialno,title,standard FROM material WHERE materialid='.$claim['materialid']);
					$url='/s.php?module=material&action=view&materialid='.$result['materialid'];
					$td=$result['materialno'].' '.$result['title'].' '.$result['standard'];
				}elseif($t=='order'){
					$result=$this->DB->queryFirst('SELECT productid,productno,title FROM product WHERE materialid='.$claim['materialid']);
					$url='/s.php?module=product&action=view&productid='.$result['productid'];
					$td=$result['productno'].' '.$result['title'];
				}
				$index+=1;
				$claim['created']=date('Y-m-d H:i',$claim['created']);
				$rtn['panel'].='<tr class="'.$this->rotateLine().'">
					<td width="40">'.$index.'</td>
					<td width="250">'.$claim['title'].'</td>
					<td width="350"><a href="'.$url.'">'.$td.'</a></td>
					<td>'.$claim['currency'].'</td>
					<td>'.$claim['amount'].'</td>
					<td>'.$claim['reason'].'</td>
					<td>'.$claim['remark'].'</td>
					<td width="80"><a href="/s.php?module=service&action=killClaim&claimid='.$claim['claimid'].'&rt=list" onclick="return confirm(\'你确定要删除这个索赔单 '.$claim['title'].' 吗,删除后无法恢复？\');">删除</a>　<a href="/s.php?module=service&action=updateClaim&claimid='.$claim['claimid'].'">修改</a></td></tr>';
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 退货
	function relatedReturn($r){
		if($r['module']=='porder'){
			$t='porder';
			$tid='porderid';
		}elseif($r['module']=='order'){
			$t='order';
			$tid='orderid';
		}
		if($r['mid']>0){
			$condition=' AND `return`.module="'.$r['module'].'" AND `return`.mid='.$r['mid'];
		}

		if($r['supplierid']>0){
			$condition=' AND `return`.supplierid='.$r['supplierid'];
		}
		if($r['orderby']==''){
			$r['orderby']='`return`.created';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$returns=$this->DB->query("
			SELECT `return`.*,
				o.orderno,
				`item`.materialid,`item`.productid,
				u.username AS creator,
				us.username AS modifier
			FROM `return` 
			LEFT JOIN `".$t."` AS o ON (o.".$tid."=`return`.mid)
			LEFT JOIN `item` ON (`item`.itemid=`return`.itemid)
			LEFT JOIN `user` AS u ON (u.userid=`return`.creator)
			LEFT JOIN `user` AS us ON (us.userid=`return`.modifier)
			WHERE `return`.killed=0 ".$condition."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$index=0;
			$rtn['panel']='<table class="hundred"><thead><tr><th>编号</th><th>退货单号</th><th>退货物资</th><th>原因</th><th>备注</th><th>制单时间</th><th></th><th>制单人</th></tr></thead><tbody>';
			while($return=$this->DB->fetchArray($returns)){
				if($t=='porder'){
					$result=$this->DB->queryFirst('SELECT materialid,materialno,title,standard FROM material WHERE materialid='.$return['materialid']);
					$url='/s.php?module=material&action=view&materialid='.$result['materialid'];
					$td=$result['materialno'].' '.$result['title'].' '.$result['standard'];
				}elseif($t=='order'){
					$result=$this->DB->queryFirst('SELECT productid,productno,title FROM product WHERE materialid='.$return['materialid']);
					$url='/s.php?module=product&action=view&productid='.$result['productid'];
					$td=$result['productno'].' '.$result['title'];
				}
				$index+=1;
				$return['created']=date('Y-m-d H:i',$return['created']);
				$rtn['panel'].='<tr class="'.$this->rotateLine().'">
				<td width="40">'.$index.'</td>
				<td width="40">'.$return['returnno'].'</td>
				<td width="350"><a href="'.$url.'">'.$td.'</a></td>
				<td>'.$return['reason'].'</td>
				<td>'.$return['remark'].'</td>
				<td>'.$return['created'].'</td>
				<td>'.$return['creator'].'</td>
				<td width="80"><a href="/s.php?module=service&action=killReturn&returnid='.$return['returnid'].'&rt=list" onclick="return confirm(\'你确定要删除这个退货单 '.$return['returnno'].' 吗,删除后无法恢复？\');">删除</a>　<a href="/s.php?module=service&action=updateReturn&returnid='.$return['returnid'].'">修改</a></td></tr>';
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	// 换货
	function relatedExchange(){
		return array('off'=>' disabled', 'num'=>0);
	}
	// 评论、收藏、转发
	function relatedWebsite(){
		return array('off'=>' disabled', 'num'=>0);
	}
	// 客户服务
	function relatedService(){
		return array('off'=>' disabled', 'num'=>0);
	}
	//
	function relatedComment($g){
		if($g['condition'] == ''){
			$g['condition'] = '1=1';
		}
		if($g['commentby'] == ''){
			$g['commentby'] = 'comment.dateline';
		}
		if($g['direction'] == ''){
			$g['direction'] = 'DESC';
		}
		if($g['limit'] == ''){
			$g['limit'] = '0, 100';
		}

		$comments = $this->DB->query("
			SELECT *
			FROM `comment`
			WHERE ".$g['condition']."
			ORDER BY ".$g['commentby']." ".$g['direction']."
			LIMIT ".$g['limit']."
		");
		$rtn['num'] = $this->DB->numRows();
		if($rtn['num']){
$th = <<<EOF
<form action="/{$this->vars['index_file']}/comment&action=publish"  name="name" method="post">
<input type="hidden" name="action" value="comment">
<input type="hidden" name="do" value="publish">
<input type="hidden" name="rt" value="product">
EOF;
			$rtn['panel'] = '<table cellspacing="5" align="center"><tr><td colspan="2">发布</td><td>用户名</td><td>评论</td><td align="center" width="120">日期</td><td align="center" class="small" width="30">选项</td></tr>';
			$stamp_cache = '';
			$i = 1;
			$commentby = 'dateline';
			while($comment = $this->DB->fetchArray($comments)){
				if($commentby == 'dateline'){
					$stamp_title = $this->get_date_stamp($comment['dateline']);
					if($stamp_title != $stamp_cache){
						$rtn['panel'] .= '<tr><td colspan="6" class="timestamp">'.$stamp_title.'</td></tr>';
						$stamp_cache = $stamp_title;
					}
				}

				$publish = $this->iif($comment['publish']==1, '<font color="green">是</font>', '<font color="red">否</font>');
				$rtn['panel'] .= '<tr class="odd"><td valign="top"><input type="hidden" name="ids[]" value="'.$comment['commentid'].'" valign="top" /><input type="checkbox" name="commentid[]" value="'.$comment['commentid'].'"'.$this->iif($comment['publish'] == 1, ' checked', '').' class="nostyle" /></td><td valign="top">'.$publish.'</td><td valign="top">'.$comment['name'].'</td><td>'.html_entity_decode($comment['ctext']).'</td><td align="center" class="small" valign="top">'.date('Y-m-d H:i:s', $comment['dateline']).'</td><td align="center" class="small" valign="top"><a href="/comment&action=remove&commentid='.$comment['commentid'].'">删</a> <a href="/comment&action=update&commentid='.$comment['commentid'].'" target="_blank">改</a></td></tr>';
				$i++;
				$productid = $comment['productid'];
			}
			$rtn['panel'] .= '<tr><td colspan="6" align="center"><input type="submit" value="   保存   " accesskey="s">		<input type="reset" value="   重置   "></td></tr><input type="hidden" name="productid" value="'.$productid.'"></form></table>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off'] = ' disabled';
		}
		return $rtn;
	}
	/*
	*		sth. related with stock
	*		@param array(materialid,stockid,batchdid,orderby,direction,limit)
	*		return html-table
	*/
	function relatedStock($r){
		if($r['materialid']>0){
			$condition.=' AND `stockitem`.materialid='.$r['materialid'];
		}
		if($r['stockid']>0){
			$condition.=' AND `stockitem`.stockid='.$r['stockid'];
		}
		if($r['batchdid']>0){
			$condition.=' AND `stockitem`.batchdid='.$r['batchdid'];
		}
		if($r['orderby']==''){
			$r['orderby']='`stockitem`.modified';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$stocks=$this->DB->query("
			SELECT stockitem.stockitemid,stockitem.quantity,
				material.materialid,material.title,material.materialno,material.standard,
				stock.stockid,stock.stockno,
				batch.batchno,
				barcode.barcode
			FROM `stockitem`
			LEFT JOIN `material` ON (material.materialid=stockitem.materialid)
			LEFT JOIN `stock` ON (stock.stockid=stockitem.stockid)
			LEFT JOIN `batch` ON (batch.batchid=stockitem.batchid)
			LEFT JOIN `barcode` ON (barcode.barcodeid=stockitem.barcodeid)
			WHERE stockitem.quantity<>0 AND stockitem.killed=0 ".$condition."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$i=1;
			$rtn['panel']='<table class="hundred"><thead><tr><th>编号</th><th>库位号</th><th>物资</th><th>批次号</th><th>条码</th><th>当前数量</th></tr></thead><tbody>';
			while($stock=$this->DB->fetchArray($stocks)){
				$rtn['panel'].='<tr class="'.$this->iif($this->rotate(),'odd','even').'">
					<td>'.$i.'</td>
					<td><a href="/s.php?module=stock&action=view&stockid='.$stock['stockid'].'">'.$stock['stockno'].'</a></td>
					<td>'.$stock['materialno'].'　<a href="/s.php?module=material&materialid='.$stock['materilaid'].'">'.$stock['title'].'　'.$stock['standard'].'</a></td>
					<td><a href="/s.php?module=batch&action=view&batchid='.$stock['batchid'].'">'.$stock['batchno'].'</a></td>
					<td><a href="/s.php?module=barcode&action=view&barcodeid='.$stock['barcodeid'].'">'.$stock['barcode'].'</a></td>
					<td>'.$stock['quantity'].'</td></tr>';
				$i++;
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	/*
	*		sth. related with barcode
	*		@param array(materialid,batchid,supplierid,orderby,direction,limit)
	*		return html-table
	*/
	function relatedBarcode($r){
		if($r['materialid']>0){
			$condition.=' AND `barcode`.materialid='.$r['materialid'];
		}
		if($r['batchid']>0){
			$condition.=' AND `batch`.batchid='.$r['batchid'];
		}
		if($r['supplierid']>0){
			$r['condition'].=" AND `barcode`.supplierid='".$r['supplierid']."'";
		}
		if($r['orderby']==''){
			$r['orderby']='`barcode`.created';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$barcodes=$this->DB->query("
			SELECT `barcode`.*,
				`supplier`.supplierno,`supplier`.supplierid,`supplier`.title AS supplier,
				`batch`.quantity AS cQuantity,`batch`.qualified,`batch`.disqualified,
				`material`.materialno,`material`.materialid,`material`.title AS material,`material`.standard
			FROM `barcode`
			LEFT JOIN `supplier` ON (supplier.supplierid=`barcode`.supplierid)
			LEFT JOIN `batch` ON (`batch`.batchid=`barcode`.batchid)
			LEFT JOIN `material` ON (material.materialid=`barcode`.materialid)
			WHERE `barcode`.parentid=0 ".$condition."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$rtn['panel']='<table class="hundred"><thead><tr><th>序号</th><th>批次条码</th><th>物资名称及规格</th><th>供应商</th><th>收货数量</th><th>当前数量</th><th>良品数</th><th>不良品数</th><th>收货时间</th></tr></thead><tbody>';
			$i=1;
			while($barcode=$this->DB->fetchArray($barcodes)){
				$barcode['arrivalTime']=date('Y-m-d',$barcode['arrivalTime']);
				$rtn['panel'].='<tr class='.$this->iif($this->rotate(),'odd','even').'><td>'.$i.'</td><td><a href="/s.php?module=barcode&action=view&barcodeid='.$barcode['barcodeid'].'">'.$barcode['barcode'].'</td><td>'.$barcode['materialno'].'　 <a href="/s.php?module=material&action=view&materialid='.$barcode['materialid'].'">'.$barcode['material'].' '.$barcode['standard'].'</td><td><a href="/s.php?module=supplier&action=view&supplierid='.$barcode['supplierid'].'">'.$barcode['supplier'].'</a></td><td>'.$barcode['quantity'].'</td><td>'.$barcode['disqualified'].'</td><td>'.$barcode['qualified'].'</td><td>'.$barcode['disqualified'].'</td><td>'.$barcode['arrivalTime'].'</td></tr>';
				$i++;
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	/*
	*		sth. related with batch
	*		@param array(materialid,barcodeid,supplierid,orderby,direction,limit)
	*		return html-table
	*/
	function relatedBatch($r){
		if($r['materialid']>0){
			$condition.=' AND `batch`.materialid='.$r['materialid'];
		}
		if($r['barcodeid']>0){
			$condition.=' AND `batch`.barcodeid='.$r['barcodeid'];
		}
		if($r['supplierid']>0){
			$r['condition'].=" AND `batch`.supplierid='".$r['supplierid']."'";
		}
		if($r['orderby']==''){
			$r['orderby']='`batch`.created';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$batchs=$this->DB->query("
			SELECT `batch`.*,
				`material`.materialno,`material`.materialid,`material`.title AS material,`material`.standard
			FROM `batch`
			LEFT JOIN `material` ON (material.materialid=batch.materialid)
			WHERE `batch`.killed=0 ".$condition."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		if($rtn['num']=$this->DB->numRows()){
			$index=1;
			$rtn['panel']='<table class="hundred"><thead><tr><th width="30">ID</th><th>批次</th><th>条码</th><th>物资名称及规格</th><th>数量</th><th>良品数</th><th>不良品数</th><th>收货时间</th><th width="100"></th></tr></thead><tbody>';
			while($batch=$this->DB->fetchArray($batchs)){
				$batch['arrivalTime']=date('Y-m-d',$batch['arrivalTime']);
				if($batch['quantity']==0){
					$operate='<a href="/s.php?module=batch&action-=remove&batchid='.$batch['batchid'].'"></a>';
				}
				$barcode=$this->DB->queryFirst("SELECT barcodeid,barcode FROM barcode WHERE scraped=0 AND parentid=0 AND batchid='".$batch['batchid']."'");
				$rtn['panel'].='<tr class="'.$this->rotateLine().'">
				<td>'.$index.'</td>
				<td><a href="/s.php?module=batch&action=view&batchid='.$batch['batchid'].'">'.$batch['batchno'].'</a></td>
				<td><a href="/s.php?module=barcode&action=view&barcodeid='.$barcode['barcodeid'].'">'.$barcode['barcode'].'</a></td>
				<td>'.$batch['materialno'].'　 <a href="/s.php?module=material&action=view&materialid='.$batch['materialid'].'">'.$batch['material'].' '.$batch['standard'].'</a></td>
				<td>'.$batch['quantity'].'</td>
				<td>'.$batch['qualified'].'</td>
				<td>'.$batch['disqualified'].'</td>
				<td>'.$batch['arrivalTime'].'</td>
				<td><a href="/s.php?module=batch&action=kill&batchid='.$batch['batchid'].'">删除</a></td></tr>';
				$index++;
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	/*
	*		sth. related with inbound
	*		@param array(materialid,orderby,direction,limit)
	*		return html-table
	*/
	function relatedInbound($r){
		if($r['materialid']>0){
			$condition.=' AND ib.materialid='.$r['materialid'];
		}
		if($r['orderby']==''){
			$r['orderby']='ib.created';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$inbounds=$this->DB->query("
			SELECT ib.quantity,ib.dateTime,
				i.inboundno,i.inboundid,
				bt.batchid,bt.batchno,
				br.barcodeid,br.barcode,
				s.stockid,s.stockno
			FROM inbounditem AS ib
			LEFT JOIN inbound AS i ON (i.inboundid=ib.inboundid)
			LEFT JOIN batch AS bt ON (bt.batchid=ib.batchid)
			LEFT JOIN barcode AS br ON (br.barcodeid=ib.barcodeid)
			LEFT JOIN stock AS s ON (s.stockid=ib.stockid)
			WHERE ib.killed=0 ".$condition."
			ORDER BY ib.dateTime DESC
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$rtn['panel']='<table class="hundred"><thead><tr><th>入库单号</th><th>批次号</th><th>条码号</th><th>库位号</th><th>入库数量</th><th>入库时间</th></tr></thead><tbody>';
			while($inbound=$this->DB->fetchArray($inbounds)){
				$inbound['dateTime']=date('Y-m-d H:i',$inbound['dateTime']);
				$rtn['panel'].='<tr class="'.$this->rotateLine().'">
					<td><a href="/s.php?module=inbound&action=view&inboundid='.$inbound['inboundid'].'">'.$inbound['inboundno'].'</a></td>
					<td><a href="/s.php?module=batch&action=view&batchid='.$inbound['batchid'].'">'.$inbound['batchno'].'</a></td>
					<td><a href="/s.php?module=barcode&action=view&inboundid='.$inbound['inboundid'].'">'.$inbound['barcode'].'</a></td>
					<td><a href="/s.php?module=stock&action=view&stockid='.$inbound['stockid'].'">'.$inbound['stockno'].'</a></td>
					<td>'.$inbound['quantity'].'</td><td>'.$inbound['dateTime'].'</td></tr>';
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	/*
	*		sth. related with outbound
	*		@param array(materialid,orderby,direction,limit)
	*		return html-table
	*/
	function relatedOutbound($r){
		if($r['materialid']>0){
			$condition.=' AND ob.materialid='.$r['materialid'];
		}
		if($r['orderby']==''){
			$r['orderby']='ob.created';
		}
		if($r['direction']==''){
			$r['direction']='DESC';
		}
		if($r['limit']==''){
			$r['limit']='0, 100';
		}
		$outbounds=$this->DB->query("
			SELECT ob.*,
				o.outboundno,o.outboundid,
				bt.batchid,bt.batchno,
				br.barcodeid,br.barcode
			FROM `outbounditem` AS ob
			LEFT JOIN `outbound` AS o ON (o.outboundid=ob.outboundid)
			LEFT JOIN `batch` AS bt ON (bt.batchid=ob.batchid)
			LEFT JOIN `barcode` AS br ON (br.barcodeid=ob.barcodeid)
			WHERE ob.killed=0 ".$condition."
			ORDER BY ".$r['orderby']." ".$r['direction']."
			LIMIT ".$r['limit']."
		");
		$rtn['num']=$this->DB->numRows();
		if($rtn['num']){
			$rtn['panel']='<table class="hundred"><thead><tr><th width="70">出库单号</th><th width="100">批次号</th><th width="250">条码号</th><th>库位号</th><th width="70">申请数量</th><th width="70">出库数量</th><th width="70">出库时间</th></tr></thead><tbody>';
			while($outbound=$this->DB->fetchArray($outbounds)){
				$outbound['dateTime']=date('Y-m-d H:m',$outbound['dateTime']);
				$outbound['actualTime']=date('Y-m-d',$outbound['actualTime']);
				$stocks=unserialize($outbound['stocks']);
				foreach($stocks as $key=>$val){
					$stock=$this->DB->queryFirst("SELECT stockid,stockno FROM stock WHERE stockid='".$val['stockid']."'");
					$stockLine.='<a href="/s.php?module=stock&action=view&stockid='.$stock['stockid'].'">'.$stock['stockno'].'</a> : '.$val['quantity'].'； ';
				}
				$rtn['panel'].='<tr class='.$this->iif($this->rotate,'odd','even').'>
					<td><a href="/s.php?module=outbound&action=view&outboundid='.$outbound['outboundid'].'">'.$outbound['outboundno'].'</a></td>
					<td><a href="/s.php?module=batch&action=view&batchid='.$outbound['batchid'].'">'.$outbound['batchno'].'</a></td>
					<td><a href="/s.php?module=barcode&action=view&outboundid='.$outbound['outboundid'].'">'.$outbound['barcode'].'</a></td>
					<td><a href="/s.php?module=stock&action=view&stockid='.$outbound['stockid'].'">'.$stockLine.'</a></td>
					<td>'.$outbound['applyQuantity'].'</td><td>'.$outbound['outQuantity'].'</td><td>'.$outbound['actualTime'].'</td></tr>';
			}
			$rtn['panel'].='</tbody></table>';
			$rtn['count']=' ('.$rtn['num'].')';
		}else{
			$rtn['off']=' disabled';
		}
		return $rtn;
	}
	//
	function relatedFavorite($g){
		if($g['condition'] == ''){
			$g['condition'] = '1=1';
		}
		if($g['favoriteby'] == ''){
			$g['favoriteby'] = 'favorite.dateline';
		}
		if($g['direction'] == ''){
			$g['direction'] = 'DESC';
		}
		if($g['limit'] == ''){
			$g['limit'] = '0, 100';
		}
		$favorites = $this->DB->query("
			SELECT favorite.*,
				user.username
			FROM favorite
			LEFT JOIN user ON (user.userid = favorite.userid)
			WHERE ".$g['condition']."
			ORDER BY ".$g['favoriteby']." ".$g['direction']."
			LIMIT ".$g['limit']."
		");
		$rtn['num'] = $this->DB->numRows();
		if($rtn['num']){
			$rtn['panel'] = '<table cellspacing="5" align="center" width="100%"><tr class="solid bold"><td>ID</td><td>用户</td><td align="right">收藏时间</td><td align="right">选项</td></tr>';
			$favoriteby = 'dateline';
			$stamp_cache = '';
			while($favorite = $this->DB->fetchArray($favorites)){
				if($favoriteby == 'dateline'){
					$stamp_title = $this->get_date_stamp($favorite['dateline']);
					if($stamp_title != $stamp_cache){
						$rtn['panel'] .= '<tr><td colspan="4" class="timestamp">'.$stamp_title.'</td></tr>';
						$stamp_cache = $stamp_title;
					}
				}
				if($favoriteby == 'total'){
					$stamp_title = $this->get_total_stamp($favorite['total']);
					if($stamp_title != $stamp_cache){
						$rtn['panel'] .= '<tr><td colspan="4" class="timestamp">'.$stamp_title.'</td></tr>';
						$stamp_cache = $stamp_title;
					}
				}

				$rtn['panel'] .= '<tr class="product" onmouseover="this.style.backgroundColor=\'white\'" onmouseout="this.style.backgroundColor=\'\'"><td>'.$favorite['favoriteid'].'</td><td class="bold"><a href="/member&action=view&userid='.$favorite['userid'].'" target="_blank">'.$favorite['username'].'</a></td><td align="right">'.date('Y-m-d H:i:s', $favorite['dateline']).'</td><td align="right"><i>无</i></td></tr>';
			}
			$rtn['panel'] .= '</table>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off'] = ' disabled';
		}
		return $rtn;
	}

	//
	function relatedForward($g){
		if($g['condition'] == ''){
			$g['condition'] = '';
		}
		if($g['forwardby'] == ''){
			$g['forwardby'] = 'forward.dateline';
		}
		if($g['direction'] == ''){
			$g['direction'] = 'DESC';
		}
		if($g['limit'] == ''){
			$g['limit'] = '0, 100';
		}
		$forwards = $this->DB->query("
			SELECT forward.*,
				user.username
			FROM forward
			LEFT JOIN user ON (user.userid = forward.userid)
			WHERE hidden=0 AND ".$g['condition']."
			ORDER BY ".$g['forwardby']." ".$g['direction']."
			LIMIT ".$g['limit']."
		");
		$rtn['num'] = $this->DB->numRows();
		if($rtn['num']){
			$rtn['panel'] = '<table cellspacing="5" align="center" width="100%"><tr><td>ID</td><td>来自</td><td>收件人</td><td>主题</td><td align="right">转发时间</td><td align="right">选项</td></tr>';
			$forwardby = 'dateline';
			$stamp_cache = '';
			while($forward = $this->DB->fetchArray($forwards)){
				if($forwardby == 'dateline'){
					$stamp_title = $this->get_date_stamp($forward['dateline']);
					if($stamp_title != $stamp_cache){
						$rtn['panel'] .= '<tr><td colspan="6" class="timestamp">'.$stamp_title.'</td></tr>';
						$stamp_cache = $stamp_title;
					}
				}
				if($forwardby == 'total'){
					$stamp_title = $this->get_total_stamp($forward['total']);
					if($stamp_title != $stamp_cache){
						$rtn['panel'] .= '<tr><td colspan="6" class="timestamp">'.$stamp_title.'</td></tr>';
						$stamp_cache = $stamp_title;
					}
				}

				$rtn['panel'] .= '<tr class="odd"><td>'.$forward['forwardid'].'</td><td><a href="mailto: '.$forward['from_email'].'" target="_blank">'.$forward['from_name'].'</a></td><td><a href="mailto: '.$forward['to_email'].'">'.$forward['to_name'].'</a></td><td>'.$forward['subject'].'</td><td align="right">'.date('Y-m-d H:i', $forward['dateline']).'</td><td align="right"><i>无</i></td></tr>';
			}
			$rtn['panel'] .= '</table>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off'] = ' disabled';
		}
		return $rtn;
	}
	// 
function relatedMaterial($id){
		if($id<0){
			return false;
		}
		$material=$this->DB->queryFirst("
			SELECT m.*,
				c.parentlist,c.title AS category,
				un.title AS unit,
				b.title AS brand,
				p.title AS packing,
				mo.title AS origin,
				u.username AS creator,
				u.username AS modifier
			FROM material AS m
			LEFT JOIN category AS c ON (c.categoryid=m.categoryid)
			LEFT JOIN unit AS un ON (un.unitid=m.unitid)
			LEFT JOIN brand AS b ON (b.brandid=m.brandid)
			LEFT JOIN packing AS p ON (p.packingid=m.packingid)
			LEFT JOIN materialorigin AS mo ON (mo.originid=m.originid)
			LEFT JOIN user AS u ON (u.userid=m.creator)
			LEFT JOIN user AS us ON (us.userid=m.modifier)
			WHERE materialid='".$id."'
			LIMIT 0,1
		");
		if($material){
			$categoryid=explode(',',$material['parentlist']);
      foreach($categoryid as $key=>$value){//获得物资分类
        if($key!=0){
          $category=$this->DB->queryFirst("SELECT title FROM category WHERE categoryid=19 AND categoryid='".$value."' LIMIT 0,1");
          if($category['title'])
            $material['category']=$category['title'].' '.$material['category'];
        }
      }
      if($material['ifPerBarcode']==1){
        $material['perBarcode']='是';
      }elseif($material['ifPerBarcode']==0){
        $material['perBarcode']='否';
      }
			if($material['inventoryType']=='choose'){
				$invetoryType='抽盘';
			}elseif($material['inventoryType']=='must'){
				$invetoryType='必盘';
			}
			$r.=<<<EOF
<table class="hundred">
<thead><tr><th colspan="4">物资信息</th></tr></thead>
<tbody>
<tr class="odd">
<td width="100">物资编号：</td><td width="450">{$material['materialno']}</td>
<td width="100">物资名称：</td><td width="450">{$material['title']}</td>
</tr>
<tr class="odd">
<td width="100">物资规格：</td><td width="450">{$material['standard']}</td>
<td width="100">物资分类：</td><td width="450">{$material['category']}</td>
</tr>
<tr class="even">
<td>品　　牌：</td><td>{$material['brand']}</td>
<td>物资单位：</td><td>{$material['unit']}</td>
</tr>
<tr class="odd">
<td>物资来源：</td><td>{$material['origin']}</td>
<td>盘点类型：</td><td>{$invetoryType}</td>
</tr>
<tr class="even">
<td>包　　装：</td><td>{$material['packing']}</td>
<td>总　　数：</td><td>{$material['quantity']}</td>
</tr>
<tr class="odd">
<td>良品数量：</td><td>{$material['qualified']}</td>
<td>不良品数量：</td><td>{$material['disqualified']}</td>
</tr>
<tr class="even">
<td>最大峰值：</td><td>{$material['max']}</td>
<td>最小报警值：</td><td>{$material['min']}</td>
</tr>
<tr class="odd">
<td>临界报警值：</td><td>{$material['criticalNumber']}</td>
<td>允 差 值：</td><td>{$tolerance}</td>
</tr>
<tr class="even">
<td>是否为该物资分配流水号条码：</td><td>{$material['perBarcode']}</td>
<td>备　　注：</td><td>{$material['remark']}</td>
</tr>
</tbody>
</table>
EOF;
		}
		return $r;
	}
	// 
	function relatedSupplierMaterial($b){
		if($b['materialid']!=''){
			$condition=' AND sm.materialid='.$b['materialid'];
		}
		if($b['supplierid']!=''){
			$condition=' AND sm.supplierid='.$b['supplierid'];
		}
		$materials=$this->DB->query("
			SELECT sm.*,
				m.materialno,m.title AS materialTitle,m.standard AS materialStandard,
				s.supplierid,s.title AS supplier,
				b.title AS brand,
				u.title AS unit
			FROM `suppliermaterial` AS sm
			LEFT JOIN `material` AS m ON (m.materialid=sm.materialid)
			LEFT JOIN `supplier` AS s ON (s.supplierid=sm.supplierid)
			LEFT JOIN `brand` AS b ON (b.brandid=sm.brandid)
			LEFT JOIN `unit` AS u ON (u.unitid=sm.unitid)
			WHERE sm.killed=0 ".$condition."
			ORDER BY suppliermaterialid ASC
		");
		if($this->DB->numRows()){
			$i=1;
			$r='<table class="hundred"><thead>
<tr><th width="15">ID</th><th>物资</th><th>名称</th><th>规格</th>'.$this->iif($b['supplierid']!='','','<th>供应商</th>').'<th>品牌</th><th>单位</th><th>单价</th><th>备注</th></tr></thead><tbody>';
			while($material=$this->DB->fetchArray($materials)){
				$r.='<tr class="'.$this->rotateLine().' small">
					<td>'.$i.'</td>
					<td><a href="/s.php?module=material&action=view&materialid='.$material['materialid'].'">'.$material['materialno'].'</a></td>
					<td>'.$material['materialTitle'].'</td>
					<td>'.$material['materialStandard'].'</td>
					'.$this->iif($b['supplierid']!='','','<td><a href="/s.php?module=psupplier&action=view&supplierid='.$material['supplierid'].'">'.$material['supplier'].'</a></td>').'
					<td>'.$material['brand'].'</td>
					<td>'.$material['unit'].'</td>
					<td>'.$material['price'].'</td>
					<td>'.$material['remark'].'</td>
					</tr>';
				$i++;
			}
			$r.='</tbody></table>';
		}
		return $r;
	}
	
	function releatedWorkcenterItem($r){
		if($b['materialid']!=''){
			$condition=' AND wci.materialid='.$b['materialid'];
		}
		if($b['workcenterid']!=''){
			$condition=' AND wci.workcenterid='.$b['workcenterid'];
		}
		$items=$this->DB->query("
			SELECT wci.*,
				m.*,
				wc.*
			FROM `workcenteritem` AS wci
			LEFT JOIN `material` AS m ON (m.materialid=wci.materialid)
			LEFT JOIN `workcenter` AS wc ON (wc.workcenterid=wci.workcenterid)
			WHERE wci.killed=0 ".$condition."
			ORDER BY itemid ASC
		");
		if($rtn['num']=$this->DB->numRows()){
			$i=1;
			$rtn['panel']='<table class="hundred"><thead><tr><th width="15">ID</th><th>工作中心</th><th>物资</th><th>备注</th><th>操作</th></tr></thead><tbody>';
			while($item=$this->DB->fetchArray($items)){
				$rtn['panel'].='<tr class="'.$this->rotateLine().' small">
					<td>'.$i.'</td>
					<td><a href="/s.php?module=material&action=view&materialid='.$item['materialid'].'">'.$item['materialno'].'</a>　'.$item['material'].'　'.$item['materialStandard'].'</a></td>
					<td><a href="/s.php?module=workcenter&action=view&workcenterid='.$item['workcenterid'].'">'.$item['workcenter'].'</a></td>
					<td>'.$material['remark'].'</td><td><a href="/s.php?module=workcenter&action=removeMaterial&workcenterid='.$item['workcenterid'].'" onclick="return confirm(\'你确定要删除这条物资吗？(删除不可恢复！)\')">删除</a></td>
					</tr>';
				$i++;
			}
			$rtn['panel'] .= '</tbody></table>';
			$rtn['count'] = ' ('.$rtn['num'].')';
		}else{
			$rtn['off'] = ' disabled';
		}
		return $rtn;
	}
	
}
?>
